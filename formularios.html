<!doctype html>
<html lang="en" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
  <head>
    <title>Generación de Formularios | Montero y Negocio</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="description"
      content="Sistema de gestión de formularios de Montero y Negocio"
    />
    <meta name="author" content="Montero y Negocio" />

    <link rel="icon" href="../assets/images/favicon.svg" type="image/x-icon" />

     <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/fonts/phosphor/duotone/style.css" />
    <link rel="stylesheet" href="../assets/fonts/tabler-icons.min.css" />
    <link rel="stylesheet" href="../assets/fonts/feather.css" />
    <link rel="stylesheet" href="../assets/fonts/fontawesome.css" />
    <link rel="stylesheet" href="../assets/fonts/material.css" />
    <link rel="stylesheet" href="../assets/css/style.css" id="main-style-link" />
    

    <style>
        .page-title {
            color: #3f51b5;
            font-weight: 600;
        }
        .form-section-title {
            font-size: 1.1em;
            color: #555;
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        .btn-primary {
            background-color: #3f51b5;
            border-color: #3f51b5;
        }
        .btn-primary:hover {
            background-color: #303f9f;
            border-color: #303f9f;
        }
        .nav-link.active {
            background-color: #3f51b5 !important;
            color: white !important;
        }
        /* Estilo para mensajes de feedback */
        #feedbackMessageFormularios {
            margin-top: 15px;
            font-size: 0.9em;
        }

        select:disabled {
            background-color: #e9ecef;
            opacity: 1;
            cursor: not-allowed;
        }
        input[readonly] {
            background-color: #e9ecef;
            opacity: 1;
        }
         /* Mejoras visuales */
        .loading-placeholder td {
            color: #999;
            font-style: italic;
        }
        .error-placeholder td {
             color: #dc3545; /* Rojo Bootstrap */
             font-weight: bold;
        }
    </style>
  </head>
  <body>
    <div class="loader-bg fixed inset-0 bg-white dark:bg-themedark-cardbg z-[1034]">
        <div class="loader-track h-[5px] w-full inline-block absolute overflow-hidden top-0">
            <div class="loader-fill w-[300px] h-[5px] bg-primary-500 absolute top-0 left-0 animate-[hitZak_0.6s_ease-in-out_infinite_alternate]"></div>
        </div>
    </div>
    <nav class="pc-sidebar">
      <div class="navbar-wrapper">
        <div class="m-header flex items-center py-4 px-6 h-header-height">
          <a href="index.html" class="b-brand flex items-center gap-3">
            <img src="../assets/images/logo-white.svg" class="img-fluid logo logo-lg" alt="logo" />
            <img src="../assets/images/favicon.svg" class="img-fluid logo logo-sm" alt="logo" />
          </a>
        </div>
        <div class="navbar-content h-[calc(100vh_-_80px)] py-2.5 overflow-y-auto">
          <ul class="pc-navbar">
            <li class="pc-item pc-caption">
              <label>NAVIGATION</label>
            </li>
            <li class="pc-item">
              <a href="index.html" class="pc-link"> <span class="pc-micon">
                  <i data-feather="home"></i>
                </span>
                <span class="pc-mtext">DASHBOARD</span>
              </a>
            </li>

            <li class="pc-item pc-caption">
              <label>ADMINISTRACIÓN Y FINANZAS</label>
              <i data-feather="settings"></i>
            </li>
            <li class="pc-item pc-hasmenu">
                <a href="#!" class="pc-link">
                    <span class="pc-micon"><i data-feather="database"></i></span>
                    <span class="pc-mtext">BASE DE DATOS</span>
                    <span class="pc-arrow"><i class="ti ti-chevron-right"></i></span>
                </a>
                <ul class="pc-submenu">
                    <li class="pc-item">
                        <a class="pc-link" href="base-datos-usuarios.html">USUARIOS</a>
                    </li>
                    <li class="pc-item">
                        <a class="pc-link" href="ingresar_empresa.html">EMPRESAS</a>
                    </li>
                </ul>
            </li>
            <li class="pc-item pc-hasmenu">
                <a href="#!" class="pc-link">
                    <span class="pc-micon"><i data-feather="book-open"></i></span>
                    <span class="pc-mtext">CONTABILIDAD</span>
                    <span class="pc-arrow"><i class="ti ti-chevron-right"></i></span>
                </a>
                <ul class="pc-submenu">
                    <li class="pc-item">
                        <a class="pc-link" href="pagos.html">PAGOS</a>
                    </li>
                    <li class="pc-item">
                        <a class="pc-link" href="tabla.html">TABLA</a>
                    </li>
                    <li class="pc-item">
                        <a class="pc-link" href="pago-planillas.html">PAGO DE PLANILLAS</a>
                    </li>
                    <li class="pc-item">
                        <a class="pc-link" href="enviar-planillas.html">ENVIAR PLANILLAS</a>
                    </li>
                </ul>
            </li>

            <li class="pc-item pc-caption">
              <label>GESTIÓN OPERATIVA</label>
              <i data-feather="bar-chart-2"></i>
            </li>
            <li class="pc-item">
                <a href="novedades.html" class="pc-link"><span class="pc-micon"><i data-feather="bell"></i></span><span class="pc-mtext">NOVEDADES</span></a>
            </li>
            <li class="pc-item active">
                <a href="formularios.html" class="pc-link is-active"> <span class="pc-micon"> <i data-feather="align-justify"></i></span>
                <span class="pc-mtext">FORMULARIOS</span>
              </a>
            </li>
            <li class="pc-item pc-hasmenu">
                <a href="#!" class="pc-link">
                    <span class="pc-micon"><i data-feather="gavel"></i></span>
                    <span class="pc-mtext">GESTIÓN JURÍDICA</span>
                    <span class="pc-arrow"><i class="ti ti-chevron-right"></i></span>
                </a>
                <ul class="pc-submenu">
                    <li class="pc-item">
                        <a class="pc-link" href="incapacidades.html">INCAPACIDADES</a>
                    </li>
                    <li class="pc-item">
                        <a class="pc-link" href="tutelas.html">TUTELAS</a>
                    </li>
                    <li class="pc-item">
                        <a class="pc-link" href="depuraciones.html">DEPURACIONES</a>
                    </li>
                </ul>
            </li>

            <li class="pc-item pc-caption">
              <label>DOCUMENTACIÓN Y SERVICIO</label>
              <i data-feather="file-text"></i>
            </li>
            <li class="pc-item pc-hasmenu">
                <a href="#!" class="pc-link">
                    <span class="pc-micon"><i data-feather="file-text"></i></span>
                    <span class="pc-mtext">INFORMACIÓN</span>
                    <span class="pc-arrow"><i class="ti ti-chevron-right"></i></span>
                </a>
                <ul class="pc-submenu">
                    <li class="pc-item">
                        <a href="informacion-clientes.html" class="pc-link">INFORMACIÓN PARA CLIENTES</a>
                    </li>
                    <li class="pc-item">
                        <a href="informacion-empleados.html" class="pc-link">INFORMACIÓN PARA EMPLEADOS</a>
                    </li>
                    <li class="pc-item">
                        <a href="cotizaciones.html" class="pc-link">COTIZACIONES</a>
                    </li>
                    <li class="pc-item">
                        <a class="pc-link" href="pago-impuestos.html">PAGO DE IMPUESTOS</a>
                    </li>
                </ul>
            </li>

            <li class="pc-item pc-caption">
              <label>GUÍAS Y ACCESO</label>
              <i data-feather="lock"></i>
            </li>
            <li class="pc-item">
                <a href="usuarios-y-contrasenas.html" class="pc-link"><span class="pc-micon"><i data-feather="key"></i></span><span class="pc-mtext">USUARIOS Y CONTRASEÑA</span></a>
            </li>
            <li class="pc-item">
                <a href="#" class="pc-link"><span class="pc-micon"><i data-feather="plus-circle"></i></span><span class="pc-mtext">GUÍA CREACIÓN EMPRESA</span></a>
            </li>
            <li class="pc-item">
                <a href="#" class="pc-link"><span class="pc-micon"><i data-feather="x-circle"></i></span><span class="pc-mtext">GUÍA DE CERRAR EMPRESAS</span></a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <header class="pc-header">
      <div class="header-wrapper flex max-sm:px-[15px] px-[25px] grow">
        <div class="me-auto pc-mob-drp">
          <ul class="inline-flex *:min-h-header-height *:inline-flex *:items-center">
            <li class="pc-h-item pc-sidebar-collapse max-lg:hidden lg:inline-flex">
              <a href="#" class="pc-head-link ltr:!ml-0 rtl:!mr-0" id="sidebar-hide">
                <i data-feather="menu"></i>
              </a>
            </li>
            <li class="pc-h-item pc-sidebar-popup lg:hidden">
              <a href="#" class="pc-head-link ltr:!ml-0 rtl:!mr-0" id="mobile-collapse">
                <i data-feather="menu"></i>
              </a>
            </li>
            <li class="dropdown pc-h-item">
              <a class="pc-head-link dropdown-toggle me-0" data-pc-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
                <i data-feather="search"></i>
              </a>
              <div class="dropdown-menu pc-h-dropdown drp-search">
                <form class="px-2 py-1">
                  <input type="search" class="form-control !border-0 !shadow-none" placeholder="Search here. . ." />
                </form>
              </div>
            </li>
          </ul>
        </div>
        <div class="ms-auto">
          <ul class="inline-flex *:min-h-header-height *:inline-flex *:items-center">
            <li class="dropdown pc-h-item">
              <a class="pc-head-link dropdown-toggle me-0" data-pc-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
                <i data-feather="sun"></i>
              </a>
              <div class="dropdown-menu dropdown-menu-end pc-h-dropdown">
                <a href="#!" class="dropdown-item" onclick="layout_change('dark')">
                  <i data-feather="moon"></i> <span>Oscuro</span>
                </a>
                <a href="#!" class="dropdown-item" onclick="layout_change('light')">
                  <i data-feather="sun"></i> <span>Claro</span>
                </a>
                <a href="#!" class="dropdown-item" onclick="layout_change_default()">
                  <i data-feather="settings"></i> <span>Por Defecto</span>
                </a>
              </div>
            </li>
            <li class="dropdown pc-h-item">
              <a class="pc-head-link dropdown-toggle me-0" data-pc-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
                <i data-feather="settings"></i>
              </a>
              <div class="dropdown-menu dropdown-menu-end pc-h-dropdown">
                <a href="#!" class="dropdown-item">
                  <i class="ti ti-user"></i> <span>Mi Cuenta</span>
                </a>
                <a href="#!" class="dropdown-item">
                  <i class="ti ti-settings"></i> <span>Configuración</span>
                </a>
                <a href="#!" class="dropdown-item">
                  <i class="ti ti-headset"></i> <span>Soporte</span>
                </a>
                <a href="#!" class="dropdown-item">
                  <i class="ti ti-lock"></i> <span>Bloquear Pantalla</span>
                </a>
                <a href="#!" class="dropdown-item">
                  <i class="ti ti-power"></i> <span>Cerrar Sesión</span>
                </a>
              </div>
            </li>
            <li class="dropdown pc-h-item">
              <a class="pc-head-link dropdown-toggle me-0" data-pc-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
                <i data-feather="bell"></i>
                <span class="badge bg-success-500 text-white rounded-full z-10 absolute right-0 top-0">5</span>
              </a>
              <div class="dropdown-menu dropdown-notification dropdown-menu-end pc-h-dropdown p-2">
                <div class="card my-2">
                  <div class="card-header flex items-center justify-between pb-0">
                    <h5 class="mb-0">Notificaciones</h5>
                    <div class="dropdown">
                      <a class="avtar avtar-xs btn-link-secondary dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="false" aria-expanded="false">
                        <i class="ti ti-dots-vertical"></i>
                      </a>
                      <div class="dropdown-menu dropdown-menu-end">
                        <a class="dropdown-item" href="#">Limpiar Todo</a>
                        <a class="dropdown-item" href="#">Marcar como leído</a>
                        <a class="dropdown-item" href="#">Ajustar configuración</a>
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="flex items-start">
                      <div class="flex-shrink-0">
                        <i class="ti ti-bell bg-primary-500 text-white rounded-md p-2 me-2"></i>
                      </div>
                      <div class="flex-grow-1">
                        <h6 class="mb-0">Añadir Campo de Notas al Formulario</h6>
                        <p class="mb-0 text-sm">Empieza a trabajar en la tarea asignada para la semana.</p>
                        <span class="text-xs text-muted">2 min ago</span>
                      </div>
                      <div class="flex-shrink-0">
                        <a class="text-muted" href="#"><i class="ti ti-x-circle"></i></a>
                      </div>
                    </div>
                    <hr class="my-2" />
                    <div class="flex items-start">
                      <div class="flex-shrink-0">
                        <i class="ti ti-user bg-info-500 text-white rounded-md p-2 me-2"></i>
                      </div>
                      <div class="flex-grow-1">
                        <h6 class="mb-0">Problema con la Carga de Beneficiarios</h6>
                        <p class="mb-0 text-sm">Revisa el archivo de logs. Posible fallo en la estructura JSON.</p>
                        <span class="text-xs text-muted">10 min ago</span>
                      </div>
                      <div class="flex-shrink-0">
                        <a class="text-muted" href="#"><i class="ti ti-x-circle"></i></a>
                      </div>
                    </div>
                  </div>
                  <div class="card-footer bg-transparent py-3 text-center">
                    <a href="#" class="text-primary-500 text-sm">Ver Todas las Notificaciones</a>
                  </div>
                </div>
              </div>
            </li>
            <li class="dropdown pc-h-item">
              <a href="#" class="pc-head-link dropdown-toggle arrow-none me-0" data-pc-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                <img src="../assets/images/user/avatar-2.jpg" alt="user-image" class="user-avtar rounded-circle md:h-10 md:w-10 h-8 w-8" />
              </a>
              <div class="dropdown-menu dropdown-menu-end pc-h-dropdown">
                <a href="#!" class="dropdown-item">
                  <i class="ti ti-user"></i> <span>Mi Cuenta</span>
                </a>
                <a href="#!" class="dropdown-item">
                  <i class="ti ti-settings"></i> <span>Configuración</span>
                </a>
                <a href="#!" class="dropdown-item">
                  <i class="ti ti-headset"></i> <span>Soporte</span>
                </a>
                <a href="#!" class="dropdown-item">
                  <i class="ti ti-lock"></i> <span>Bloquear Pantalla</span>
                </a>
                <a href="#!" class="dropdown-item">
                  <i class="ti ti-power"></i> <span>Cerrar Sesión</span>
                </a>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </header>
    <div class="pc-container">
      <div class="pc-content">
        <div class="page-header" id="pageHeaderBlock">
          <div class="page-block">
            <div class="row align-items-center">
              <div class="col-md-12">
                <ul class="breadcrumb mb-3">
                  <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                  <li class="breadcrumb-item"><a href="javascript: void(0)">Gestión Operativa</a></li>
                  <li class="breadcrumb-item" aria-current="page">Formularios PDF</li>
                </ul>
              </div>
              <div class="col-md-12">
                <div class="page-header-title">
                  <h2 class="mb-0" id="main-title">Generación y Administración de Formularios PDF</h2>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="feedbackMessageFormularios" class="mb-4"></div>

        <div class="row">
            <div class="col-xl-12" id="main-content-block">

                <div class="card" id="cardGeneracion">
                    <div class="card-body">
                        <h5>Generar Formulario Rellenado</h5>
                        <p>Seleccione el formulario, ingrese el ID del empleado para buscarlo, y seleccione la empresa.</p>

                        <form id="formGeneracion">
                            <input type="hidden" id="hiddenUsuarioId" name="usuario_id">

                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label for="selectFormulario" class="form-label">1. Seleccionar Formulario Importado</label>
                                    <select class="form-select" id="selectFormulario" required>
                                        <option value="">Cargando formularios...</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row g-3 mt-3">
                                <div class="col-md-12">
                                    <label for="selectEmpresa" class="form-label">2. Seleccionar Empresa</label>
                                    <select class="form-select" id="selectEmpresa" required>
                                        <option value="">Cargando empresas...</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row g-3 mt-3">
                                <div class="col-md-6">
                                    <label for="selectTipoIdUsuario" class="form-label">3. Seleccionar Tipo ID Usuario</label>
                                    <select class="form-select" id="selectTipoIdUsuario" required>
                                        <option value="">Seleccione...</option>
                                        <option value="Cédula de Ciudadanía">Cédula de Ciudadanía</option>
                                        <option value="Cédula de Extranjería">Cédula de Extranjería</option>
                                        <option value="Permiso Temporal">Permiso Temporal</option>
                                        <option value="Pasaporte">Pasaporte</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="inputNumeroIdUsuario" class="form-label">4. Ingresar Número ID Usuario</label>
                                    <input type="text" class="form-control" id="inputNumeroIdUsuario" placeholder="Ingrese el número y presione Enter o cambie campo" required>
                                </div>
                            </div>

                            <div class="row g-3 mt-3">
                                <div class="col-md-12">
                                    <label for="inputUsuarioSeleccionado" class="form-label">5. Empleado/Usuario Encontrado</label>
                                    <input type="text" class="form-control" id="inputUsuarioSeleccionado" readonly placeholder="Esperando búsqueda por ID...">
                                </div>
                            </div>

                            <div class="mt-4 d-flex gap-3">
                                <button type="submit" class="btn btn-primary" id="btnGenerar">
                                    <i class="ph-duotone ph-file-pdf me-2"></i> Generar y Descargar PDF
                                </button>
                                <button type="button" class="btn btn-success" id="btnImportarNuevo">
                                    <i class="ph-duotone ph-file-plus me-2"></i> Importar/Gestionar PDF
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card mt-4 d-none" id="cardHistorial">
                    <div class="card-header">
                        <h5>Historial Reciente de Documentos Generados</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="tablaHistorial">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Formulario</th>
                                        <th>Empresa</th>
                                        <th>Usuario (ID)</th>
                                        <th>Archivo Generado</th>
                                        <th>Fecha Generación</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="7" class="text-center text-muted">Funcionalidad de historial pendiente.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="importacion-view" class="d-none">
                    <div class="mb-4">
                        <button type="button" class="btn btn-link px-0 text-muted" onclick="showGenerationView()">
                            <i class="ti ti-arrow-left me-2"></i> Volver a Generación de Formularios
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <ul class="nav nav-tabs mb-4" id="importTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-pane" type="button" role="tab" aria-controls="upload-pane" aria-selected="true">
                                        <i class="ti ti-cloud-upload me-2"></i> Cargar Nuevo PDF
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-pane" type="button" role="tab" aria-controls="list-pane" aria-selected="false">
                                        <i class="ti ti-list-details me-2"></i> Listado de Formularios Importados
                                    </button>
                                </li>
                            </ul>
                            <div class="tab-content" id="importTabsContent">
                                <div class="tab-pane fade show active" id="upload-pane" role="tabpanel" aria-labelledby="upload-tab" tabindex="0">
                                    <h5 class="mb-3">Cargar Nuevo PDF Rellenable</h5>
                                    <p>Cargue un archivo PDF que contenga campos rellenables (Formularios AcroForm) para poder utilizarlo en la generación automática.</p>
                                    <form id="formImportacion" enctype="multipart/form-data">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="nombreFormulario" class="form-label">Nombre del Formulario</label>
                                                <input type="text" class="form-control" id="nombreFormulario" name="nombre" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="archivoPdf" class="form-label">Archivo PDF (Max 10MB)</label>
                                                <input class="form-control" type="file" id="archivoPdf" name="archivo" accept=".pdf" required>
                                            </div>
                                        </div>
                                        <div class="mt-4 text-end">
                                            <button type="submit" class="btn btn-success" id="btnImportar">
                                                <i class="ph-duotone ph-cloud-arrow-up me-2"></i> Importar y Analizar Campos
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                <div class="tab-pane fade" id="list-pane" role="tabpanel" aria-labelledby="list-tab" tabindex="0">
                                    <div class="card-header border-0 bg-transparent px-0 pb-0 d-flex justify-content-between align-items-center">
                                         <h5 class="mb-0">Formularios Importados</h5>
                                         <button class="btn btn-sm btn-outline-secondary" onclick="loadFormulariosImportados(true)"><i data-feather="refresh-cw" class="me-1"></i> Recargar Lista</button>
                                    </div>
                                    <div class="table-responsive mt-3">
                                        <table class="table table-hover" id="tablaFormulariosImportados">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Nombre</th>
                                                    <th>Archivo Original</th>
                                                    <th>Campos Detectados</th>
                                                    <th>Fecha Importación</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr class="loading-placeholder"><td colspan="6" class="text-center text-muted">Cargando...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
        </div>
        </div>
    </div>
    <footer class="pc-footer">
      <div class="footer-wrapper container-fluid mx-10">
        <div class="grid grid-cols-12 gap-1.5">
          <div class="col-span-12 sm:col-span-6 my-1">
            <p class="m-0">
              <a href="https://codedthemes.com/" class="text-theme-bodycolor dark:text-themedark-bodycolor hover:text-primary-500 dark:hover:text-primary-500" target="_blank">CodedThemes</a>
              , Built with ♥ for a smoother web presence.
            </p>
          </div>
          <div class="col-span-12 sm:col-span-6 my-1 justify-self-end">
    <div class="floting-button fixed bottom-[50px] right-[30px] z-[1030]">
    </div>

            <p class="inline-block max-sm:mr-3 sm:ml-2">Distributed by <a href="https://themewagon.com" target="_blank">Themewagon</a></p>
          </div>
        </div>
      </div>
    </footer>
    <script src="../assets/js/plugins/simplebar.min.js"></script>
    <script src="../assets/js/plugins/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/plugins/feather.min.js"></script> <script src="../assets/js/component.js"></script>
    <script src="../assets/js/theme.js"></script>
    <script src="../assets/js/script.js"></script>

    <script>
        // --- Variables Globales ---
        const API_URL = '/api'; // Ruta relativa
        let usuariosStore = null; // Guardará TODOS los usuarios una vez cargados
        let empresasStore = []; // Guardará las empresas
        let currentUserId = null; // ID del usuario encontrado para generar formulario

        // --- Elementos del DOM ---
        const pageHeader = document.getElementById('pageHeaderBlock');
        const mainContentBlock = document.getElementById('main-content-block');
        const generationCard = document.getElementById('cardGeneracion');
        const historyCard = document.getElementById('cardHistorial'); // Aunque no se usa aún
        const importView = document.getElementById('importacion-view');
        const feedbackDiv = document.getElementById('feedbackMessageFormularios');

        // --- Funciones para Mostrar/Ocultar Vistas ---
        function showGenerationView() {
            if(generationCard) generationCard.classList.remove('d-none');
            // if(historyCard) historyCard.classList.remove('d-none'); // Ocultar historial por ahora
            if(importView) importView.classList.add('d-none');
            if(pageHeader) pageHeader.classList.remove('d-none');
            loadInitialData(); // Recargar datos necesarios para la generación
        }

        function showImportView() {
            if(generationCard) generationCard.classList.add('d-none');
            // if(historyCard) historyCard.classList.add('d-none');
            if(importView) importView.classList.remove('d-none');
            if(pageHeader) pageHeader.classList.add('d-none');
            // Cargar lista de formularios al mostrar esta vista si la pestaña está activa
            const listTabButton = document.getElementById('list-tab');
            if (listTabButton && listTabButton.classList.contains('active')) {
                 loadFormulariosImportados();
            }
        }

        // --- Mostrar Mensaje ---
        function showMessage(message, type = 'info') {
             if (feedbackDiv) {
                 feedbackDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                                           ${message}
                                           <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>`;
             } else {
                 alert(message); // Fallback si no existe el div
             }
        }

        // --- Inicializar Feather Icons ---
         function initializeFeatherIcons() {
             // Retraso ligero para asegurar que feather esté disponible
             setTimeout(() => {
                 if (typeof feather !== 'undefined' && feather && typeof feather.replace === 'function') {
                     try {
                         feather.replace();
                         // console.log("Feather Icons re-initialized.");
                     } catch (e) {
                         console.error("Error calling feather.replace() after delay:", e);
                     }
                 } else {
                     console.error("Feather Icons library (feather) is still not defined or does not have the 'replace' method after delay. Please verify the script tag for '../assets/js/plugins/feather.min.js' is correct and loads before this script block.");
                 }
             }, 100); // 100ms de retraso
         }

        // --- Carga de Datos Iniciales (Formularios, Empresas, Usuarios) ---
        async function loadInitialData(forceReloadUsers = false) {
             const loader = document.querySelector('.loader-bg');
             if(loader) loader.style.display = 'flex';
             showMessage('Cargando datos necesarios...', 'info');

             try {
                 const fetchPromises = [
                    fetch(`${API_URL}/formularios`, { credentials: 'include' }),
                    fetch(`${API_URL}/empresas`, { credentials: 'include' }),
                    // Solo cargar usuarios si no están ya en memoria o si forzamos recarga
                    (usuariosStore === null || forceReloadUsers) ? fetch(`${API_URL}/usuarios`, { credentials: 'include' }) : Promise.resolve(null)
                 ];

                 const [formResponse, empResponse, userResponseOrNull] = await Promise.all(fetchPromises);

                 // Validar respuestas
                 if (!formResponse.ok) throw new Error(`Error ${formResponse.status} cargando formularios`);
                 if (!empResponse.ok) throw new Error(`Error ${empResponse.status} cargando empresas`);
                 // Validar respuesta de usuarios solo si se hizo la petición
                  if (userResponseOrNull && !userResponseOrNull.ok) throw new Error(`Error ${userResponseOrNull.status} cargando usuarios`);

                 const formularios = await formResponse.json();
                 empresasStore = await empResponse.json();
                 // Actualizar usuariosStore solo si se hizo la petición
                 if (userResponseOrNull) {
                     usuariosStore = await userResponseOrNull.json();
                     console.log(`Usuarios cargados/recargados: ${usuariosStore.length}`);
                 } else {
                     console.log(`Usuarios ya estaban en memoria: ${usuariosStore ? usuariosStore.length : 0}`);
                 }


                 // Poblar Select de Formularios
                 const selectFormulario = document.getElementById('selectFormulario');
                 if (selectFormulario) {
                     selectFormulario.innerHTML = '<option value="">Seleccione un formulario...</option>';
                     formularios.forEach(f => selectFormulario.add(new Option(f.nombre, f.id)));
                 }

                 // Poblar Select de Empresas
                 const selectEmpresa = document.getElementById('selectEmpresa');
                 if (selectEmpresa) {
                     const currentEmpresa = selectEmpresa.value; // Guardar selección actual
                     selectEmpresa.innerHTML = '<option value="">Seleccione una empresa...</option>';
                     empresasStore.forEach(e => selectEmpresa.add(new Option(`${e.nombre_empresa} (NIT: ${e.nit})`, e.nit)));
                     // Restaurar selección si es válida
                     if (empresasStore.some(e => e.nit === currentEmpresa)) {
                          selectEmpresa.value = currentEmpresa;
                     }
                 }

                 // Resetear búsqueda de usuario si no hay uno seleccionado
                 if (currentUserId === null) {
                     resetUserSearch();
                 }

                 showMessage('Datos cargados.', 'success');

             } catch (error) {
                 console.error('Error al cargar datos iniciales:', error);
                 showMessage(`Error al cargar datos: ${error.message}. Algunas funciones pueden no estar disponibles.`, 'danger');
                 // Resetear selectores si falló la carga
                  const selectFormulario = document.getElementById('selectFormulario');
                  if (selectFormulario) selectFormulario.innerHTML = '<option value="">Error al cargar</option>';
                  const selectEmpresa = document.getElementById('selectEmpresa');
                  if (selectEmpresa) selectEmpresa.innerHTML = '<option value="">Error al cargar</option>';
                  usuariosStore = null; // Marcar usuarios como no cargados
                  resetUserSearch();
             } finally {
                 if(loader) loader.style.display = 'none';
             }
        }

        // --- Resetear Búsqueda de Usuario ---
        function resetUserSearch() {
            const tipoIdSelect = document.getElementById('selectTipoIdUsuario');
            const numeroIdInput = document.getElementById('inputNumeroIdUsuario');
            const displayField = document.getElementById('inputUsuarioSeleccionado');
            const hiddenIdField = document.getElementById('hiddenUsuarioId');

            if(tipoIdSelect) tipoIdSelect.value = '';
            if(numeroIdInput) numeroIdInput.value = '';
            if(displayField) displayField.value = 'Ingrese Tipo y Número de ID';
            if(hiddenIdField) hiddenIdField.value = '';
            currentUserId = null;
        }

        // --- Buscar Usuario por ID ---
        function findUser() {
            const tipoIdSelect = document.getElementById('selectTipoIdUsuario');
            const numeroIdInput = document.getElementById('inputNumeroIdUsuario');
            const displayField = document.getElementById('inputUsuarioSeleccionado');
            const hiddenIdField = document.getElementById('hiddenUsuarioId');

            if (!tipoIdSelect || !numeroIdInput || !displayField || !hiddenIdField) return; // Salir si falta algún elemento

            const tipoId = tipoIdSelect.value;
            const numeroId = numeroIdInput.value.trim();

            displayField.value = 'Buscando...';
            hiddenIdField.value = '';
            currentUserId = null;

            if (!tipoId || !numeroId) {
                displayField.value = 'Ingrese Tipo y Número de ID';
                return;
            }

            if (!usuariosStore) {
                 console.error("La lista completa de usuarios no está cargada.");
                 displayField.value = 'Error: Recargue datos';
                 showMessage("Error interno: La lista de usuarios no se cargó correctamente. Intente recargar la página.", "danger");
                 return;
            }

            // Filtrar usuarios (puede haber duplicados si la BD no tiene constraint UNIQUE)
            const foundUsers = usuariosStore.filter(u => u.tipoId === tipoId && u.numeroId === numeroId);

            if (foundUsers.length === 1) {
                const foundUser = foundUsers[0];
                displayField.value = `${foundUser.primerNombre || ''} ${foundUser.primerApellido || ''}`.trim();
                hiddenIdField.value = foundUser.id; // Asumiendo que el backend devuelve un 'id' único
                currentUserId = foundUser.id;
                showMessage(`Usuario ${displayField.value} encontrado.`, 'success');
            } else if (foundUsers.length > 1) {
                 displayField.value = 'ID Duplicado Encontrado';
                 showMessage(`Se encontraron múltiples usuarios con el ID ${numeroId}. Contacte al administrador.`, 'warning');
            } else {
                displayField.value = 'Empleado no encontrado';
                showMessage(`No se encontró ningún empleado con Tipo ID '${tipoId}' y Número '${numeroId}'.`, 'warning');
            }
        }

        // --- Generar y Descargar PDF ---
        async function handleGeneratePdf(event) {
            event.preventDefault();
            const form = event.target;
            const btn = document.getElementById('btnGenerar');
            const originalBtnHtml = btn.innerHTML;

            const formulario_id = document.getElementById('selectFormulario').value;
            const usuario_id = currentUserId; // Usar el ID guardado al encontrar usuario
            const empresa_nit = document.getElementById('selectEmpresa').value;

            if (!formulario_id || !usuario_id || !empresa_nit) {
                showMessage('Por favor, seleccione un formulario, encuentre un empleado válido por su ID y seleccione una empresa.', 'warning');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Generando...';
            showMessage('Generando PDF, por favor espere...', 'info');

            try {
                const response = await fetch(`${API_URL}/formularios/generar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/pdf' }, // Indicar que esperamos PDF
                    body: JSON.stringify({ formulario_id, usuario_id, empresa_nit }),
                    credentials: 'include'
                });

                if (!response.ok) {
                    let errorData;
                    try { errorData = await response.json(); }
                    catch (jsonError) { throw new Error(`Error ${response.status}: ${response.statusText}`); }
                    throw new Error(errorData.error || `Error ${response.status} al generar el PDF.`);
                }

                // Intentar obtener el nombre del archivo de la cabecera
                const contentDisposition = response.headers.get('content-disposition');
                let filename = `formulario_${formulario_id}_usuario_${usuario_id}.pdf`; // Nombre por defecto
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/i);
                    if (filenameMatch && filenameMatch.length > 1) filename = filenameMatch[1];
                }

                // Descargar el blob como archivo
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none'; a.href = url; a.download = filename;
                document.body.appendChild(a); a.click();
                window.URL.revokeObjectURL(url); a.remove();

                showMessage(`✅ PDF "${filename}" generado y descarga iniciada.`, 'success');
                // Opcional: Limpiar formulario después de generar
                // form.reset();
                // resetUserSearch();

            } catch (error) {
                console.error("Error en la generación/descarga:", error);
                showMessage(`❌ Error al generar PDF: ${error.message}`, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnHtml;
                initializeFeatherIcons(); // Re-inicializar iconos del botón
            }
        }

        // --- Importar Nuevo Formulario ---
        async function handleImportForm(event) {
             event.preventDefault();
             const form = event.target;
             const formData = new FormData(form);
             const btn = document.getElementById('btnImportar');
             const originalBtnHtml = btn.innerHTML;

             const fileInput = document.getElementById('archivoPdf');
             const nombreInput = document.getElementById('nombreFormulario');

             if (!fileInput.files.length || !nombreInput.value.trim()) {
                 showMessage('Por favor, ingrese un nombre y seleccione un archivo PDF.', 'warning'); return;
             }

             btn.disabled = true;
             btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Importando...';
             showMessage('Importando formulario...', 'info');

             try {
                 const response = await fetch(`${API_URL}/formularios/importar`, {
                      method: 'POST',
                      body: formData,
                      credentials: 'include'
                 });
                 const data = await response.json();
                 if (!response.ok) throw new Error(data.error || 'Error en la importación.');

                 showMessage(`✅ Formulario "${formData.get('nombre')}" importado con éxito.`, 'success');
                 form.reset();
                 // Cambiar a la pestaña de listado y recargarla
                 const listTabButton = document.getElementById('list-tab');
                 if (listTabButton) {
                     new bootstrap.Tab(listTabButton).show(); // Activa la pestaña
                     // loadFormulariosImportados() se llamará automáticamente por el evento 'show.bs.tab'
                 }
                 // Recargar datos iniciales en segundo plano para que el nuevo form aparezca en el select
                 loadInitialData();

             } catch (error) {
                 showMessage(`❌ Error al importar: ${error.message}`, 'danger');
             } finally {
                 btn.disabled = false;
                 btn.innerHTML = originalBtnHtml;
                 initializeFeatherIcons();
             }
        }


        // --- Cargar Lista de Formularios Importados ---
        async function loadFormulariosImportados(showLoadingMessage = false) {
             const tbody = document.getElementById('tablaFormulariosImportados')?.querySelector('tbody');
             if (!tbody) return;

             if(showLoadingMessage) showMessage('Recargando lista de formularios...', 'info');
             tbody.innerHTML = '<tr class="loading-placeholder"><td colspan="6" class="text-center"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Cargando formularios importados...</td></tr>';

             try {
                 const response = await fetch(`${API_URL}/formularios`, { credentials: 'include' });
                 if (!response.ok) throw new Error(`Error ${response.status} al cargar formularios importados.`);

                 const formularios = await response.json();
                 tbody.innerHTML = '';
                 if (formularios.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay formularios importados.</td></tr>'; return;
                 }
                 formularios.forEach(f => {
                     const row = tbody.insertRow();
                     row.insertCell().textContent = f.id;
                     row.insertCell().textContent = f.nombre;
                     row.insertCell().textContent = f.nombre_archivo;
                     row.insertCell().textContent = 'N/A'; // Campo 'campos_mapeados' no se usa por ahora
                     row.insertCell().textContent = f.created_at ? new Date(f.created_at).toLocaleDateString() : 'N/A';
                     // Crear botón de eliminar
                     const deleteButton = document.createElement('button');
                     deleteButton.className = 'btn btn-sm btn-danger btn-icon';
                     deleteButton.title = 'Eliminar Formulario';
                     deleteButton.innerHTML = '<i data-feather="trash-2"></i>';
                     deleteButton.onclick = () => deleteFormulario(f.id, f.nombre);
                     row.insertCell().appendChild(deleteButton);
                 });
                 initializeFeatherIcons(); // Importante para los iconos de los botones

             } catch (error) {
                 console.error("Error al cargar formularios importados:", error);
                 tbody.innerHTML = `<tr class="error-placeholder"><td colspan="6" class="text-center">Error al cargar: ${error.message}</td></td>`;
             }
        }

        // --- Eliminar Formulario Importado ---
        async function deleteFormulario(id, nombre) {
            if (!confirm(`¿Seguro que desea eliminar el formulario "${nombre}" (ID: ${id})? Esta acción no se puede deshacer.`)) return;

            showMessage(`Eliminando formulario ${nombre}...`, 'warning');

            try {
                const response = await fetch(`${API_URL}/formularios/${id}`, {
                     method: 'DELETE',
                     credentials: 'include'
                });
                 if (!response.ok) {
                     const data = await response.json();
                     throw new Error(data.error || `Error ${response.status} al eliminar.`);
                 }
                 showMessage(`✅ Formulario "${nombre}" eliminado correctamente.`, 'success');
                 loadFormulariosImportados(); // Recargar la lista
                 loadInitialData(); // Recargar datos generales para actualizar el select
            } catch (error) {
                 showMessage(`❌ Error al eliminar "${nombre}": ${error.message}`, 'danger');
            }
        }

        // --- Carga Inicial y Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
             const loader = document.querySelector('.loader-bg');
             if(loader) loader.style.display = 'none'; // Ocultar pre-loader inicial

             // Configurar listeners de cambio de vista
             const btnImportarNuevo = document.getElementById('btnImportarNuevo');
             if(btnImportarNuevo) btnImportarNuevo.addEventListener('click', showImportView);

             // Configurar listeners de formularios
             const formGeneracion = document.getElementById('formGeneracion');
             if(formGeneracion) formGeneracion.addEventListener('submit', handleGeneratePdf);
             const formImportacion = document.getElementById('formImportacion');
             if(formImportacion) formImportacion.addEventListener('submit', handleImportForm);

              // Configurar listeners para autocompletado
             const tipoIdSelect = document.getElementById('selectTipoIdUsuario');
             const numeroIdInput = document.getElementById('inputNumeroIdUsuario');
             if(tipoIdSelect) tipoIdSelect.addEventListener('change', findUser);
             if(numeroIdInput) {
                  numeroIdInput.addEventListener('change', findUser); // Buscar al perder foco
                  numeroIdInput.addEventListener('keypress', function(event) {
                      if (event.key === 'Enter') {
                          event.preventDefault();
                          findUser();
                      }
                  });
             }


             // Listener para cargar la lista cuando se muestra la pestaña
              const listTabButton = document.getElementById('list-tab');
              if (listTabButton) {
                  listTabButton.addEventListener('show.bs.tab', () => loadFormulariosImportados(true)); // Pasar true para mostrar mensaje de carga
              }

             // Mostrar vista inicial y cargar datos
             showGenerationView(); // Empieza en la vista de generación
             initializeFeatherIcons(); // Inicializar iconos al cargar

            // Scripts de configuración del tema
            if (typeof layout_change === 'function') layout_change('false');
            if (typeof layout_theme_sidebar_change === 'function') layout_theme_sidebar_change('dark');
            if (typeof change_box_container === 'function') change_box_container('false'); // Asegurar compatibilidad
            if (typeof layout_caption_change === 'function') layout_caption_change('true');
            if (typeof layout_rtl_change === 'function') layout_rtl_change('false');
            if (typeof preset_change === 'function') preset_change('preset-1'); // Asegurar compatibilidad
            if (typeof main_layout_change === 'function') main_layout_change('vertical');
        });
    </script>

  </body>
</html>