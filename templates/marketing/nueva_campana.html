<!doctype html>
<html lang="es" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
    <title>Nueva Campaña | Portal Montero</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/fonts/phosphor/duotone/style.css" />
    <link rel="stylesheet" href="/assets/fonts/tabler-icons.min.css" />
    <link rel="stylesheet" href="/assets/fonts/feather.css" />
    <link rel="stylesheet" href="/assets/fonts/fontawesome.css" />
    <link rel="stylesheet" href="/assets/fonts/material.css" />
    <link rel="stylesheet" href="/assets/css/style.css" id="main-style-link" />
    <!-- ✅ REDISEÑO CORPORATIVO ENTERPRISE -->
    <link rel="stylesheet" href="/assets/css/corporate-redesign.css" />
</head>
<body>
    <div class="loader-bg fixed inset-0 bg-white dark:bg-themedark-cardbg z-[1034]">
        <div class="loader-track h-[5px] w-full inline-block absolute overflow-hidden top-0">
            <div class="loader-fill w-[300px] h-[5px] bg-primary-500 absolute top-0 left-0 animate-[hitZak_0.6s_ease-in-out_infinite_alternate]"></div>
        </div>
    </div>

    {% include '_sidebar.html' %}
    {% include '_header.html' %}

    <div class="pc-container">
        <div class="pc-content">
            
            <div class="page-header">
                <div class="page-block">
                    <div class="page-header-title">
                        <h5 class="mb-0 font-medium">Crear Nueva Campaña</h5>
                    </div>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/dashboard">Home</a></li>
                        <li class="breadcrumb-item"><a href="/marketing/campanas">Campañas</a></li>
                        <li class="breadcrumb-item" aria-current="page">Nueva Campaña</li>
                    </ul>
                </div>
            </div>

            <!-- Alert Messages -->
            <div id="alertContainer"></div>

            <!-- Formulario de Nueva Campaña -->
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i data-feather="trending-up" class="me-2"></i>
                                Información de la Campaña
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="formNuevaCampana">
                                <div class="row g-4">
                                    
                                    <!-- Nombre de la Campaña -->
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">
                                            Nombre de la Campaña <span class="text-danger">*</span>
                                        </label>
                                        <input 
                                            type="text" 
                                            class="form-control form-control-lg" 
                                            id="nombreCampana" 
                                            placeholder="Ej: Campaña Black Friday 2025"
                                            required
                                        >
                                        <small class="text-muted">Un nombre descriptivo y memorable</small>
                                    </div>

                                    <!-- Descripción -->
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold">Descripción</label>
                                        <textarea 
                                            class="form-control" 
                                            id="descripcionCampana" 
                                            rows="5"
                                            placeholder="Describe los objetivos, el público objetivo y las estrategias principales de esta campaña..."
                                        ></textarea>
                                        <small class="text-muted">Detalla el propósito y alcance de la campaña</small>
                                    </div>

                                    <!-- Fechas -->
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            Fecha de Inicio <span class="text-danger">*</span>
                                        </label>
                                        <input 
                                            type="date" 
                                            class="form-control" 
                                            id="fechaInicio" 
                                            required
                                        >
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            Fecha de Fin <span class="text-danger">*</span>
                                        </label>
                                        <input 
                                            type="date" 
                                            class="form-control" 
                                            id="fechaFin" 
                                            required
                                        >
                                    </div>

                                    <!-- Presupuesto -->
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Presupuesto (COP)</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input 
                                                type="number" 
                                                class="form-control" 
                                                id="presupuesto" 
                                                value="0" 
                                                min="0"
                                                step="1000"
                                                placeholder="0"
                                            >
                                        </div>
                                        <small class="text-muted">Presupuesto estimado en pesos colombianos</small>
                                    </div>

                                    <!-- Estado -->
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Estado Inicial</label>
                                        <select class="form-select" id="estado">
                                            <option value="Activa" selected>Activa</option>
                                            <option value="Pausada">Pausada</option>
                                            <option value="Borrador">Borrador</option>
                                        </select>
                                        <small class="text-muted">Puedes cambiar esto más tarde</small>
                                    </div>

                                    <!-- Canal -->
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Canal Principal</label>
                                        <select class="form-select" id="canal">
                                            <option value="Redes Sociales">Redes Sociales</option>
                                            <option value="Email Marketing">Email Marketing</option>
                                            <option value="WhatsApp Business">WhatsApp Business</option>
                                            <option value="Google Ads">Google Ads</option>
                                            <option value="Facebook Ads">Facebook Ads</option>
                                            <option value="Mixto">Mixto (Multi-canal)</option>
                                        </select>
                                    </div>

                                    <!-- Objetivo -->
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Objetivo de la Campaña</label>
                                        <select class="form-select" id="objetivo">
                                            <option value="Captación de Leads">Captación de Leads</option>
                                            <option value="Conversión de Ventas">Conversión de Ventas</option>
                                            <option value="Engagement">Engagement (Interacción)</option>
                                            <option value="Branding">Branding (Reconocimiento)</option>
                                            <option value="Fidelización">Fidelización de Clientes</option>
                                        </select>
                                    </div>

                                    <!-- Botones de Acción -->
                                    <div class="col-md-12">
                                        <hr class="my-4">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <a href="/marketing/campanas" class="btn btn-secondary">
                                                <i data-feather="arrow-left" class="me-2"></i>
                                                Cancelar y Volver
                                            </a>
                                            <button type="submit" class="btn btn-primary btn-lg">
                                                <i data-feather="save" class="me-2"></i>
                                                Guardar Campaña
                                            </button>
                                        </div>
                                    </div>

                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    {% include '_footer.html' %}

    <script src="/assets/js/plugins/simplebar.min.js"></script>
    <script src="/assets/js/plugins/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/icon/custom-icon.js"></script>
    <script src="/assets/js/plugins/feather.min.js"></script>
    <script src="/assets/js/component.js"></script>
    <script src="/assets/js/theme.js"></script>
    <script>
        // --- POLYFILLS PARA TEMA (Ejecutar ANTES de script.js) ---
        // Previene errores de ReferenceError cuando script.js intenta llamar estas funciones
        window.layout_change = window.layout_change || function() {};
        window.layout_theme_sidebar_change = window.layout_theme_sidebar_change || function() {};
        window.change_box_container = window.change_box_container || function() {};
        window.layout_caption_change = window.layout_caption_change || function() {};
        window.layout_rtl_change = window.layout_rtl_change || function() {};
        window.preset_change = window.preset_change || function() {};
        window.main_layout_change = window.main_layout_change || function() {};
    </script>

    <script src="/assets/js/script.js"></script>
    
    {% include '_theme_config.html' %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();

            // Establecer fecha mínima como hoy
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaInicio').setAttribute('min', hoy);
            document.getElementById('fechaFin').setAttribute('min', hoy);
        });

        // Función para mostrar alertas
        function showAlert(message, type = 'success') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i data-feather="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('alertContainer').innerHTML = alertHtml;
            feather.replace();
            
            // Auto-cerrar después de 5 segundos
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) alert.remove();
            }, 5000);
        }

        // Manejar envío del formulario
        document.getElementById('formNuevaCampana').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Validación de fechas
            const fechaInicio = new Date(document.getElementById('fechaInicio').value);
            const fechaFin = new Date(document.getElementById('fechaFin').value);

            if (fechaFin <= fechaInicio) {
                showAlert('La fecha de fin debe ser posterior a la fecha de inicio', 'danger');
                return;
            }

            // Preparar datos
            const data = {
                nombre_campana: document.getElementById('nombreCampana').value.trim(),
                descripcion: document.getElementById('descripcionCampana').value.trim(),
                fecha_inicio: document.getElementById('fechaInicio').value,
                fecha_fin: document.getElementById('fechaFin').value,
                presupuesto: parseFloat(document.getElementById('presupuesto').value) || 0,
                estado: document.getElementById('estado').value,
                canal: document.getElementById('canal').value,
                objetivo: document.getElementById('objetivo').value
            };

            // Validar nombre
            if (!data.nombre_campana) {
                showAlert('El nombre de la campaña es obligatorio', 'danger');
                return;
            }

            try {
                const response = await fetch('/marketing/api/campanas', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json' 
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert('Campaña creada exitosamente. Redirigiendo...', 'success');
                    
                    // Redireccionar después de 1.5 segundos
                    setTimeout(() => {
                        window.location.href = '/marketing/campanas';
                    }, 1500);
                } else {
                    showAlert(result.error || 'Error al crear la campaña', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión. Por favor, intenta nuevamente.', 'danger');
            }
        });
    </script>
</body>
</html>
