<!doctype html>
<html lang="es" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
    <title>Campañas de Marketing | Portal Montero</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/fonts/phosphor/duotone/style.css" />
    <link rel="stylesheet" href="/assets/fonts/tabler-icons.min.css" />
    <link rel="stylesheet" href="/assets/fonts/feather.css" />
    <link rel="stylesheet" href="/assets/fonts/fontawesome.css" />
    <link rel="stylesheet" href="/assets/fonts/material.css" />
    <link rel="stylesheet" href="/assets/css/style.css" id="main-style-link" />
    <style>
        .progress-campaign {
            height: 8px;
            border-radius: 10px;
        }
        .card-campaign {
            border-left: 4px solid;
            transition: transform 0.2s;
        }
        .card-campaign:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .card-campaign.activa { border-left-color: #28a745; }
        .card-campaign.pausada { border-left-color: #ffc107; }
        .card-campaign.finalizada { border-left-color: #6c757d; }
    </style>
</head>
<body>
    <div class="loader-bg fixed inset-0 bg-white dark:bg-themedark-cardbg z-[1034]">
        <div class="loader-track h-[5px] w-full inline-block absolute overflow-hidden top-0">
            <div class="loader-fill w-[300px] h-[5px] bg-primary-500 absolute top-0 left-0 animate-[hitZak_0.6s_ease-in-out_infinite_alternate]"></div>
        </div>
    </div>


    {% include '_sidebar.html' %}
    {% include '_header.html' %}

    <div class="pc-container">
        <div class="pc-content">
            
            <div class="page-header">
                <div class="page-block">
                    <div class="page-header-title">
                        <h5 class="mb-0 font-medium">Tablero de Campañas Publicitarias</h5>
                    </div>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/dashboard">Home</a></li>
                        <li class="breadcrumb-item"><a href="#!">Marketing</a></li>
                        <li class="breadcrumb-item" aria-current="page">Campañas</li>
                    </ul>
                </div>
            </div>

            <!-- Alert Messages -->
            <div id="alertContainer"></div>

            <!-- Botón Crear Campaña -->
            <div class="text-end mb-3">
                <a href="/marketing/campanas/nueva" class="btn btn-primary">
                    <i data-feather="plus-circle" class="me-2"></i>
                    Nueva Campaña
                </a>
            </div>

            <!-- Grid de Campañas -->
            <div class="row" id="gridCampanas">
                <!-- Tarjetas cargadas dinámicamente -->
            </div>

        </div>
    </div>

    {% include '_footer.html' %}

    <script src="/assets/js/plugins/simplebar.min.js"></script>
    <script src="/assets/js/plugins/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/icon/custom-icon.js"></script>
    <script src="/assets/js/plugins/feather.min.js"></script>
    <script src="/assets/js/component.js"></script>
    <script src="/assets/js/theme.js"></script>
    <script>
        // --- POLYFILLS PARA TEMA (Ejecutar ANTES de script.js) ---
        // Previene errores de ReferenceError cuando script.js intenta llamar estas funciones
        window.layout_change = window.layout_change || function() {};
        window.layout_theme_sidebar_change = window.layout_theme_sidebar_change || function() {};
        window.change_box_container = window.change_box_container || function() {};
        window.layout_caption_change = window.layout_caption_change || function() {};
        window.layout_rtl_change = window.layout_rtl_change || function() {};
        window.preset_change = window.preset_change || function() {};
        window.main_layout_change = window.main_layout_change || function() {};
    </script>

    <script src="/assets/js/script.js"></script>
    
    {% include '_theme_config.html' %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            cargarCampanas();
        });

        // Función para mostrar alertas
        function showAlert(message, type = 'success') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i data-feather="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('alertContainer').innerHTML = alertHtml;
            feather.replace();
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) alert.remove();
            }, 5000);
        }

        // Cargar campañas
        async function cargarCampanas() {
            try {
                const response = await fetch('/marketing/api/campanas', {
                    credentials: 'include'
                });
                const campanas = await response.json();
                
                const grid = document.getElementById('gridCampanas');
                grid.innerHTML = '';
                
                campanas.forEach(campana => {
                    const progreso = calcularProgreso(campana.fecha_inicio, campana.fecha_fin);
                    const estadoClass = campana.estado.toLowerCase();
                    const estadoBadge = getBadgeEstado(campana.estado);
                    
                    grid.innerHTML += `
                        <div class="col-md-6 col-xl-4 mb-3">
                            <div class="card card-campaign ${estadoClass}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <h6 class="mb-0">${campana.nombre_campana}</h6>
                                        ${estadoBadge}
                                    </div>
                                    <p class="text-muted small mb-3">${campana.descripcion || 'Sin descripción'}</p>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small class="text-muted">Progreso</small>
                                            <small class="text-muted">${progreso}%</small>
                                        </div>
                                        <div class="progress progress-campaign">
                                            <div class="progress-bar bg-${estadoClass === 'activa' ? 'success' : 'secondary'}" 
                                                 style="width: ${progreso}%"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="row text-center">
                                        <div class="col-6 border-end">
                                            <p class="text-muted mb-0 small">Presupuesto</p>
                                            <h6 class="mb-0">${formatMoney(campana.presupuesto)}</h6>
                                        </div>
                                        <div class="col-6">
                                            <p class="text-muted mb-0 small">Canal</p>
                                            <h6 class="mb-0">${campana.canal || 'N/A'}</h6>
                                        </div>
                                    </div>
                                    
                                    <hr class="my-3">
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <i data-feather="calendar" style="width:14px;height:14px;"></i>
                                            ${formatDate(campana.fecha_inicio)} - ${formatDate(campana.fecha_fin)}
                                        </small>
                                        <div class="btn-group btn-group-sm" role="group">
                                            ${campana.estado !== 'Finalizada' ? `
                                                <button class="btn btn-outline-warning" onclick="pausarCampana(${campana.id})">
                                                    <i data-feather="pause" style="width:14px;height:14px;"></i>
                                                </button>
                                            ` : ''}
                                            <button class="btn btn-outline-primary" onclick="verDetalle(${campana.id})">
                                                <i data-feather="eye" style="width:14px;height:14px;"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                feather.replace();
            } catch (error) {
                console.error('Error al cargar campañas:', error);
                showAlert('Error al cargar las campañas', 'danger');
            }
        }

        // Funciones auxiliares
        function calcularProgreso(inicio, fin) {
            const hoy = new Date();
            const fechaInicio = new Date(inicio);
            const fechaFin = new Date(fin);
            
            if (hoy < fechaInicio) return 0;
            if (hoy > fechaFin) return 100;
            
            const total = fechaFin - fechaInicio;
            const transcurrido = hoy - fechaInicio;
            return Math.round((transcurrido / total) * 100);
        }

        function getBadgeEstado(estado) {
            const badges = {
                'Activa': '<span class="badge bg-success">Activa</span>',
                'Pausada': '<span class="badge bg-warning">Pausada</span>',
                'Finalizada': '<span class="badge bg-secondary">Finalizada</span>'
            };
            return badges[estado] || '<span class="badge bg-light text-dark">Desconocido</span>';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('es-CO', { 
                style: 'currency', 
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function pausarCampana(id) {
            showAlert(`Campaña #${id} pausada (funcionalidad en desarrollo)`, 'info');
        }

        function verDetalle(id) {
            showAlert(`Ver detalles de campaña #${id} (funcionalidad en desarrollo)`, 'info');
        }
    </script>
</body>
</html>
