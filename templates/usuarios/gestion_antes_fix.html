<!doctype html>
<html lang="en" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr"
  data-pc-theme="light">

<head>
  <title>Gestión de Usuarios | Portal Montero</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="description" content="Sistema de gestión de usuarios y base de datos - Portal Montero y Negocio" />
  <meta name="keywords"
    content="usuarios, base de datos, gestión, Portal Montero, Bootstrap admin template, Dashboard UI Kit, Dashboard Template, Backend Panel, react dashboard, angular dashboard" />
  <meta name="author" content="Portal Montero" />

  <link rel="icon" href="/assets/images/favicon.svg" type="image/x-icon" />

  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/fonts/phosphor/duotone/style.css" />
  <link rel="stylesheet" href="/assets/fonts/tabler-icons.min.css" />
  <link rel="stylesheet" href="/assets/fonts/feather.css" />
  <link rel="stylesheet" href="/assets/fonts/fontawesome.css" />
  <link rel="stylesheet" href="/assets/fonts/material.css" />
  <link rel="stylesheet" href="/assets/css/style.css" id="main-style-link" />
    <!-- ✅ REDISEÑO CORPORATIVO ENTERPRISE -->
    <link rel="stylesheet" href="/assets/css/corporate-redesign.css" />

  <script>
    (async function checkAuthentication() {
      const loader = document.querySelector('.loader-bg');
      if (loader) loader.style.display = 'flex'; // Mostrar loader

      try {
        console.log('🔍 Verificando autenticación (base-datos-usuarios)...');

        // Pausa opcional para asegurar que la sesión se establezca
        await new Promise(resolve => setTimeout(resolve, 100));

        const response = await fetch('/api/check_auth', {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          credentials: 'include'
        });

        console.log('📡 Respuesta check_auth:', response.status);

        if (!response.ok) {
          console.error('❌ Error del servidor:', response.status, response.statusText);
          window.location.href = '/login';
          return;
        }

        const data = await response.json();
        console.log('📦 Datos check_auth:', data);

        if (!data.authenticated) {
          console.log('🚫 Usuario no autenticado, redirigiendo...');
          window.location.href = '/login';
        } else {
          console.log('✅ Usuario autenticado:', data.user_name);
          if (loader) loader.style.display = 'none'; // Ocultar loader
          sessionStorage.setItem('userName', data.user_name);

          // Actualizar nombre de usuario
          document.addEventListener('DOMContentLoaded', () => {
            const userNameDisplay = document.getElementById('userNameDisplay');
            if (userNameDisplay) userNameDisplay.textContent = data.user_name;
          });
        }
      } catch (error) {
        console.error('❌ Error de red en check_auth:', error);
        window.location.href = '/login';
      }
    })();
  </script>

  <style>
    #signature-pad {
      border: 2px dashed #ccc;
      border-radius: 4px;
      touch-action: none;
      background-color: #ffffff;
      width: 100%;
      /* Asegura que tome el ancho disponible */
      max-width: 600px;
      /* Limita el ancho máximo si es necesario */
      height: 120px;
      /* Altura fija */
    }

    /* Estilo para mensajes de feedback */
    #feedbackMessageUser {
      margin-top: 15px;
      font-size: 0.9em;
    }
  </style>

</head>

<body>
  <div class="loader-bg fixed inset-0 bg-white dark:bg-themedark-cardbg z-[1034]">
    <div class="loader-track h-[5px] w-full inline-block absolute overflow-hidden top-0">
      <div
        class="loader-fill w-[300px] h-[5px] bg-primary-500 absolute top-0 left-0 animate-[hitZak_0.6s_ease-in-out_infinite_alternate]">
      </div>
    </div>
  </div>

  {% include '_sidebar.html' %}

  {% include '_header.html' %}
  <div class="pc-container">
    <div class="pc-content">
      <div class="page-header">
        <div class="page-block">
          <div class="page-header-title">
            <h5 class="mb-0 font-medium">Gestión de Usuarios</h5>
          </div>
          <ul class="breadcrumb">
            <li class="breadcrumb-item"><a href="/dashboard">Home</a></li>
            <li class="breadcrumb-item"><a href="javascript: void(0)">Base de Datos</a></li>
            <li class="breadcrumb-item" aria-current="page">Usuarios</li>
          </ul>
        </div>
      </div>
      <div id="feedbackMessageUser" class="mb-4"></div>

      <form id="formAfiliado" action="/api/usuarios" method="POST">
        <div class="card p-4">
          <h3 class="mb-4" id="tituloFormularioAfiliado">📊 CAMPOS DE DATOS DEL AFILIADO</h3>

          <fieldset class="mb-4 p-3 border rounded">
            <legend class="fw-bold">📑 DOCUMENTOS DE IDENTIFICACIÓN</legend>
            <div class="row g-3">
              <div class="col-md-4">
                <label for="tipoId" class="form-label">Tipo de ID</label>
                <select id="tipoId" name="tipoId" class="form-select" required>
                  <option value="">Seleccione...</option>
                  <option>Cédula de Ciudadanía</option>
                  <option>Cédula de Extranjería</option>
                  <option>Pasaporte</option>
                  <option>Otro</option>
                </select>
              </div>
              <div class="col-md-8">
                <label for="numeroId" class="form-label">Número de ID</label>
                <input type="text" class="form-control" id="numeroId" name="numeroId"
                  placeholder="Número único de identificación (Campo Clave)" required>
              </div>
            </div>
          </fieldset>

          <fieldset class="mb-4 p-3 border rounded">
            <legend class="fw-bold">👤 INFORMACIÓN PERSONAL BÁSICA</legend>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="primerNombre" class="form-label">Primer Nombre</label>
                <input type="text" class="form-control" id="primerNombre" name="primerNombre"
                  placeholder="Nombre de pila" required>
              </div>
              <div class="col-md-6">
                <label for="segundoNombre" class="form-label">Segundo Nombre</label>
                <input type="text" class="form-control" id="segundoNombre" name="segundoNombre"
                  placeholder="Segundo nombre (si aplica)">
              </div>
              <div class="col-md-6">
                <label for="primerApellido" class="form-label">Primer Apellido</label>
                <input type="text" class="form-control" id="primerApellido" name="primerApellido"
                  placeholder="Apellido paterno" required>
              </div>
              <div class="col-md-6">
                <label for="segundoApellido" class="form-label">Segundo Apellido</label>
                <input type="text" class="form-control" id="segundoApellido" name="segundoApellido"
                  placeholder="Apellido materno">
              </div>
            </div>
          </fieldset>

          <fieldset class="mb-4 p-3 border rounded">
            <legend class="fw-bold">🚻 INFORMACIÓN DEMOGRÁFICA</legend>
            <div class="row g-3">
              <div class="col-md-4">
                <label for="sexoBiologico" class="form-label">Sexo Biológico</label>
                <select id="sexoBiologico" name="sexoBiologico" class="form-select">
                  <option value="">Seleccione...</option>
                  <option>Masculino</option>
                  <option>Femenino</option>
                  <option>Otro</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="sexoIdentificacion" class="form-label">Sexo de Identificación</label>
                <select id="sexoIdentificacion" name="sexoIdentificacion" class="form-select">
                  <option value="">Seleccione...</option>
                  <option>Masculino</option>
                  <option>Femenino</option>
                  <option>Otro</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="nacionalidad" class="form-label">Nacionalidad</label>
                <input type="text" class="form-control" id="nacionalidad" name="nacionalidad"
                  placeholder="País de nacionalidad">
              </div>
            </div>
          </fieldset>

          <fieldset class="mb-4 p-3 border rounded">
            <legend class="fw-bold">📍 DATOS DE NACIMIENTO</legend>
            <div class="row g-3">
              <div class="col-md-3">
                <label for="fechaNacimiento" class="form-label">Fecha de Nacimiento</label>
                <input type="date" class="form-control" id="fechaNacimiento" name="fechaNacimiento">
              </div>
              <div class="col-md-3">
                <label for="paisNacimiento" class="form-label">País de Nacimiento</label>
                <input type="text" class="form-control" id="paisNacimiento" name="paisNacimiento"
                  placeholder="País donde nació">
              </div>
              <div class="col-md-3">
                <label for="departamentoNacimiento" class="form-label">Departamento</label>
                <input type="text" class="form-control" id="departamentoNacimiento" name="departamentoNacimiento"
                  placeholder="Departamento/estado">
              </div>
              <div class="col-md-3">
                <label for="municipioNacimiento" class="form-label">Municipio</label>
                <input type="text" class="form-control" id="municipioNacimiento" name="municipioNacimiento"
                  placeholder="Municipio/ciudad específica">
              </div>
            </div>
          </fieldset>

          <fieldset class="mb-4 p-3 border rounded">
            <legend class="fw-bold">🏠 LUGAR DE RESIDENCIA</legend>
            <div class="row g-3">
              <div class="col-md-4">
                <label for="paisResidencia" class="form-label">País de Residencia</label>
                <input type="text" class="form-control" id="paisResidencia" name="paisResidencia"
                  placeholder="País donde reside">
              </div>
              <div class="col-md-4">
                <label for="departamentoResidencia" class="form-label">Departamento</label>
                <input type="text" class="form-control" id="departamentoResidencia" name="departamentoResidencia"
                  placeholder="Departamento/estado">
              </div>
              <div class="col-md-4">
                <label for="municipioResidencia" class="form-label">Municipio</label>
                <input type="text" class="form-control" id="municipioResidencia" name="municipioResidencia"
                  placeholder="Municipio/ciudad de residencia">
              </div>
            </div>
          </fieldset>

          <fieldset class="mb-4 p-3 border rounded">
            <legend class="fw-bold">📞 INFORMACIÓN DE CONTACTO</legend>
            <div class="row g-3">
              <div class="col-12">
                <label for="direccion" class="form-label">Dirección</label>
                <input type="text" class="form-control" id="direccion" name="direccion"
                  placeholder="Dirección residencial completa">
              </div>
              <div class="col-md-6">
                <label for="telefonoCelular" class="form-label">Teléfono Celular</label>
                <input type="tel" class="form-control" id="telefonoCelular" name="telefonoCelular"
                  placeholder="Número de móvil">
              </div>
              <div class="col-md-6">
                <label for="telefonoFijo" class="form-label">Teléfono Fijo</label>
                <input type="tel" class="form-control" id="telefonoFijo" name="telefonoFijo"
                  placeholder="Número de teléfono de casa">
              </div>
              <div class="col-md-8">
                <label for="correoElectronico" class="form-label">Correo Electrónico</label>
                <input type="email" class="form-control" id="correoElectronico" name="correoElectronico"
                  placeholder="Email personal (Campo Clave)">
              </div>
              <div class="col-md-4">
                <label for="comunaBarrio" class="form-label">Comuna/Barrio</label>
                <input type="text" class="form-control" id="comunaBarrio" name="comunaBarrio"
                  placeholder="Sector o barrio de residencia">
              </div>
            </div>
          </fieldset>

          <fieldset class="mb-4 p-3 border rounded">
            <legend class="fw-bold">💼 DATOS LABORALES Y DE SEGURIDAD SOCIAL</legend>
            <div class="row g-3">
              <div class="col-md-3">
                <label for="afpNombre" class="form-label">AFP (Fondo)</label>
                <input type="text" class="form-control" id="afpNombre" name="afpNombre" placeholder="Ej: PORVENIR">
              </div>
              <div class="col-md-3">
                <label for="afpCosto" class="form-label">Costo AFP</label>
                <input type="text" class="form-control" id="afpCosto" name="afpCosto" placeholder="Ej: 227.000">
              </div>

              <div class="col-md-3">
                <label for="epsNombre" class="form-label">EPS (Entidad)</label>
                <input type="text" class="form-control" id="epsNombre" name="epsNombre" placeholder="Ej: SURA">
              </div>
              <div class="col-md-3">
                <label for="epsCosto" class="form-label">Costo EPS</label>
                <input type="text" class="form-control" id="epsCosto" name="epsCosto" placeholder="Ej: 140.000">
              </div>

              <div class="col-md-3">
                <label for="arlNombre" class="form-label">ARL (Admin.)</label>
                <input type="text" class="form-control" id="arlNombre" name="arlNombre" placeholder="Ej: POSITIVA">
              </div>
              <div class="col-md-3">
                <label for="arlCosto" class="form-label">Costo ARL</label>
                <input type="text" class="form-control" id="arlCosto" name="arlCosto" placeholder="Ej: 8.500">
              </div>

              <div class="col-md-3">
                <label for="ccfNombre" class="form-label">Caja Compensación (Caja)</label>
                <input type="text" class="form-control" id="ccfNombre" name="ccfNombre" placeholder="Ej: COMPENSAR">
              </div>
              <div class="col-md-3">
                <label for="ccfCosto" class="form-label">Costo CCF</label>
                <input type="text" class="form-control" id="ccfCosto" name="ccfCosto" placeholder="Ej: 50.000">
              </div>

              <div class="col-md-3">
                <label for="administracion" class="form-label">Administración/Empresa</label>
                <input type="text" class="form-control" id="administracion" name="administracion"
                  list="listaEmpresasAdmin" placeholder="Empresa a la que pertenece">
                <datalist id="listaEmpresasAdmin"></datalist>
              </div>
              <div class="col-md-3">
                <label for="ibc" class="form-label">IBC</label>
                <input type="text" class="form-control" id="ibc" name="ibc"
                  placeholder="Ingreso Base de Cotización (Campo Clave)">
              </div>
              <div class="col-md-3">
                <label for="claseRiesgoARL" class="form-label">Clase de Riesgo ARL</label>
                <select id="claseRiesgoARL" name="claseRiesgoARL" class="form-select">
                  <option value="">Seleccione...</option>
                  <option>I (Mínimo)</option>
                  <option>II (Bajo)</option>
                  <option>III (Medio)</option>
                  <option>IV (Alto)</option>
                  <option>V (Máximo)</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="cargo" class="form-label">Cargo</label>
                <input type="text" class="form-control" id="cargo" name="cargo"
                  placeholder="Ej: Operario, Contador, Gerente">
              </div>
              <div class="col-md-3">
                <label for="tipo_contrato" class="form-label">Tipo de Contrato</label>
                <select id="tipo_contrato" name="tipo_contrato" class="form-select">
                  <option value="">Seleccione...</option>
                  <option>Término Indefinido</option>
                  <option>Término Fijo</option>
                  <option>Obra o Labor</option>
                  <option>Prestación de Servicios</option>
                  <option>Aprendizaje</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="fechaIngreso" class="form-label">Fecha de Ingreso</label>
                <input type="date" class="form-control" id="fechaIngreso" name="fechaIngreso"
                  placeholder="Fecha cuando comenzó a trabajar">
              </div>
            </div>
          </fieldset>

          <fieldset class="mb-4 p-3 border rounded">
            <legend class="fw-bold">✍️ FIRMA DIGITAL (Dibujar)</legend>
            <p class="text-muted mb-3">Utilice el mouse o un dispositivo táctil para dibujar la firma dentro del
              recuadro.</p>
            <div class="row g-3">
              <div class="col-12 col-md-8">
                <canvas id="signature-pad" height="120"></canvas>
                <input type="hidden" id="firmaDigitalData" name="firmaDigitalData">
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="fechaFirma" class="form-label">Fecha de Firma</label>
                  <input type="date" class="form-control" id="fechaFirma" name="fechaFirma">
                </div>
                <button type="button" id="clear-signature" class="btn btn-warning w-100"><i data-feather="rotate-ccw"
                    class="me-2"></i> Borrar Firma</button>
              </div>
            </div>
          </fieldset>

          <fieldset class="mb-4 p-3 border rounded">
            <legend class="fw-bold">📎 ADJUNTOS</legend>
            <div class="row g-3">
              <div class="col-md-8">
                <label for="documentoPdf" class="form-label">Adjuntar Cédula (PDF)</label>
                <input class="form-control" type="file" id="documentoPdf" name="documentoPdf" accept=".pdf">
              </div>
              <div class="col-md-4">
              </div>
            </div>
          </fieldset>

          <fieldset class="mb-4 p-3 border rounded">
            <legend class="fw-bold">👨‍👩‍👧‍👦 BENEFICIARIOS</legend>
            <p class="text-muted mb-3">Ingrese los datos de los beneficiarios de este afiliado (cónyuge, hijos, etc.).
            </p>

            <div id="beneficiario-template" class="border p-3 mb-3 rounded bg-light" style="display: none;">
              <h6 class="fw-bold mb-3 d-flex justify-content-between">
                <span>Beneficiario #<span class="beneficiary-index">X</span></span>
                <button type="button" class="btn btn-sm btn-outline-danger btn-remove-beneficiario"><i
                    data-feather="trash-2"></i></button>
              </h6>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="nombreBeneficiario_X" class="form-label">Nombre Completo</label>
                  <input type="text" class="form-control" name="nombreBeneficiario_X"
                    placeholder="Nombre completo del beneficiario">
                </div>
                <div class="col-md-3">
                  <label for="parentesco_X" class="form-label">Parentesco</label>
                  <select name="parentesco_X" class="form-select">
                    <option value="">Seleccione...</option>
                    <option>Cónyuge</option>
                    <option>Hijo/a</option>
                    <option>Padre/Madre</option>
                    <option>Otro</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="documentoBeneficiario_X" class="form-label">Documento ID</label>
                  <input type="text" class="form-control" name="documentoBeneficiario_X"
                    placeholder="Número de identificación">
                </div>
              </div>
            </div>
            <div id="beneficiarios-container"></div>
            <div id="add-beneficiario-container" class="text-start mt-3">
              <button type="button" id="add-beneficiario" class="btn btn-sm btn-success"><i data-feather="plus"
                  class="me-1"></i> Agregar Beneficiario</button>
            </div>
          </fieldset>

          <div class="text-center mt-5">
            <button type="submit" class="btn btn-primary btn-lg" id="btnGuardarUsuario">
              <i data-feather="save" class="me-2"></i>GUARDAR USUARIO EN SERVIDOR
            </button>
            <button type="reset" class="btn btn-secondary btn-lg ms-3">LIMPIAR FORMULARIO</button>
            <button type="button" id="btnLlenarPrueba" class="btn btn-info btn-lg ms-3"><i data-feather="terminal"
                class="me-2"></i>LLENAR DATOS DE PRUEBA</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  {% include '_footer.html' %}
  <div class="floting-button fixed bottom-[50px] right-[30px] z-[1030]">
  </div>

  <script src="/assets/js/plugins/simplebar.min.js"></script>
  <script src="/assets/js/plugins/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/js/plugins/feather.min.js"></script>
  <script src="/assets/js/component.js"></script>
  <script src="/assets/js/theme.js"></script>
  <script>
    // --- POLYFILLS PARA TEMA (Ejecutar ANTES de script.js) ---
    // Previene errores de ReferenceError cuando script.js intenta llamar estas funciones
    window.layout_change = window.layout_change || function () { };
    window.layout_theme_sidebar_change = window.layout_theme_sidebar_change || function () { };
    window.change_box_container = window.change_box_container || function () { };
    window.layout_caption_change = window.layout_caption_change || function () { };
    window.layout_rtl_change = window.layout_rtl_change || function () { };
    window.preset_change = window.preset_change || function () { };
    window.main_layout_change = window.main_layout_change || function () { };
    document.getElementById('segundoApellido').value = 'Gómez';
    document.getElementById('sexoBiologico').value = 'Masculino';
    document.getElementById('sexoIdentificacion').value = 'Masculino';
    document.getElementById('nacionalidad').value = 'Colombiana';
    document.getElementById('fechaNacimiento').value = '1985-06-15';
    document.getElementById('paisNacimiento').value = 'Colombia';
    document.getElementById('departamentoNacimiento').value = 'Valle del Cauca';
    document.getElementById('municipioNacimiento').value = 'Cali';
    document.getElementById('direccion').value = 'Calle 5 # 10-20, Apto 501';
    document.getElementById('telefonoCelular').value = '3105551234';
    document.getElementById('telefonoFijo').value = '6028885678';
    document.getElementById('correoElectronico').value = 'carlos.perez@ejemplo.com';
    document.getElementById('comunaBarrio').value = 'San Fernando';
    document.getElementById('afpNombre').value = 'PORVENIR';
    document.getElementById('afpCosto').value = '227000';
    document.getElementById('epsNombre').value = 'SURA';
    document.getElementById('epsCosto').value = '140000';
    document.getElementById('arlNombre').value = 'POSITIVA';
    document.getElementById('arlCosto').value = '8500';
    document.getElementById('ccfNombre').value = 'COMPENSAR';
    document.getElementById('ccfCosto').value = '50000';
    document.getElementById('administracion').value = 'ADMINISTRADORA DE PRUEBA S.A.S'; // Asegúrate que esta empresa exista en el datalist
    document.getElementById('ibc').value = '2500000';
    document.getElementById('claseRiesgoARL').value = 'II (Bajo)';
    document.getElementById('fechaIngreso').value = '2023-01-20';
    document.getElementById('fechaFirma').value = new Date().toISOString().substring(0, 10);

    // Limpiar y añadir un beneficiario de prueba
    document.getElementById('beneficiarios-container').innerHTML = '';
    document.getElementById('add-beneficiario').click();
    const nombreBenf1 = document.querySelector('[name="nombreBeneficiario_1"]');
    if (nombreBenf1) {
      nombreBenf1.value = 'María Alejandra Gómez';
      const parentescoSelect = document.querySelector('[name="parentesco_1"]');
      const firmaDigitalDataInput = document.getElementById('firmaDigitalData');
      const feedbackDiv = document.getElementById('feedbackMessageUser');
      const saveButton = document.getElementById('btnGuardarUsuario');
      let signaturePad = null; // Inicializar
      let beneficiarioCount = 0; // Contador para IDs únicos de beneficiarios

      // --- Redimensionar Canvas ---
      function resizeCanvas() {
        if (!canvas) return;
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        const ctx = canvas.getContext("2d");
        if (ctx) {
          ctx.scale(ratio, ratio);
          if (signaturePad) {
            signaturePad.clear(); // Limpiar si ya está inicializado
          } else {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Limpiar contexto si no
          }
        } else {
          console.error("No se pudo obtener el contexto 2D del canvas de firma.");
        }
      }

      // --- Lógica de Beneficiarios ---
      function setupBeneficiaryLogic() {
        const addButton = document.getElementById('add-beneficiario');
        const template = document.getElementById('beneficiario-template');
        const container = document.getElementById('beneficiarios-container');

        if (!addButton || !template || !container) {
          console.error("Elementos para beneficiarios no encontrados.");
          return;
        }

        function updateAttributes(element, count) {
          const pattern = /_X$|Beneficiario #X|beneficiary-index/; // Incluir clase del span
          const newSuffix = `_${count}`;
          if (element.hasAttribute('id')) element.setAttribute('id', element.id.replace(pattern, newSuffix));
          if (element.hasAttribute('name')) element.setAttribute('name', element.name.replace(pattern, newSuffix));
          if (element.hasAttribute('for')) element.setAttribute('for', element.getAttribute('for').replace(pattern, newSuffix));
          if (element.classList.contains('beneficiary-index')) element.textContent = count; // Actualizar el número visual
          // Actualizar el texto del encabezado si existe
          const headerSpan = element.closest('.border')?.querySelector('.beneficiary-index');
          if (headerSpan) headerSpan.textContent = count;

        }

        function addNewBeneficiario() {
          beneficiarioCount++;
          const newBlock = template.cloneNode(true);
          newBlock.id = `beneficiario-${beneficiarioCount}`;
          newBlock.style.display = 'block'; // Hacer visible la plantilla clonada

          // Iterar sobre todos los descendientes para actualizar atributos
          newBlock.querySelectorAll('*').forEach(el => {
            // Actualizar el número en el encabezado
            const indexSpan = el.querySelector('.beneficiary-index');
            if (indexSpan) { indexSpan.textContent = beneficiarioCount; }
            updateAttributes(el, beneficiarioCount);
          });

          // Añadir evento al botón de eliminar del nuevo bloque
          const removeButton = newBlock.querySelector('.btn-remove-beneficiario');
          if (removeButton) {
            removeButton.addEventListener('click', () => {
              newBlock.remove();
              // Opcional: Re-enumerar visualmente si se elimina uno intermedio
            });
          }

          container.appendChild(newBlock);
          initializeFeatherIcons(); // Re-inicializar iconos para el nuevo botón
          const firstInput = newBlock.querySelector('input, select');
          if (firstInput) firstInput.focus();
        }

        addButton.addEventListener('click', addNewBeneficiario);
      }

      // --- Carga Inicial y Event Listeners ---
      document.addEventListener('DOMContentLoaded', async () => {
        const loader = document.querySelector('.loader-bg');
        if (loader) loader.style.display = 'none'; // Ocultar pre-loader

        // Cargar lista de empresas para el datalist 'administracion'
        try {
          const response = await fetch('/api/empresas', { credentials: 'include' });
          if (response.ok) {
            const empresas = await response.json();
            const datalist = document.getElementById('listaEmpresasAdmin');
            if (datalist) {
              datalist.innerHTML = ''; // Limpiar opciones previas
              empresas.forEach(emp => {
                datalist.insertAdjacentHTML('beforeend', `<option value="${emp.nombre_empresa}">`);
              });
            }
          } else {
            console.error("Error al cargar lista de empresas:", response.statusText);
          }
        } catch (error) {
          console.error("Error de red al cargar empresas:", error);
        }

        // ========================================================================
        // MODO EDICIÓN: Auto-cargar datos de usuario si viene ?edit_id= en URL
        // ========================================================================
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('edit_id');

        if (editId) {
          console.log(`📝 Modo EDICIÓN activado para Usuario ID: ${editId}`);

          try {
            // Cambiar título de la página a MODO EDICIÓN
            const pageTitle = document.querySelector('.page-header-title h5');
            if (pageTitle) {
              pageTitle.innerHTML = `<span style="color: #ff9800; font-weight: bold;">✏️ EDITAR USUARIO: ${editId}</span>`;
            } else {
              console.warn('⚠️ No se encontró el título de la página');
            }

            // Cambiar también el breadcrumb si existe
            const breadcrumbActive = document.querySelector('.breadcrumb .breadcrumb-item[aria-current="page"]');
            if (breadcrumbActive) {
              breadcrumbActive.textContent = `Editar Usuario ${editId}`;
              breadcrumbActive.style.color = '#ff9800';
            }

            // Cambiar título del formulario
            const tituloFormulario = document.getElementById('tituloFormularioAfiliado');
            if (tituloFormulario) {
              tituloFormulario.innerHTML = `✏️ EDITAR DATOS DEL USUARIO #${editId}`;
              tituloFormulario.style.color = '#ff9800';
            }

            // Fetch datos del usuario
            const response = await fetch(`/api/usuarios/${editId}`, {
              credentials: 'include'
            });

            if (!response.ok) {
              throw new Error(`Usuario no encontrado (ID: ${editId})`);
            }

            const usuario = await response.json();
            console.log('✅ Datos de usuario cargados:', usuario);
            console.log('📊 Total de campos recibidos:', Object.keys(usuario).length);
            console.log('📌 Campos con datos:', Object.entries(usuario).filter(([k, v]) => v !== null && v !== "").map(([k, v]) => k).join(', '));

            // AUTO-LLENAR FORMULARIO
            const form = document.getElementById('formAfiliado');
            if (!form) {
              console.error('❌ ERROR: Formulario #formAfiliado no encontrado');
              alert('Error: No se pudo cargar el formulario. Refresque la página.');
              return;
            }

            console.log('📋 Formulario encontrado, llenando campos...');

            let camposLlenados = 0;

            // Función auxiliar para setear valor con validación
            const setFieldValue = (fieldId, value) => {
              const field = form.querySelector(`#${fieldId}`);
              if (field && value !== null && value !== undefined) {
                field.value = value;
                camposLlenados++;
                console.log(`✓ ${fieldId} = ${value}`);
              } else if (!field) {
                console.warn(`⚠️ Campo #${fieldId} no encontrado en el formulario`);
              } else {
                console.log(`⊘ ${fieldId} = ${value} (valor vacío, no se asigna)`);
              }
            };

            // Datos de identificación
            setFieldValue('tipoId', usuario.tipoId);
            setFieldValue('numeroId', usuario.numeroId);

            // Nombres
            setFieldValue('primerNombre', usuario.primerNombre);
            setFieldValue('segundoNombre', usuario.segundoNombre);
            setFieldValue('primerApellido', usuario.primerApellido);
            setFieldValue('segundoApellido', usuario.segundoApellido);

            // Datos demográficos
            setFieldValue('sexoBiologico', usuario.sexoBiologico);
            setFieldValue('sexoIdentificacion', usuario.sexoIdentificacion);
            setFieldValue('nacionalidad', usuario.nacionalidad);
            setFieldValue('fechaNacimiento', usuario.fechaNacimiento);

            // Lugar de nacimiento
            setFieldValue('paisNacimiento', usuario.paisNacimiento);
            setFieldValue('departamentoNacimiento', usuario.departamentoNacimiento);
            setFieldValue('municipioNacimiento', usuario.municipioNacimiento);

            // Lugar de residencia
            setFieldValue('paisResidencia', usuario.paisResidencia);
            setFieldValue('departamentoResidencia', usuario.departamentoResidencia);
            setFieldValue('municipioResidencia', usuario.municipioResidencia);

            // Contacto
            setFieldValue('direccion', usuario.direccion);
            setFieldValue('telefonoCelular', usuario.telefonoCelular);
            setFieldValue('telefonoFijo', usuario.telefonoFijo);
            setFieldValue('correoElectronico', usuario.correoElectronico);
            setFieldValue('comunaBarrio', usuario.comunaBarrio);

            // Seguridad Social
            setFieldValue('afpNombre', usuario.afpNombre);
            setFieldValue('epsNombre', usuario.epsNombre);
            setFieldValue('arlNombre', usuario.arlNombre);
            setFieldValue('ccfNombre', usuario.ccfNombre);

            // Datos laborales
            setFieldValue('ibc', usuario.ibc);
            setFieldValue('fechaIngreso', usuario.fechaIngreso);
            setFieldValue('cargo', usuario.cargo);
            setFieldValue('tipo_contrato', usuario.tipo_contrato);

            // Empresa
            if (usuario.empresa_nit) {
              setFieldValue('administracion', usuario.empresa_nit);
            }

            console.log(`✅ Formulario auto-llenado: ${camposLlenados} campos con valores de ${Object.keys(usuario).length} totales`);
            console.log(`📊 Resumen: ${camposLlenados} campos llenados exitosamente`);

            // ============================================================
            // GESTIÓN DE PDF (Cédula/Documento)
            // ============================================================
            const documentoPdfInput = form.querySelector('#documentoPdf');

            if (usuario.pdf_path || usuario.documento_pdf || usuario.documento_url || usuario.ruta_pdf) {
              const pdfUrl = usuario.pdf_path || usuario.documento_pdf || usuario.documento_url || usuario.ruta_pdf;
              const pdfFileName = pdfUrl.split('/').pop();

              if (documentoPdfInput) {
                const pdfContainer = documentoPdfInput.parentElement;

                // Ocultar el input file original
                documentoPdfInput.style.display = 'none';

                // Crear contenedor de gestión de PDF
                const pdfAlert = document.createElement('div');
                pdfAlert.className = 'alert alert-secondary d-flex justify-content-between align-items-center mb-3';
                pdfAlert.id = 'pdfActualContainer';
                pdfAlert.innerHTML = `
                                <span>📄 <strong>Documento Actual Cargado:</strong> ${pdfFileName}</span>
                                <div>
                                    <a href="${pdfUrl}" target="_blank" class="btn btn-sm btn-info me-2">
                                        👁️ Ver PDF
                                    </a>
                                    <button type="button" class="btn btn-sm btn-warning" onclick="habilitarCargaNuevaPDF()">
                                        🔄 Actualizar Documento
                                    </button>
                                </div>
                            `;

                pdfContainer.appendChild(pdfAlert);
                console.log('✅ Gestión de PDF configurada correctamente');
              }
            }

            // Función global para habilitar carga de nuevo PDF
            window.habilitarCargaNuevaPDF = function () {
              const input = document.getElementById('documentoPdf');
              const container = document.getElementById('pdfActualContainer');

              if (input) {
                input.style.display = 'block';
                input.focus();
              }
              if (container) {
                container.innerHTML = `
                                <div class="alert alert-warning">
                                    ⚠️ Selecciona un nuevo archivo PDF para reemplazar el documento actual
                                </div>
                            `;
              }
            };

            // CAMBIAR ACCIÓN DEL FORMULARIO A PUT (UPDATE)
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
              submitButton.innerHTML = '<i class="feather icon-save me-2"></i>Actualizar Usuario';

              // Modificar el submit para usar PUT en lugar de POST
              form.addEventListener('submit', async function (e) {
                e.preventDefault();

                const formData = new FormData(form);
                const data = Object.fromEntries(formData);

                try {
                  const updateResponse = await fetch(`/api/usuarios/${editId}`, {
                    method: 'PUT',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                  });

                  if (updateResponse.ok) {
                    alert('✅ Usuario actualizado exitosamente');
                    window.close(); // Cerrar pestaña si fue abierta desde tabla
                  } else {
                    const error = await updateResponse.json();
                    alert(`❌ Error al actualizar: ${error.message || 'Error desconocido'}`);
                  }
                } catch (error) {
                  console.error('Error al actualizar usuario:', error);
                  alert('❌ Error de conexión al actualizar usuario');
                }
              }, { once: true }); // Solo agregar listener una vez
            }

          } catch (error) {
            console.error('❌ Error al cargar usuario para edición:', error);
            alert(`❌ No se pudo cargar el usuario con ID: ${editId}\n\n${error.message}`);

            // Limpiar parámetro de URL
            window.history.replaceState({}, document.title, window.location.pathname);
          }
        }
        // ========================================================================

        // --- LÓGICA DE LOGOUT AÑADIDA (de index.html) ---
        async function handleLogout() {
          try {
            console.log('🚪 Intentando logout...');
            const response = await fetch('/api/logout', {
              method: 'POST',
              headers: { 'Accept': 'application/json' },
              credentials: 'include'
            });

            console.log('📡 Respuesta logout:', response.status);
            const result = await response.json();
            console.log('📦 Resultado logout:', result);

            if (response.ok) {
              console.log('✅ Logout exitoso');
              sessionStorage.removeItem('userName');
              window.location.href = '/login';
            } else {
              console.error('❌ Error al hacer logout:', result.error);
              alert('Error al cerrar sesión: ' + (result.error || 'Error desconocido'));
              sessionStorage.removeItem('userName');
              window.location.href = '/login';
            }
          } catch (error) {
            console.error('❌ Error de red al hacer logout:', error);
            alert('Error de conexión al cerrar sesión.');
            sessionStorage.removeItem('userName');
            window.location.href = '/login';
          }
        }

        // Asignar evento a los botones de logout
        const logoutButton1 = document.getElementById('logoutButton');
        const logoutButton2 = document.getElementById('logoutButton2');
        if (logoutButton1) logoutButton1.addEventListener('click', handleLogout);
        if (logoutButton2) logoutButton2.addEventListener('click', handleLogout);

        // --- FIN DE LÓGICA DE LOGOUT ---


        // --- Mostrar Nombre de Usuario (leído desde sessionStorage) ---
        const storedUserName = sessionStorage.getItem('userName');
        const userNameDisplay = document.getElementById('userNameDisplay');
        if (userNameDisplay && storedUserName) {
          userNameDisplay.textContent = storedUserName;
        }


        // Inicializar firma
        if (canvas) {
          signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(255, 255, 255)',
            minWidth: 1,
            maxWidth: 2,
          });
          const clearButton = document.getElementById('clear-signature');
          if (clearButton) clearButton.addEventListener('click', () => signaturePad.clear());
          window.addEventListener('resize', resizeCanvas);
          resizeCanvas(); // Ajustar tamaño inicial
        } else {
          console.error("Elemento canvas 'signature-pad' no encontrado.");
        }

        // Botón de llenar prueba
        const btnPrueba = document.getElementById('btnLlenarPrueba');
        if (btnPrueba) btnPrueba.addEventListener('click', llenarDatosDePrueba);

        // Lógica de beneficiarios
        setupBeneficiaryLogic();

        // Inicializar iconos Feather
        initializeFeatherIcons();

        {% include '_theme_config.html' %}
      });
  </script>

  <!-- SweetAlert2 y SignaturePad -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

  <script>
      // 1. POLYFILLS (Evita errores del tema visual)
      const noop = () => { };
      ['main_layout_change', 'layout_change', 'layout_theme_sidebar_change',
        'change_box_container', 'layout_caption_change', 'layout_rtl_change', 'preset_change']
        .forEach(fn => window[fn] = window[fn] || noop);

      document.addEventListener('DOMContentLoaded', function () {

        // 2. CONFIGURACIÓN DE FIRMA
        const canvas = document.querySelector("canvas");
        let signaturePad;

        if (canvas) {
          signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });
          window.addEventListener("resize", function () {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
          });
          document.getElementById('clear-signature')?.addEventListener('click', (e) => {
            e.preventDefault(); signaturePad.clear();
          });
        }

        // 3. FUNCIÓN: USUARIO DE PRUEBA (El "Botón Mágico")
        window.llenarDatosDePrueba = function () {
          // Llena los campos con datos aleatorios válidos
          const randomId = Math.floor(Math.random() * 90000000) + 10000000;

          const sets = {
            // Nombres en camelCase (como están en el HTML)
            'primerNombre': 'Usuario',
            'segundoNombre': 'Prueba',
            'primerApellido': 'Test',
            'segundoApellido': 'Sistema',
            'tipoId': 'Cédula de Ciudadanía',
            'numeroId': randomId.toString(),
            'correoElectronico': `prueba${randomId}@empresa.com`,
            'telefonoCelular': '300' + Math.floor(Math.random() * 10000000),
            'telefonoFijo': '6012345678',
            'sexoBiologico': 'Masculino',
            'sexoIdentificacion': 'Masculino',
            'nacionalidad': 'Colombiana',
            'fechaNacimiento': '1990-01-15',
            'paisNacimiento': 'Colombia',
            'departamentoNacimiento': 'Valle del Cauca',
            'municipioNacimiento': 'Cali',
            'direccion': 'Calle 123 #45-67',
            'comunaBarrio': 'San Fernando',
            'afpNombre': 'PORVENIR',
            'epsNombre': 'SURA',
            'arlNombre': 'POSITIVA',
            'administracion': 'MONTERO ADMINISTRADORA S.A.S',
            'empresa_nit': '999999999', // NIT de MONTERO ADMINISTRADORA (empresa por defecto)
            'ibc': '1300000',
            'fechaIngreso': new Date().toISOString().split('T')[0]
          };

          console.log('🎯 Llenando datos de prueba...');

          // Recorrer inputs y llenar si coinciden
          let camposLlenados = 0;
          for (const [name, value] of Object.entries(sets)) {
            const input = document.querySelector(`[name="${name}"]`) || document.getElementById(name);
            if (input) {
              input.value = value;
              camposLlenados++;
              console.log(`✅ Campo ${name} = ${value}`);
            } else {
              console.warn(`⚠️ Campo ${name} no encontrado`);
            }
          }

          console.log(`📋 Total campos llenados: ${camposLlenados}`);

          // Firmar automáticamente
          if (signaturePad) {
            signaturePad.clear();
            const ctx = canvas.getContext("2d");
            ctx.font = "30px Arial";
            ctx.fillText("Firma Prueba", 10, 50);
            console.log('✍️ Firma agregada');
          }

          Swal.fire({
            title: 'Datos de Prueba Cargados',
            text: `${camposLlenados} campos llenados. ¡Listo para guardar!`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          });
        };

        // Conectar el botón si existe en el HTML
        const btnPrueba = document.getElementById('btnLlenarPrueba');
        if (btnPrueba) btnPrueba.addEventListener('click', window.llenarDatosDePrueba);


        // 4. ENVÍO DEL FORMULARIO
        const form = document.getElementById('formAfiliado');
        if (form) {
          form.addEventListener('submit', async function (e) {
            e.preventDefault();
            e.stopPropagation();

            // A. Capturar Firma
            let firmaBase64 = null;
            if (signaturePad && !signaturePad.isEmpty()) {
              firmaBase64 = signaturePad.toDataURL('image/png');
            }

            const formData = new FormData(this);
            const raw = Object.fromEntries(formData.entries());

            // B. --- TRADUCCIÓN (HTML -> BASE DE DATOS) ---
            // Construir nombre completo
            const nombreCompleto = [
              raw.primerNombre || '',
              raw.segundoNombre || '',
              raw.primerApellido || '',
              raw.segundoApellido || ''
            ].filter(n => n.trim()).join(' ');

            const mappedData = {
              nombre_completo: nombreCompleto,
              email: raw.correoElectronico || raw.email || raw.correo || null,
              tipo_documento: raw.tipoId || raw.tipo_documento || 'CC',
              numero_documento: raw.numeroId || raw.numero_documento || raw.cedula,
              telefono: raw.telefonoCelular || raw.telefono || raw.celular || null,
              cargo: raw.cargo || null,
              empresa_nit: raw.empresa_nit || raw.empresa || '999999999', // NIT de MONTERO ADMINISTRADORA por defecto
              firma_digital: firmaBase64 || null
            };

            // Validación básica
            if (!mappedData.nombre_completo || !mappedData.numero_documento) {
              Swal.fire('Atención', 'Nombre y número de documento son obligatorios', 'warning');
              return;
            }

            console.log("📤 Enviando Usuario:", mappedData);
            Swal.fire({ title: 'Guardando...', didOpen: () => Swal.showLoading() });

            try {
              const response = await fetch(this.action, {
                method: 'POST',
                body: JSON.stringify(mappedData),
                headers: {
                  'Content-Type': 'application/json',
                  'Accept': 'application/json',
                  // CSRF Token Robustez
                  'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || '{{ csrf_token() }}'
                }
              });

              const data = await response.json();

              if (response.ok) {
                Swal.fire({
                  title: '¡Usuario Creado!',
                  text: 'Registro exitoso.',
                  icon: 'success',
                  confirmButtonText: 'Aceptar'
                }).then(() => {
                  window.location.reload();
                });
              } else {
                console.warn("Error Backend:", data);
                let msg = data.error || 'Revisa los datos';
                let icon = 'warning';

                // Manejo específico de errores
                if (response.status === 409) {
                  msg = 'El usuario ya existe. Prueba con otro número de documento.';
                  icon = 'info';
                } else if (Array.isArray(data)) {
                  msg = "Campos inválidos: " + data.map(e => e.loc[0]).join(", ");
                } else if (data.details) {
                  msg = data.details.map(d => `${d.field}: ${d.message}`).join('\n');
                }

                Swal.fire('Atención', msg, icon);
              }
            } catch (err) {
              console.error("Error:", err);
              Swal.fire('Error', 'Fallo de conexión.', 'error');
            }
          });
        }
      });
  </script>

</body>

</html>