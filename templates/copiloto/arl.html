<!doctype html>
<html lang="es" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
<head>
    <title>Copiloto ARL | Sistema Montero</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <link rel="icon" href="/assets/images/favicon.svg" type="image/x-icon" />

    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/fonts/phosphor/duotone/style.css" />
    <link rel="stylesheet" href="/assets/fonts/tabler-icons.min.css" />
    <link rel="stylesheet" href="/assets/fonts/feather.css" />
    <link rel="stylesheet" href="/assets/fonts/fontawesome.css" />
    <link rel="stylesheet" href="/assets/fonts/material.css" />
    <link rel="stylesheet" href="/assets/css/style.css" id="main-style-link" />
    <!-- ‚úÖ REDISE√ëO CORPORATIVO ENTERPRISE -->
    <link rel="stylesheet" href="/assets/css/corporate-redesign.css" />
    <link rel="stylesheet" href="/assets/css/style-preset.css" />
</head>

<body>
    <div class="loader-bg">
        <div class="loader-track">
            <div class="loader-fill"></div>
        </div>
    </div>

    {% include '_sidebar.html' ignore missing %}
    {% include '_header.html' ignore missing %}

    <div class="pc-container">
        <div class="pc-content">

            <div class="page-header">
                <div class="page-block">
                    <div class="row align-items-center">
                        <div class="col-md-12">
                            <div class="page-header-title">
                                <h5 class="m-b-10">ü§ñ Copiloto ARL</h5>
                            </div>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                                <li class="breadcrumb-item">Automatizaci√≥n</li>
                                <li class="breadcrumb-item">Gesti√≥n ARL</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-xl-8 col-md-10 mx-auto">
                    <div class="card shadow-sm border-0">
                        <div class="card-header d-flex align-items-center justify-content-between bg-dark text-white">
                            <h5 class="mb-0 text-white"><i class="feather icon-cpu me-2"></i>Panel de Control RPA</h5>
                            <span class="badge bg-success text-white border-0">Online</span>
                        </div>
                        <div class="card-body">
                            <form id="form-rpa">

                                <div class="p-3 mb-4 bg-light rounded border">
                                    <h6 class="mb-3 text-primary fw-bold"><i class="feather icon-search me-2"></i>1. Buscar Empleado</h6>
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-5">
                                            <label class="form-label fw-bold">N√∫mero de C√©dula</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" name="numero_documento" id="numero_documento" placeholder="Ej: 10203040" required autofocus>
                                                <button class="btn btn-primary" type="button" id="btn-buscar-empleado">
                                                    <i class="feather icon-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-7">
                                            <label class="form-label fw-bold">Nombre del Empleado</label>
                                            <input type="text" class="form-control bg-white fw-bold text-success" id="nombre_empleado_visible" readonly placeholder="---">
                                            <input type="hidden" name="empleado_nombre" id="empleado_nombre">
                                            <input type="hidden" name="empleado_id" id="empleado_id">
                                        </div>
                                    </div>
                                </div>

                                <div class="p-3 mb-4 bg-light rounded border">
                                    <h6 class="mb-3 text-primary fw-bold"><i class="feather icon-briefcase me-2"></i>2. Datos de Empresa</h6>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">NIT Empresa</label>
                                            <input type="text" class="form-control" name="empresa_nit" id="empresa_nit" placeholder="NIT" required>
                                            <small class="text-muted">Editable si es necesario</small>
                                        </div>
                                        <div class="col-md-8">
                                            <label class="form-label fw-bold">Raz√≥n Social</label>
                                            <input type="text" class="form-control bg-white" id="empresa_nombre_visible" readonly placeholder="---">
                                            <input type="hidden" name="empresa_nombre" id="empresa_nombre">
                                        </div>
                                    </div>
                                </div>

                                <h6 class="mb-3 text-muted text-uppercase fw-bold text-center">3. Seleccione la Misi√≥n</h6>
                                <div class="form-group mb-4">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <input type="radio" class="btn-check" name="accion" id="accion1" value="afiliar" required>
                                            <label class="btn btn-outline-secondary w-100 p-3 text-center h-100 d-flex flex-column justify-content-center align-items-center" for="accion1">
                                                <i class="feather icon-user-plus f-24 mb-2 text-primary"></i>
                                                <span class="fw-bold">Afiliar</span>
                                            </label>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="radio" class="btn-check" name="accion" id="accion2" value="certificado">
                                            <label class="btn btn-outline-secondary w-100 p-3 text-center h-100 d-flex flex-column justify-content-center align-items-center" for="accion2">
                                                <i class="feather icon-file-text f-24 mb-2 text-warning"></i>
                                                <span class="fw-bold">Certificado</span>
                                            </label>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="radio" class="btn-check" name="accion" id="accion3" value="incapacidad">
                                            <label class="btn btn-outline-secondary w-100 p-3 text-center h-100 d-flex flex-column justify-content-center align-items-center" for="accion3">
                                                <i class="feather icon-activity f-24 mb-2 text-danger"></i>
                                                <span class="fw-bold">Incapidad</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-grid">
                                    <button type="submit" class="btn btn-dark btn-lg shadow-lg">
                                        <i class="feather icon-play me-2"></i> EJECUTAR COPILOTO
                                    </button>
                                </div>

                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include '_footer.html' ignore missing %}

    <script src="/assets/js/plugins/simplebar.min.js"></script>
    <script src="/assets/js/plugins/popper.min.js"></script>
    <script src="/assets/js/icon/custom-icon.js"></script>
    <script src="/assets/js/plugins/feather.min.js"></script>
    <script src="/assets/js/component.js"></script>
    <script src="/assets/js/theme.js"></script>
    <script>
        // Polyfills para tema (Ejecutar ANTES de script.js)
        window.layout_change = window.layout_change || function() {};
        window.layout_theme_sidebar_change = window.layout_theme_sidebar_change || function() {};
        window.change_box_container = window.change_box_container || function() {};
        window.layout_caption_change = window.layout_caption_change || function() {};
        window.layout_rtl_change = window.layout_rtl_change || function() {};
        window.preset_change = window.preset_change || function() {};
        window.main_layout_change = window.main_layout_change || function() {};
    </script>
    <script src="/assets/js/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    {% include '_theme_config.html' ignore missing %}

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar iconos y tema
        if (typeof feather !== 'undefined') feather.replace();
        const safeCall = (fn, arg) => { if(typeof window[fn] === 'function') window[fn](arg); };
        safeCall('layout_theme_sidebar_change', 'dark');

        // Referencias DOM
        const btnBuscar = document.getElementById('btn-buscar-empleado');
        const inputCedula = document.getElementById('numero_documento');

        // Inputs Empleado
        const inEmpNombreVis = document.getElementById('nombre_empleado_visible');
        const inEmpNombreHid = document.getElementById('empleado_nombre');
        const inEmpIdHid = document.getElementById('empleado_id');

        // Inputs Empresa
        const inEmpresaNit = document.getElementById('empresa_nit');
        const inEmpresaNombreVis = document.getElementById('empresa_nombre_visible');
        const inEmpresaNombreHid = document.getElementById('empresa_nombre');

        // --- L√ìGICA DE B√öSQUEDA ---
        async function buscarEmpleado() {
            const cedula = inputCedula.value.trim();
            if(!cedula) return Swal.fire('Campo Vac√≠o', 'Por favor ingrese un n√∫mero de c√©dula.', 'warning');

            const originalIcon = btnBuscar.innerHTML;
            btnBuscar.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btnBuscar.disabled = true;

            try {
                const response = await fetch(`/copiloto/api/empleado/buscar/${cedula}`);
                const data = await response.json();

                if (response.ok) {
                    // 1. Llenar datos de Empleado
                    inEmpNombreVis.value = data.nombre;
                    inEmpNombreHid.value = data.nombre;
                    inEmpIdHid.value = cedula;

                    // 2. Llenar datos de Empresa (si existen)
                    if(data.empresa_nit) {
                        inEmpresaNit.value = data.empresa_nit;
                        inEmpresaNombreVis.value = data.empresa_nombre;
                        inEmpresaNombreHid.value = data.empresa_nombre;

                        const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true});
                        Toast.fire({icon: 'success', title: 'Datos encontrados correctamente'});
                    } else {
                        // Empleado sin empresa: Limpiar campos empresa para llenado manual
                        inEmpresaNit.value = '';
                        inEmpresaNombreVis.value = '---';
                        Swal.fire('Atenci√≥n', 'Empleado encontrado, pero no tiene empresa asignada. Ingrese el NIT manualmente.', 'info');
                    }
                } else {
                    // No encontrado
                    limpiarCampos();
                    Swal.fire('No encontrado', 'No existe ning√∫n empleado con esa c√©dula.', 'error');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('Error de Conexi√≥n', 'No se pudo conectar con la base de datos.', 'error');
            } finally {
                btnBuscar.innerHTML = originalIcon;
                btnBuscar.disabled = false;
            }
        }

        function limpiarCampos() {
            inEmpNombreVis.value = ''; inEmpNombreHid.value = ''; inEmpIdHid.value = '';
            inEmpresaNit.value = ''; inEmpresaNombreVis.value = ''; inEmpresaNombreHid.value = '';
        }

        // Eventos B√∫squeda
        btnBuscar.addEventListener('click', buscarEmpleado);
        inputCedula.addEventListener('keypress', (e) => { if(e.key === 'Enter') { e.preventDefault(); buscarEmpleado(); } });

        // --- ENV√çO AL ROBOT ---
        document.getElementById('form-rpa').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const payload = Object.fromEntries(formData.entries());

            // Validaciones b√°sicas
            if(!payload.empleado_nombre) return Swal.fire('Falta Empleado', 'Busque al empleado antes de iniciar.', 'warning');
            if(!payload.empresa_nit) return Swal.fire('Falta Empresa', 'El campo NIT de Empresa es obligatorio.', 'warning');

            Swal.fire({
                title: 'Iniciando Misi√≥n...',
                html: 'Conectando con el portal ARL<br><b>Por favor espere...</b>',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await fetch('/copiloto/api/ejecutar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if(response.ok) {
                    Swal.fire({
                        title: '¬°Misi√≥n Iniciada!',
                        html: `<div class="text-start">
                               <p><b>Job ID:</b> ${result.job_id}</p>
                               <p>El robot est√° trabajando en segundo plano.</p>
                               </div>`,
                        icon: 'success'
                    });
                } else {
                    Swal.fire('Error del Robot', result.error || 'No se pudo iniciar la tarea.', 'error');
                }
            } catch (error) {
                Swal.fire('Error Cr√≠tico', 'Fallo de comunicaci√≥n con el servidor.', 'error');
            }
        });
    });
    </script>
</body>
</html>
