<!doctype html>
<html lang="es" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
<head>
    <meta charset="utf-8" />
    <title>Auditoría y Logs del Sistema | Portal Montero</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="icon" href="/assets/images/favicon.svg" type="image/x-icon" />

    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/fonts/phosphor/duotone/style.css" />
    <link rel="stylesheet" href="/assets/fonts/tabler-icons.min.css" />
    <link rel="stylesheet" href="/assets/fonts/feather.css" />
    <link rel="stylesheet" href="/assets/fonts/fontawesome.css" />
    <link rel="stylesheet" href="/assets/fonts/material.css" />
    <link rel="stylesheet" href="/assets/css/style.css" id="main-style-link" />

    <style>
        .log-table {
            font-size: 0.875rem;
        }
        .log-table td {
            padding: 8px;
            vertical-align: middle;
        }
        .log-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            padding: 10px 8px;
        }
        .badge-log {
            font-size: 0.75rem;
            padding: 4px 8px;
            font-weight: 500;
        }
        .log-details {
            color: #6c757d;
            font-size: 0.8rem;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .log-ip {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="loader-bg fixed inset-0 bg-white dark:bg-themedark-cardbg z-[1034]">
        <div class="loader-track h-[5px] w-full inline-block absolute overflow-hidden top-0">
            <div class="loader-fill w-[300px] h-[5px] bg-primary-500 absolute top-0 left-0 animate-[hitZak_0.6s_ease-in-out_infinite_alternate]"></div>
        </div>
    </div>

    {% include '_sidebar.html' %}
    {% include '_header.html' %}

    <div class="pc-container">
        <div class="pc-content">
            <div class="page-header">
                <div class="page-block">
                    <div class="page-header-title">
                        <h5 class="mb-0 font-medium">Auditoría y Logs del Sistema</h5>
                    </div>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/dashboard">Home</a></li>
                        <li class="breadcrumb-item"><a href="#">Administración</a></li>
                        <li class="breadcrumb-item" aria-current="page">Auditoría</li>
                    </ul>
                </div>
            </div>

            <!-- Sección de Filtros -->
            <div class="filter-section">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="filterAccion" class="form-label"><i data-feather="filter" class="w-4 h-4 inline mr-1"></i>Filtrar por Acción</label>
                        <input type="text" class="form-control form-control-sm" id="filterAccion" placeholder="Ej: Login, Subir Archivo...">
                    </div>
                    <div class="col-md-3">
                        <label for="filterUsuario" class="form-label"><i data-feather="user" class="w-4 h-4 inline mr-1"></i>Filtrar por Usuario</label>
                        <input type="text" class="form-control form-control-sm" id="filterUsuario" placeholder="Nombre de usuario...">
                    </div>
                    <div class="col-md-2">
                        <label for="filterLimit" class="form-label"><i data-feather="list" class="w-4 h-4 inline mr-1"></i>Cantidad</label>
                        <select class="form-select form-select-sm" id="filterLimit">
                            <option value="50">50 logs</option>
                            <option value="100" selected>100 logs</option>
                            <option value="200">200 logs</option>
                            <option value="500">500 logs</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-primary btn-sm me-2" id="btnApplyFilters">
                            <i data-feather="search" class="w-4 h-4 inline mr-1"></i> Buscar
                        </button>
                        <button class="btn btn-secondary btn-sm" id="btnClearFilters">
                            <i data-feather="x" class="w-4 h-4 inline mr-1"></i> Limpiar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Card de Logs -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5><i data-feather="activity" class="w-5 h-5 inline mr-2"></i>Registros de Auditoría</h5>
                        <div>
                            <span class="badge bg-info" id="logCount">0 logs</span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover log-table mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 5%;">ID</th>
                                    <th style="width: 12%;">Fecha/Hora</th>
                                    <th style="width: 15%;">Usuario</th>
                                    <th style="width: 15%;">Acción</th>
                                    <th style="width: 25%;">Detalle</th>
                                    <th style="width: 8%;">Resultado</th>
                                    <th style="width: 10%;">IP</th>
                                    <th style="width: 10%;">Método</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyLogs">
                                <tr>
                                    <td colspan="8" class="text-center text-muted" style="padding: 40px;">
                                        <i data-feather="loader" class="animate-spin w-5 h-5 inline mr-2"></i>
                                        Cargando registros de auditoría...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer text-muted text-center" style="font-size: 0.875rem;">
                    <i data-feather="info" class="w-4 h-4 inline mr-1"></i>
                    Los logs más recientes se muestran primero
                </div>
            </div>

        </div>
    </div>

    {% include '_footer.html' %}

    <script src="/assets/js/plugins/simplebar.min.js"></script>
    <script src="/assets/js/plugins/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/icon/custom-icon.js"></script>
    <script src="/assets/js/plugins/feather.min.js"></script>
    <script src="/assets/js/component.js"></script>
    <script src="/assets/js/theme.js"></script>
    <script>
        // --- POLYFILLS PARA TEMA (Ejecutar ANTES de script.js) ---
        // Previene errores de ReferenceError cuando script.js intenta llamar estas funciones
        window.layout_change = window.layout_change || function() {};
        window.layout_theme_sidebar_change = window.layout_theme_sidebar_change || function() {};
        window.change_box_container = window.change_box_container || function() {};
        window.layout_caption_change = window.layout_caption_change || function() {};
        window.layout_rtl_change = window.layout_rtl_change || function() {};
        window.preset_change = window.preset_change || function() {};
        window.main_layout_change = window.main_layout_change || function() {};
    </script>

    <script src="/assets/js/script.js"></script>

    {% include '_theme_config.html' %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const API_URL = '/api/auditoria';

            // Referencias a elementos del DOM
            const tbodyLogs = document.getElementById('tbodyLogs');
            const logCount = document.getElementById('logCount');
            const filterAccion = document.getElementById('filterAccion');
            const filterUsuario = document.getElementById('filterUsuario');
            const filterLimit = document.getElementById('filterLimit');
            const btnApplyFilters = document.getElementById('btnApplyFilters');
            const btnClearFilters = document.getElementById('btnClearFilters');

            // --- Función para obtener badge según resultado ---
            function getResultadoBadge(resultado) {
                const badgeMap = {
                    'exito': '<span class="badge bg-success badge-log">Éxito</span>',
                    'error': '<span class="badge bg-danger badge-log">Error</span>',
                    'advertencia': '<span class="badge bg-warning badge-log">Advertencia</span>'
                };
                return badgeMap[resultado] || '<span class="badge bg-secondary badge-log">Desconocido</span>';
            }

            // --- Función para obtener icono según acción ---
            function getAccionIcon(accion) {
                const lowerAccion = accion.toLowerCase();
                if (lowerAccion.includes('login')) return 'log-in';
                if (lowerAccion.includes('logout')) return 'log-out';
                if (lowerAccion.includes('subir') || lowerAccion.includes('upload')) return 'upload';
                if (lowerAccion.includes('eliminar') || lowerAccion.includes('delete')) return 'trash-2';
                if (lowerAccion.includes('descargar') || lowerAccion.includes('download')) return 'download';
                if (lowerAccion.includes('crear') || lowerAccion.includes('crear')) return 'plus-circle';
                if (lowerAccion.includes('actualizar') || lowerAccion.includes('update')) return 'edit';
                if (lowerAccion.includes('acceso') || lowerAccion.includes('deneg')) return 'shield-off';
                return 'activity';
            }

            // --- Función para formatear fecha ---
            function formatFecha(fechaStr) {
                try {
                    const fecha = new Date(fechaStr);
                    const opciones = {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    };
                    return fecha.toLocaleString('es-ES', opciones);
                } catch (e) {
                    return fechaStr;
                }
            }

            // --- Función para obtener badge de método HTTP ---
            function getMetodoBadge(metodo) {
                if (!metodo) return '-';
                const badgeMap = {
                    'GET': 'bg-primary',
                    'POST': 'bg-success',
                    'PUT': 'bg-warning',
                    'DELETE': 'bg-danger',
                    'PATCH': 'bg-info'
                };
                const bgClass = badgeMap[metodo.toUpperCase()] || 'bg-secondary';
                return `<span class="badge ${bgClass} badge-log">${metodo}</span>`;
            }

            // --- Cargar Logs de Auditoría ---
            async function loadLogs(accion = '', usuario = '', limit = 100) {
                try {
                    let url = `${API_URL}?limit=${limit}`;
                    if (accion) url += `&accion=${encodeURIComponent(accion)}`;
                    if (usuario) url += `&usuario=${encodeURIComponent(usuario)}`;

                    const response = await fetch(url, { credentials: 'include' });

                    if (response.status === 403) {
                        tbodyLogs.innerHTML = `
                            <tr>
                                <td colspan="8" class="text-center text-danger" style="padding: 40px;">
                                    <i data-feather="shield-off" class="w-5 h-5 inline mr-2"></i>
                                    <strong>Acceso Denegado:</strong> No tienes permisos para ver los logs de auditoría.
                                    <br><small>Solo administradores pueden acceder a esta sección.</small>
                                </td>
                            </tr>`;
                        feather.replace();
                        return;
                    }

                    if (!response.ok) {
                        throw new Error('Error al cargar logs');
                    }

                    const logs = await response.json();
                    logCount.textContent = `${logs.length} logs`;

                    if (logs.length === 0) {
                        tbodyLogs.innerHTML = `
                            <tr>
                                <td colspan="8" class="text-center text-muted" style="padding: 40px;">
                                    <i data-feather="inbox" class="w-5 h-5 inline mr-2"></i>
                                    No hay registros de auditoría para mostrar.
                                </td>
                            </tr>`;
                    } else {
                        tbodyLogs.innerHTML = logs.map(log => `
                            <tr>
                                <td class="text-muted">#${log.id}</td>
                                <td><small>${formatFecha(log.fecha_hora)}</small></td>
                                <td>
                                    <i data-feather="user" class="w-4 h-4 inline mr-1"></i>
                                    <strong>${log.usuario_nombre || 'Sistema'}</strong>
                                    ${log.usuario_id ? `<br><small class="text-muted">ID: ${log.usuario_id}</small>` : ''}
                                </td>
                                <td>
                                    <i data-feather="${getAccionIcon(log.accion)}" class="w-4 h-4 inline mr-1"></i>
                                    <strong>${log.accion}</strong>
                                </td>
                                <td>
                                    <span class="log-details" title="${log.detalle || 'Sin detalles'}">${log.detalle || '-'}</span>
                                </td>
                                <td>${getResultadoBadge(log.resultado)}</td>
                                <td class="log-ip">${log.ip_address || '-'}</td>
                                <td>
                                    ${getMetodoBadge(log.metodo_http)}
                                    ${log.ruta ? `<br><small class="text-muted" title="${log.ruta}">${log.ruta.substring(0, 15)}...</small>` : ''}
                                </td>
                            </tr>
                        `).join('');
                    }

                    feather.replace();

                } catch (error) {
                    console.error('Error cargando logs:', error);
                    tbodyLogs.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-danger" style="padding: 40px;">
                                <i data-feather="alert-circle" class="w-5 h-5 inline mr-2"></i>
                                Error al cargar los registros de auditoría.
                                <br><small>${error.message}</small>
                            </td>
                        </tr>`;
                    feather.replace();
                }
            }

            // --- Aplicar Filtros ---
            btnApplyFilters.addEventListener('click', () => {
                const accion = filterAccion.value.trim();
                const usuario = filterUsuario.value.trim();
                const limit = parseInt(filterLimit.value);
                loadLogs(accion, usuario, limit);
            });

            // --- Limpiar Filtros ---
            btnClearFilters.addEventListener('click', () => {
                filterAccion.value = '';
                filterUsuario.value = '';
                filterLimit.value = '100';
                loadLogs();
            });

            // --- Búsqueda al presionar Enter ---
            filterAccion.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') btnApplyFilters.click();
            });

            filterUsuario.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') btnApplyFilters.click();
            });

            // --- Carga Inicial ---
            loadLogs();
            feather.replace();
        });
    </script>
</body>
</html>
