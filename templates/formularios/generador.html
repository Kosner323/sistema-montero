<!doctype html>
<html lang="en" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
  <head>
    <title>Generador de Formularios PDF | Montero y Negocio</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="Generador de formularios PDF con datos de empleados" />
    <meta name="author" content="Montero y Negocio" />

    <link rel="icon" href="/assets/images/favicon.svg" type="image/x-icon" />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/fonts/phosphor/duotone/style.css" />
    <link rel="stylesheet" href="/assets/fonts/tabler-icons.min.css" />
    <link rel="stylesheet" href="/assets/fonts/feather.css" />
    <link rel="stylesheet" href="/assets/fonts/fontawesome.css" />
    <link rel="stylesheet" href="/assets/fonts/material.css" />
    <link rel="stylesheet" href="/assets/css/style.css" id="main-style-link" />

    <style>
        .page-title {
            color: #3f51b5;
            font-weight: 600;
        }
        .form-section-title {
            font-size: 1.1em;
            color: #555;
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        .btn-primary {
            background-color: #3f51b5;
            border-color: #3f51b5;
        }
        .btn-primary:hover {
            background-color: #303f9f;
            border-color: #303f9f;
        }
        .nav-link.active {
            background-color: #3f51b5 !important;
            color: white !important;
        }
        #feedbackMessageFormularios {
            margin-top: 15px;
            font-size: 0.9em;
        }
        select:disabled {
            background-color: #e9ecef;
            opacity: 1;
            cursor: not-allowed;
        }
        input[readonly] {
            background-color: #e9ecef;
            opacity: 1;
        }
        .loading-placeholder td {
            color: #999;
            font-style: italic;
        }
        .error-placeholder td {
             color: #dc3545;
             font-weight: bold;
        }
    </style>
  </head>
  <body>
    <div class="loader-bg fixed inset-0 bg-white dark:bg-themedark-cardbg z-[1034]">
        <div class="loader-track h-[5px] w-full inline-block absolute overflow-hidden top-0">
            <div class="loader-fill w-[300px] h-[5px] bg-primary-500 absolute top-0 left-0 animate-[hitZak_0.6s_ease-in-out_infinite_alternate]"></div>
        </div>
    </div>

    {% include '_sidebar.html' %}
    {% include '_header.html' %}

    <div class="pc-container">
      <div class="pc-content">
        <div class="page-header">
          <div class="page-block">
            <div class="row align-items-center">
              <div class="col-md-12">
                <ul class="breadcrumb mb-3">
                  <li class="breadcrumb-item"><a href="/dashboard">Home</a></li>
                  <li class="breadcrumb-item"><a href="/formularios">Gestor de Afiliaciones</a></li>
                  <li class="breadcrumb-item" aria-current="page">Generador de PDF</li>
                </ul>
              </div>
              <div class="col-md-12">
                <div class="page-header-title">
                  <h2 class="mb-0">Generador de Formularios PDF</h2>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="feedbackMessageFormularios" class="mb-4"></div>

        <div class="row">
            <div class="col-xl-12">

                <div class="card" id="cardGeneracion">
                    <div class="card-body">
                        <h5>Generar Formulario Rellenado</h5>
                        <p>Seleccione el formulario, ingrese el ID del empleado para buscarlo, y seleccione la empresa.</p>

                        <form id="formGeneracion">
                            <input type="hidden" id="hiddenUsuarioId" name="usuario_id">

                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label for="selectFormulario" class="form-label">1. Seleccionar Formulario Importado</label>
                                    <select class="form-select" id="selectFormulario" required>
                                        <option value="">Cargando formularios...</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row g-3 mt-3">
                                <div class="col-md-12">
                                    <label for="selectEmpresa" class="form-label">2. Seleccionar Empresa</label>
                                    <select class="form-select" id="selectEmpresa" required>
                                        <option value="">Cargando empresas...</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row g-3 mt-3">
                                <div class="col-md-6">
                                    <label for="selectTipoIdUsuario" class="form-label">3. Seleccionar Tipo ID Usuario</label>
                                    <select class="form-select" id="selectTipoIdUsuario" required>
                                        <option value="">Seleccione...</option>
                                        <option value="Cédula de Ciudadanía">Cédula de Ciudadanía</option>
                                        <option value="Cédula de Extranjería">Cédula de Extranjería</option>
                                        <option value="Permiso Temporal">Permiso Temporal</option>
                                        <option value="Pasaporte">Pasaporte</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="inputNumeroIdUsuario" class="form-label">4. Ingresar Número ID Usuario</label>
                                    <input type="text" class="form-control" id="inputNumeroIdUsuario" placeholder="Ingrese el número y presione Enter o cambie campo" required>
                                </div>
                            </div>

                            <div class="row g-3 mt-3">
                                <div class="col-md-12">
                                    <label for="inputUsuarioSeleccionado" class="form-label">5. Empleado/Usuario Encontrado</label>
                                    <input type="text" class="form-control" id="inputUsuarioSeleccionado" readonly placeholder="Esperando búsqueda por ID...">
                                </div>
                            </div>

                            <div class="mt-4 d-flex gap-3">
                                <button type="submit" class="btn btn-primary" id="btnGenerar">
                                    <i class="ph-duotone ph-file-pdf me-2"></i> Generar y Descargar PDF
                                </button>
                                <button type="button" class="btn btn-success" id="btnImportarNuevo">
                                    <i class="ph-duotone ph-file-plus me-2"></i> Importar/Gestionar PDF
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card mt-4 d-none" id="cardHistorial">
                    <div class="card-header">
                        <h5>Historial Reciente de Documentos Generados</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered text-sm whitespace-nowrap" id="tablaHistorial">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Formulario</th>
                                        <th>Empresa</th>
                                        <th>Usuario (ID)</th>
                                        <th>Archivo Generado</th>
                                        <th>Fecha Generación</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="7" class="text-center text-muted">Funcionalidad de historial pendiente.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="importacion-view" class="d-none">
                    <div class="mb-4">
                        <button type="button" class="btn btn-link px-0 text-muted" onclick="showGenerationView()">
                            <i class="ti ti-arrow-left me-2"></i> Volver a Generación de Formularios
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <ul class="nav nav-tabs mb-4" id="importTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-pane" type="button" role="tab" aria-controls="upload-pane" aria-selected="true">
                                        <i class="ti ti-cloud-upload me-2"></i> Cargar Nuevo PDF
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-pane" type="button" role="tab" aria-controls="list-pane" aria-selected="false">
                                        <i class="ti ti-list-details me-2"></i> Listado de Formularios Importados
                                    </button>
                                </li>
                            </ul>
                            <div class="tab-content" id="importTabsContent">
                                <div class="tab-pane fade show active" id="upload-pane" role="tabpanel" aria-labelledby="upload-tab" tabindex="0">
                                    <h5 class="mb-3">Cargar Nuevo PDF Rellenable</h5>
                                    <p>Cargue un archivo PDF que contenga campos rellenables (Formularios AcroForm) para poder utilizarlo en la generación automática.</p>
                                    <form id="formImportacion" enctype="multipart/form-data">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="nombreFormulario" class="form-label">Nombre del Formulario</label>
                                                <input type="text" class="form-control" id="nombreFormulario" name="nombre" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="archivoPdf" class="form-label">Archivo PDF (Max 10MB)</label>
                                                <input class="form-control" type="file" id="archivoPdf" name="archivo" accept=".pdf" required>
                                            </div>
                                        </div>
                                        <div class="mt-4 text-end">
                                            <button type="submit" class="btn btn-success" id="btnImportar">
                                                <i class="ph-duotone ph-cloud-arrow-up me-2"></i> Importar y Analizar Campos
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                <div class="tab-pane fade" id="list-pane" role="tabpanel" aria-labelledby="list-tab" tabindex="0">
                                    <div class="card-header border-0 bg-transparent px-0 pb-0 d-flex justify-content-between align-items-center">
                                         <h5 class="mb-0">Formularios Importados</h5>
                                         <button class="btn btn-sm btn-outline-secondary" onclick="loadFormulariosImportados(true)"><i data-feather="refresh-cw" class="me-1"></i> Recargar Lista</button>
                                    </div>
                                    <div class="table-responsive mt-3">
                                        <table class="table table-hover table-bordered text-sm whitespace-nowrap" id="tablaFormulariosImportados">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Nombre</th>
                                                    <th>Archivo Original</th>
                                                    <th>Campos Detectados</th>
                                                    <th>Fecha Importación</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr class="loading-placeholder"><td colspan="6" class="text-center text-muted">Cargando...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

      </div>
    </div>

    {% include '_footer.html' %}

    <script src="/assets/js/plugins/simplebar.min.js"></script>
    <script src="/assets/js/plugins/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/plugins/feather.min.js"></script>
    <script src="/assets/js/component.js"></script>
    <script src="/assets/js/theme.js"></script>

    <script>
        // Polyfills para tema
        window.layout_change = window.layout_change || function() {};
        window.layout_theme_sidebar_change = window.layout_theme_sidebar_change || function() {};
        window.change_box_container = window.change_box_container || function() {};
        window.layout_caption_change = window.layout_caption_change || function() {};
        window.layout_rtl_change = window.layout_rtl_change || function() {};
        window.preset_change = window.preset_change || function() {};
        window.main_layout_change = window.main_layout_change || function() {};
    </script>

    <script src="/assets/js/script.js"></script>

    <script>
        const API_URL = '/api';
        let usuariosStore = null;
        let empresasStore = [];
        let currentUserId = null;

        const generationCard = document.getElementById('cardGeneracion');
        const historyCard = document.getElementById('cardHistorial');
        const importView = document.getElementById('importacion-view');
        const feedbackDiv = document.getElementById('feedbackMessageFormularios');

        function showGenerationView() {
            if(generationCard) generationCard.classList.remove('d-none');
            if(importView) importView.classList.add('d-none');
            loadInitialData();
        }

        function showImportView() {
            if(generationCard) generationCard.classList.add('d-none');
            if(importView) importView.classList.remove('d-none');
            const listTabButton = document.getElementById('list-tab');
            if (listTabButton && listTabButton.classList.contains('active')) {
                 loadFormulariosImportados();
            }
        }

        function showMessage(message, type = 'info') {
             if (feedbackDiv) {
                 feedbackDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                                           ${message}
                                           <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>`;
             } else {
                 alert(message);
             }
        }

         function initializeFeatherIcons() {
             setTimeout(() => {
                 if (typeof feather !== 'undefined' && feather && typeof feather.replace === 'function') {
                     try {
                         feather.replace();
                     } catch (e) {
                         console.error("Error calling feather.replace():", e);
                     }
                 }
             }, 100);
         }

        async function loadInitialData(forceReloadUsers = false) {
             const loader = document.querySelector('.loader-bg');
             if(loader) loader.style.display = 'flex';
             showMessage('Cargando datos necesarios...', 'info');

             try {
                 const fetchPromises = [
                    fetch(`${API_URL}/formularios/listar`, { credentials: 'include' }),
                    fetch(`${API_URL}/empresas`, { credentials: 'include' }),
                    (usuariosStore === null || forceReloadUsers) ? fetch(`${API_URL}/usuarios`, { credentials: 'include' }) : Promise.resolve(null)
                 ];

                 const [formResponse, empResponse, userResponseOrNull] = await Promise.all(fetchPromises);

                 if (!formResponse.ok) throw new Error(`Error ${formResponse.status} cargando formularios`);
                 if (!empResponse.ok) throw new Error(`Error ${empResponse.status} cargando empresas`);
                  if (userResponseOrNull && !userResponseOrNull.ok) throw new Error(`Error ${userResponseOrNull.status} cargando usuarios`);

                 const formulariosData = await formResponse.json();
                 const formularios = formulariosData.formularios || formulariosData || [];
                 const empresasData = await empResponse.json();
                 empresasStore = empresasData.items || empresasData || [];

                 if (userResponseOrNull) {
                     const userData = await userResponseOrNull.json();
                     usuariosStore = userData.items || userData || [];
                 }

                 const selectFormulario = document.getElementById('selectFormulario');
                 if (selectFormulario) {
                     selectFormulario.innerHTML = '<option value="">Seleccione un formulario...</option>';
                     formularios.forEach(f => selectFormulario.add(new Option(f.nombre, f.id)));
                 }

                 const selectEmpresa = document.getElementById('selectEmpresa');
                 if (selectEmpresa) {
                     const currentEmpresa = selectEmpresa.value;
                     selectEmpresa.innerHTML = '<option value="">Seleccione una empresa...</option>';
                     empresasStore.forEach(e => selectEmpresa.add(new Option(`${e.nombre_empresa} (NIT: ${e.nit})`, e.nit)));
                     if (empresasStore.some(e => e.nit === currentEmpresa)) {
                          selectEmpresa.value = currentEmpresa;
                     }
                 }

                 if (currentUserId === null) {
                     resetUserSearch();
                 }

                 showMessage('Datos cargados correctamente.', 'success');

             } catch (error) {
                 console.error('Error al cargar datos iniciales:', error);
                 showMessage(`Error al cargar datos: ${error.message}`, 'danger');
                  const selectFormulario = document.getElementById('selectFormulario');
                  if (selectFormulario) selectFormulario.innerHTML = '<option value="">Error al cargar</option>';
                  const selectEmpresa = document.getElementById('selectEmpresa');
                  if (selectEmpresa) selectEmpresa.innerHTML = '<option value="">Error al cargar</option>';
                  usuariosStore = null;
                  resetUserSearch();
             } finally {
                 if(loader) loader.style.display = 'none';
             }
        }

        function resetUserSearch() {
            const tipoIdSelect = document.getElementById('selectTipoIdUsuario');
            const numeroIdInput = document.getElementById('inputNumeroIdUsuario');
            const displayField = document.getElementById('inputUsuarioSeleccionado');
            const hiddenIdField = document.getElementById('hiddenUsuarioId');

            if(tipoIdSelect) tipoIdSelect.value = '';
            if(numeroIdInput) numeroIdInput.value = '';
            if(displayField) displayField.value = 'Ingrese Tipo y Número de ID';
            if(hiddenIdField) hiddenIdField.value = '';
            currentUserId = null;
        }

        function findUser() {
            const tipoIdSelect = document.getElementById('selectTipoIdUsuario');
            const numeroIdInput = document.getElementById('inputNumeroIdUsuario');
            const displayField = document.getElementById('inputUsuarioSeleccionado');
            const hiddenIdField = document.getElementById('hiddenUsuarioId');

            if (!tipoIdSelect || !numeroIdInput || !displayField || !hiddenIdField) return;

            const tipoId = tipoIdSelect.value;
            const numeroId = numeroIdInput.value.trim();

            displayField.value = 'Buscando...';
            hiddenIdField.value = '';
            currentUserId = null;

            if (!tipoId || !numeroId) {
                displayField.value = 'Ingrese Tipo y Número de ID';
                return;
            }

            if (!usuariosStore) {
                 console.error("La lista completa de usuarios no está cargada.");
                 displayField.value = 'Error: Recargue datos';
                 showMessage("Error interno: La lista de usuarios no se cargó correctamente.", "danger");
                 return;
            }

            const foundUsers = usuariosStore.filter(u => u.numeroId === numeroId);

            if (foundUsers.length === 1) {
                const foundUser = foundUsers[0];
                displayField.value = `${foundUser.primerNombre || ''} ${foundUser.primerApellido || ''}`.trim();
                hiddenIdField.value = foundUser.id;
                currentUserId = foundUser.id;
                showMessage(`Usuario ${displayField.value} encontrado.`, 'success');
            } else if (foundUsers.length > 1) {
                 displayField.value = 'ID Duplicado Encontrado';
                 showMessage(`Se encontraron múltiples usuarios con el ID ${numeroId}. Contacte al administrador.`, 'warning');
            } else {
                displayField.value = 'Empleado no encontrado';
                showMessage(`No se encontró ningún empleado con Número '${numeroId}'.`, 'warning');
            }
        }

        async function handleGeneratePdf(event) {
            event.preventDefault();
            const btn = document.getElementById('btnGenerar');
            const originalBtnHtml = btn.innerHTML;

            const formulario_id = document.getElementById('selectFormulario').value;
            const usuario_id = currentUserId;
            const empresa_nit = document.getElementById('selectEmpresa').value;

            if (!formulario_id || !usuario_id || !empresa_nit) {
                showMessage('Por favor, seleccione un formulario, encuentre un empleado válido y seleccione una empresa.', 'warning');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Generando...';
            showMessage('Generando PDF, por favor espere...', 'info');

            try {
                const response = await fetch(`${API_URL}/formularios/generar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/pdf' },
                    body: JSON.stringify({ formulario_id, usuario_id, empresa_nit }),
                    credentials: 'include'
                });

                if (!response.ok) {
                    let errorData;
                    try { errorData = await response.json(); }
                    catch (jsonError) { throw new Error(`Error ${response.status}: ${response.statusText}`); }
                    throw new Error(errorData.error || `Error ${response.status} al generar el PDF.`);
                }

                const contentDisposition = response.headers.get('content-disposition');
                let filename = `formulario_${formulario_id}_usuario_${usuario_id}.pdf`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/i);
                    if (filenameMatch && filenameMatch.length > 1) filename = filenameMatch[1];
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none'; a.href = url; a.download = filename;
                document.body.appendChild(a); a.click();
                window.URL.revokeObjectURL(url); a.remove();

                showMessage(`✅ PDF "${filename}" generado y descarga iniciada.`, 'success');

            } catch (error) {
                console.error("Error en la generación/descarga:", error);
                showMessage(`❌ Error al generar PDF: ${error.message}`, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnHtml;
                initializeFeatherIcons();
            }
        }

        async function handleImportForm(event) {
             event.preventDefault();
             const form = event.target;
             const formData = new FormData(form);
             const btn = document.getElementById('btnImportar');
             const originalBtnHtml = btn.innerHTML;

             const fileInput = document.getElementById('archivoPdf');
             const nombreInput = document.getElementById('nombreFormulario');

             if (!fileInput.files.length || !nombreInput.value.trim()) {
                 showMessage('Por favor, ingrese un nombre y seleccione un archivo PDF.', 'warning'); return;
             }

             btn.disabled = true;
             btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Importando...';
             showMessage('Importando formulario...', 'info');

             try {
                 const response = await fetch(`${API_URL}/formularios/importar`, {
                      method: 'POST',
                      body: formData,
                      credentials: 'include'
                 });
                 const data = await response.json();
                 if (!response.ok) throw new Error(data.error || 'Error en la importación.');

                 showMessage(`✅ Formulario "${formData.get('nombre')}" importado con éxito.`, 'success');
                 form.reset();
                 const listTabButton = document.getElementById('list-tab');
                 if (listTabButton) {
                     new bootstrap.Tab(listTabButton).show();
                 }
                 loadInitialData();

             } catch (error) {
                 showMessage(`❌ Error al importar: ${error.message}`, 'danger');
             } finally {
                 btn.disabled = false;
                 btn.innerHTML = originalBtnHtml;
                 initializeFeatherIcons();
             }
        }

        async function loadFormulariosImportados(showLoadingMessage = false) {
             const tbody = document.getElementById('tablaFormulariosImportados')?.querySelector('tbody');
             if (!tbody) return;

             if(showLoadingMessage) showMessage('Recargando lista de formularios...', 'info');
             tbody.innerHTML = '<tr class="loading-placeholder"><td colspan="6" class="text-center"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Cargando formularios importados...</td></tr>';

             try {
                 const response = await fetch(`${API_URL}/formularios`, { credentials: 'include' });
                 if (!response.ok) throw new Error(`Error ${response.status} al cargar formularios importados.`);

                 const formularios = await response.json();
                 tbody.innerHTML = '';
                 if (formularios.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay formularios importados.</td></tr>'; return;
                 }
                 formularios.forEach(f => {
                     const row = tbody.insertRow();
                     row.insertCell().textContent = f.id;
                     row.insertCell().textContent = f.nombre;
                     row.insertCell().textContent = f.nombre_archivo;
                     row.insertCell().textContent = 'N/A';
                     row.insertCell().textContent = f.created_at ? new Date(f.created_at).toLocaleDateString() : 'N/A';
                     const deleteButton = document.createElement('button');
                     deleteButton.className = 'btn btn-sm btn-danger btn-icon';
                     deleteButton.title = 'Eliminar Formulario';
                     deleteButton.innerHTML = '<i data-feather="trash-2"></i>';
                     deleteButton.onclick = () => deleteFormulario(f.id, f.nombre);
                     row.insertCell().appendChild(deleteButton);
                 });
                 initializeFeatherIcons();

             } catch (error) {
                 console.error("Error al cargar formularios importados:", error);
                 tbody.innerHTML = `<tr class="error-placeholder"><td colspan="6" class="text-center">Error al cargar: ${error.message}</td></td>`;
             }
        }

        async function deleteFormulario(id, nombre) {
            if (!confirm(`¿Seguro que desea eliminar el formulario "${nombre}" (ID: ${id})?`)) return;

            showMessage(`Eliminando formulario ${nombre}...`, 'warning');

            try {
                const response = await fetch(`${API_URL}/formularios/${id}`, {
                     method: 'DELETE',
                     credentials: 'include'
                });
                 if (!response.ok) {
                     const data = await response.json();
                     throw new Error(data.error || `Error ${response.status} al eliminar.`);
                 }
                 showMessage(`✅ Formulario "${nombre}" eliminado correctamente.`, 'success');
                 loadFormulariosImportados();
                 loadInitialData();
            } catch (error) {
                 showMessage(`❌ Error al eliminar "${nombre}": ${error.message}`, 'danger');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
             const loader = document.querySelector('.loader-bg');
             if(loader) loader.style.display = 'none';

             const btnImportarNuevo = document.getElementById('btnImportarNuevo');
             if(btnImportarNuevo) btnImportarNuevo.addEventListener('click', showImportView);

             const formGeneracion = document.getElementById('formGeneracion');
             if(formGeneracion) formGeneracion.addEventListener('submit', handleGeneratePdf);
             const formImportacion = document.getElementById('formImportacion');
             if(formImportacion) formImportacion.addEventListener('submit', handleImportForm);

             const tipoIdSelect = document.getElementById('selectTipoIdUsuario');
             const numeroIdInput = document.getElementById('inputNumeroIdUsuario');
             if(tipoIdSelect) tipoIdSelect.addEventListener('change', findUser);
             if(numeroIdInput) {
                  numeroIdInput.addEventListener('change', findUser);
                  numeroIdInput.addEventListener('keypress', function(event) {
                      if (event.key === 'Enter') {
                          event.preventDefault();
                          findUser();
                      }
                  });
             }

              const listTabButton = document.getElementById('list-tab');
              if (listTabButton) {
                  listTabButton.addEventListener('show.bs.tab', () => loadFormulariosImportados(true));
              }

             showGenerationView();
             initializeFeatherIcons();

            if (typeof layout_change === 'function') layout_change('false');
            if (typeof layout_theme_sidebar_change === 'function') layout_theme_sidebar_change('dark');
            if (typeof change_box_container === 'function') change_box_container('false');
            if (typeof layout_caption_change === 'function') layout_caption_change('true');
            if (typeof layout_rtl_change === 'function') layout_rtl_change('false');
            if (typeof preset_change === 'function') preset_change('preset-1');
            if (typeof main_layout_change === 'function') main_layout_change('vertical');
        });
    </script>

  </body>
</html>
