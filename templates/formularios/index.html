<!doctype html>
<html lang="en" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
  <head>
    <title>Gestor de Afiliaciones | Montero y Negocio</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="Sistema de gestiÃ³n de afiliaciones y documentos" />
    <meta name="author" content="Montero y Negocio" />

    <link rel="icon" href="/assets/images/favicon.svg" type="image/x-icon" />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/fonts/phosphor/duotone/style.css" />
    <link rel="stylesheet" href="/assets/fonts/tabler-icons.min.css" />
    <link rel="stylesheet" href="/assets/fonts/feather.css" />
    <link rel="stylesheet" href="/assets/fonts/fontawesome.css" />
    <link rel="stylesheet" href="/assets/fonts/material.css" />
    <link rel="stylesheet" href="/assets/css/style.css" id="main-style-link" />
    <!-- âœ… REDISEÃ‘O CORPORATIVO ENTERPRISE -->
    <link rel="stylesheet" href="/assets/css/corporate-redesign.css" />
    
    <!-- SweetAlert2 para alertas modernas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <!-- Toastify para notificaciones tipo toast -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        .user-avatar {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }
        .badge-docs {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .table-afiliaciones {
            font-size: 0.875rem;
        }
        .table-afiliaciones th {
            background-color: #f8f9fa;
            font-weight: 600;
            padding: 0.5rem;
        }
        .table-afiliaciones td {
            padding: 0.5rem;
            vertical-align: middle;
        }
        .entity-icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }
        .btn-file-upload {
            position: relative;
            overflow: hidden;
        }
        .btn-file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .switch-no-aplica {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }
    </style>
  </head>
  <body>
    <div class="loader-bg fixed inset-0 bg-white dark:bg-themedark-cardbg z-[1034]">
        <div class="loader-track h-[5px] w-full inline-block absolute overflow-hidden top-0">
            <div class="loader-fill w-[300px] h-[5px] bg-primary-500 absolute top-0 left-0 animate-[hitZak_0.6s_ease-in-out_infinite_alternate]"></div>
        </div>
    </div>

    {% include '_sidebar.html' %}
    {% include '_header.html' %}

    <div class="pc-container">
      <div class="pc-content">
        <div class="page-header">
          <div class="page-block">
            <div class="row align-items-center">
              <div class="col-md-12">
                <ul class="breadcrumb mb-3">
                  <li class="breadcrumb-item"><a href="/dashboard">Home</a></li>
                  <li class="breadcrumb-item"><a href="javascript: void(0)">GestiÃ³n Operativa</a></li>
                  <li class="breadcrumb-item" aria-current="page">Gestor de Afiliaciones</li>
                </ul>
              </div>
              <div class="col-md-12">
                <div class="page-header-title">
                  <h2 class="mb-0"><i class="ph-duotone ph-users-three me-2"></i>Gestor de Afiliaciones</h2>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="feedbackMessage" class="mb-4"></div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- BLOQUE NUEVO: GENERADOR AUTOMÃTICO DE FORMULARIOS -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="card mb-3" style="border-left: 4px solid #3b82f6;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-1">
                            <i class="ph-duotone ph-file-pdf me-2 text-primary"></i>
                            Generador AutomÃ¡tico de Formularios
                        </h4>
                        <p class="text-muted mb-0">Genere formularios pre-llenados de afiliaciÃ³n con los datos del usuario</p>
                    </div>
                    <span class="badge bg-primary-subtle text-primary fs-6 px-3 py-2">
                        <i class="ti ti-wand me-1"></i> AutomÃ¡tico
                    </span>
                </div>
                
                <form id="formGeneradorAuto" onsubmit="generarFormularioAutomatico(event)">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">
                                <i class="ti ti-template me-2"></i>Escoger Plantilla de Formulario
                            </label>
                            <select id="selectPlantillaFormulario" class="form-select form-select-lg" required>
                                <option value="">-- Seleccione una plantilla --</option>
                                <optgroup label="ğŸ“‹ Formularios EPS">
                                    <option value="eps_sura">EPS Sura - AfiliaciÃ³n</option>
                                    <option value="eps_sanitas">EPS Sanitas - AfiliaciÃ³n</option>
                                    <option value="eps_compensar">EPS Compensar - AfiliaciÃ³n</option>
                                    <option value="eps_salud_total">EPS Salud Total - AfiliaciÃ³n</option>
                                </optgroup>
                                <optgroup label="ğŸ’¼ Formularios AFP">
                                    <option value="afp_porvenir">Porvenir - AfiliaciÃ³n PensiÃ³n</option>
                                    <option value="afp_proteccion">ProtecciÃ³n - AfiliaciÃ³n PensiÃ³n</option>
                                    <option value="afp_colfondos">Colfondos - AfiliaciÃ³n PensiÃ³n</option>
                                    <option value="afp_old_mutual">Old Mutual - AfiliaciÃ³n PensiÃ³n</option>
                                </optgroup>
                                <optgroup label="ğŸ›¡ï¸ Formularios ARL">
                                    <option value="arl_sura">ARL Sura - AfiliaciÃ³n</option>
                                    <option value="arl_positiva">ARL Positiva - AfiliaciÃ³n</option>
                                    <option value="arl_bolivar">ARL BolÃ­var - AfiliaciÃ³n</option>
                                </optgroup>
                                <optgroup label="ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Formularios Caja de CompensaciÃ³n">
                                    <option value="ccf_compensar">Compensar - AfiliaciÃ³n</option>
                                    <option value="ccf_colsubsidio">Colsubsidio - AfiliaciÃ³n</option>
                                    <option value="ccf_cafam">Cafam - AfiliaciÃ³n</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">
                                <i class="ti ti-id-badge me-2"></i>CÃ©dula del Usuario
                            </label>
                            <input 
                                type="text" 
                                id="inputCedulaGenerador" 
                                class="form-control form-control-lg" 
                                placeholder="Ej: 1234567890" 
                                list="usuariosDatalist"
                                required
                            >
                            <datalist id="usuariosDatalist">
                                <!-- Se llenarÃ¡ dinÃ¡micamente con usuarios -->
                            </datalist>
                            <div class="form-text">
                                <i class="ti ti-info-circle me-1"></i>
                                Escriba para autocompletar con usuarios existentes
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary btn-lg w-100" id="btnGenerarPDF">
                                <i class="ti ti-download me-2"></i>
                                Generar y Descargar PDF
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Zona de informaciÃ³n adicional -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info mb-0" role="alert">
                            <i class="ti ti-info-circle me-2"></i>
                            <strong>Â¿CÃ³mo funciona?</strong> 
                            El sistema tomarÃ¡ los datos del usuario (nombre, cÃ©dula, direcciÃ³n, empresa, etc.) y los insertarÃ¡ automÃ¡ticamente en el formulario de la entidad seleccionada, generando un PDF listo para firmar.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- BLOQUE 1: VERIFICADOR DE IDENTIDAD -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-1"><i class="ti ti-user-search me-2"></i>Verificador de Identidad</h4>
                        <p class="text-muted mb-0">Busca al afiliado por Tipo y NÃºmero de Documento para gestionar sus documentos</p>
                    </div>
                </div>
                
                <form id="formBuscarAfiliado" onsubmit="buscarAfiliado(event)">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-2">
                            <label class="form-label"><i class="ti ti-id-badge me-2"></i>Tipo ID</label>
                            <select id="selectTipoId" class="form-select" required>
                                <option value="">Seleccione...</option>
                                <option value="CC">CÃ©dula de CiudadanÃ­a</option>
                                <option value="CE">CÃ©dula de ExtranjerÃ­a</option>
                                <option value="PEP">Permiso Especial de Permanencia</option>
                                <option value="PA">Pasaporte</option>
                                <option value="TI">Tarjeta de Identidad</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label"><i class="ti ti-hash me-2"></i>NÃºmero ID</label>
                            <input type="text" id="inputNumeroId" class="form-control" placeholder="Ingrese el nÃºmero..." required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label"><i class="ti ti-user me-2"></i>Nombre del Usuario</label>
                            <input type="text" id="inputNombreUsuario" class="form-control bg-light" placeholder="Se completarÃ¡ automÃ¡ticamente..." readonly>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary flex-fill">
                                    <i class="ti ti-search me-2"></i>Buscar Afiliado
                                </button>
                                <a href="/formularios/generador" target="_blank" class="btn btn-outline-secondary" title="Ir al Generador de PDF">
                                    <i class="ph-duotone ph-file-pdf"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- BLOQUE 2: TABLA DE USUARIOS -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="ti ti-users me-2"></i>Lista de Usuarios</h5>
                <span class="badge bg-primary" id="totalUsuariosBadge">0 usuarios</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover text-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 250px;">Usuario</th>
                                <th style="width: 120px;">Documento</th>
                                <th>Empresa</th>
                                <th style="width: 80px;" class="text-center">Docs</th>
                                <th style="width: 120px;" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="5" class="text-center text-muted py-4">Cargando usuarios...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- BLOQUE 3: TABLA DE DOCUMENTOS (GESTIÃ“N INDIVIDUAL) -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="card d-none" id="panelGestionDocumentos">
            <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                <div class="d-flex align-items-center">
                    <div class="user-avatar bg-white text-primary rounded-circle me-3">
                        <span id="userAvatarLetter">?</span>
                    </div>
                    <div>
                        <h5 class="mb-0" id="userNameDisplay">-</h5>
                        <small><strong>Doc:</strong> <span id="userDocDisplay">-</span> | <strong>Empresa:</strong> <span id="userEmpresaDisplay">-</span></small>
                    </div>
                </div>
                <button class="btn btn-sm btn-light" onclick="cerrarPanelGestion()">
                    <i class="ti ti-x"></i> Cerrar
                </button>
            </div>
            <div class="card-body py-2">
                <table class="table table-sm table-bordered table-hover table-afiliaciones mb-0">
                    <thead>
                        <tr>
                            <th style="width: 200px;">Entidad</th>
                            <th style="width: 120px;" class="text-center">Estado</th>
                            <th>Opciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- EPS -->
                        <tr>
                            <td>
                                <i class="ph-duotone ph-heartbeat entity-icon text-danger"></i>
                                <strong>EPS</strong>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-light-secondary text-secondary" id="badge-eps">Pendiente</span>
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-success" onclick="generarFormularioEPS()">
                                        <i class="ti ti-file-pdf me-1"></i> Generar
                                    </button>
                                    <button class="btn btn-sm btn-primary btn-file-upload" id="upload-eps">
                                        <i class="ti ti-upload me-1"></i> Subir
                                        <input type="file" accept=".pdf" onchange="handleFileUpload('EPS', this)">
                                    </button>
                                    <button class="btn btn-sm btn-info d-none" id="view-eps" onclick="verDocumento('EPS')">
                                        <i class="ti ti-eye me-1"></i> Ver
                                    </button>
                                </div>
                            </td>
                        </tr>

                        <!-- ARL -->
                        <tr>
                            <td>
                                <i class="ph-duotone ph-hard-hat entity-icon text-success"></i>
                                <strong>ARL</strong>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-light-secondary text-secondary" id="badge-arl">Pendiente</span>
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-primary btn-file-upload" id="upload-arl">
                                        <i class="ti ti-upload me-1"></i> Subir
                                        <input type="file" accept=".pdf" onchange="handleFileUpload('ARL', this)">
                                    </button>
                                    <button class="btn btn-sm btn-info d-none" id="view-arl" onclick="verDocumento('ARL')">
                                        <i class="ti ti-eye me-1"></i> Ver
                                    </button>
                                </div>
                            </td>
                        </tr>

                        <!-- PENSIÃ“N -->
                        <tr>
                            <td>
                                <i class="ph-duotone ph-piggy-bank entity-icon text-warning"></i>
                                <strong>PensiÃ³n</strong>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-light-secondary text-secondary" id="badge-pension">Pendiente</span>
                            </td>
                            <td>
                                <div class="d-flex gap-2 align-items-center">
                                    <button class="btn btn-sm btn-primary btn-file-upload" id="upload-pension">
                                        <i class="ti ti-upload me-1"></i> Subir
                                        <input type="file" accept=".pdf" onchange="handleFileUpload('PENSION', this)">
                                    </button>
                                    <button class="btn btn-sm btn-info d-none" id="view-pension" onclick="verDocumento('PENSION')">
                                        <i class="ti ti-eye me-1"></i> Ver
                                    </button>
                                    <div class="switch-no-aplica ms-auto">
                                        <input type="checkbox" class="form-check-input" id="switch-pension-na">
                                        <label class="form-check-label text-muted" for="switch-pension-na">No Aplica</label>
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <!-- CAJA -->
                        <tr>
                            <td>
                                <i class="ph-duotone ph-hand-coins entity-icon text-info"></i>
                                <strong>Caja de CompensaciÃ³n</strong>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-light-secondary text-secondary" id="badge-caja">Pendiente</span>
                            </td>
                            <td>
                                <div class="d-flex gap-2 align-items-center">
                                    <button class="btn btn-sm btn-primary btn-file-upload" id="upload-caja">
                                        <i class="ti ti-upload me-1"></i> Subir
                                        <input type="file" accept=".pdf" onchange="handleFileUpload('CAJA', this)">
                                    </button>
                                    <button class="btn btn-sm btn-info d-none" id="view-caja" onclick="verDocumento('CAJA')">
                                        <i class="ti ti-eye me-1"></i> Ver
                                    </button>
                                    <div class="switch-no-aplica ms-auto">
                                        <input type="checkbox" class="form-check-input" id="switch-caja-na">
                                        <label class="form-check-label text-muted" for="switch-caja-na">No Aplica</label>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

      </div>
    </div>

    {% include '_footer.html' %}

    <script src="/assets/js/plugins/simplebar.min.js"></script>
    <script src="/assets/js/plugins/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/plugins/feather.min.js"></script>
    <script src="/assets/js/component.js"></script>
    <script src="/assets/js/theme.js"></script>
    
    <!-- SweetAlert2 para alertas modernas -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Toastify para notificaciones tipo toast -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        // Polyfills para tema
        window.layout_change = window.layout_change || function() {};
        window.layout_theme_sidebar_change = window.layout_theme_sidebar_change || function() {};
        window.change_box_container = window.change_box_container || function() {};
        window.layout_caption_change = window.layout_caption_change || function() {};
        window.layout_rtl_change = window.layout_rtl_change || function() {};
        window.preset_change = window.preset_change || function() {};
        window.main_layout_change = window.main_layout_change || function() {};
    </script>

    <script src="/assets/js/script.js"></script>

    <script>
        // Variables globales
        const API_URL = '/api';
        let usuariosStore = [];
        let empresasStore = [];
        let currentUsuarioGestion = null;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FUNCIONES DE MENSAJES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showMessage(message, type = 'info') {
            const feedbackDiv = document.getElementById('feedbackMessage');
            if (feedbackDiv) {
                feedbackDiv.innerHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>`;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CARGA DE DATOS: USUARIOS Y EMPRESAS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function cargarUsuarios() {
            try {
                const response = await fetch(`${API_URL}/usuarios`, { credentials: 'include' });
                if (!response.ok) throw new Error('Error al cargar usuarios');
                
                const data = await response.json();
                usuariosStore = data.items || data.usuarios || [];
                
                renderizarTablaUsuarios(usuariosStore);
                poblarDatalistUsuarios(); // âœ… Llenar datalist para autocompletado
                
                document.getElementById('totalUsuariosBadge').textContent = `${usuariosStore.length} usuarios`;
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error al cargar usuarios: ' + error.message, 'danger');
            }
        }

        // FunciÃ³n eliminada: poblarFiltroEmpresas() ya no es necesaria

        function renderizarTablaUsuarios(usuarios) {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!usuarios || usuarios.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No se encontraron usuarios</td></tr>';
                return;
            }
            
            usuarios.forEach(user => {
                const nombreCompleto = `${user.primerNombre || ''} ${user.primerApellido || ''}`.trim() || 'Sin nombre';
                const iniciales = nombreCompleto.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="user-avatar bg-light-primary text-primary rounded-circle me-2">
                                ${iniciales}
                            </div>
                            <div>
                                <div class="fw-semibold">${nombreCompleto}</div>
                                <small class="text-muted">${user.correoElectronico || '-'}</small>
                            </div>
                        </div>
                    </td>
                    <td>${user.numeroId || '-'}</td>
                    <td>
                        <span class="badge bg-light-info text-info">
                            ${user.empresa_nombre || 'Sin asignar'}
                        </span>
                    </td>
                    <td class="text-center">
                        <span class="badge badge-docs bg-secondary">0/4</span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-primary" onclick="abrirGestionDocumentos(${user.id})">
                            <i class="ti ti-folder-open me-1"></i> Gestionar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VERIFICADOR DE IDENTIDAD (BÃšSQUEDA ESTRICTA)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function buscarAfiliado(event) {
            event.preventDefault();
            
            const tipoId = document.getElementById('selectTipoId').value;
            const numeroId = document.getElementById('inputNumeroId').value.trim();
            const inputNombre = document.getElementById('inputNombreUsuario');
            
            // Validar campos
            if (!tipoId || !numeroId) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Campos Incompletos',
                    text: 'Por favor seleccione el Tipo de ID e ingrese el NÃºmero de Documento.',
                    confirmButtonColor: '#3f51b5'
                });
                return;
            }
            
            // Buscar usuario por numeroId (bÃºsqueda estricta)
            const usuarioEncontrado = usuariosStore.find(u => u.numeroId && u.numeroId.toString() === numeroId);
            
            if (usuarioEncontrado) {
                // Usuario encontrado
                const nombreCompleto = `${usuarioEncontrado.primerNombre || ''} ${usuarioEncontrado.primerApellido || ''}`.trim() || 'Sin nombre';
                const empresaNombre = usuarioEncontrado.empresa_nombre || 'Sin asignar';
                
                // Llenar campo de nombre (readonly)
                inputNombre.value = nombreCompleto;
                
                // Renderizar tabla con Ãºnico usuario
                renderizarTablaUsuarios([usuarioEncontrado]);
                
                // Toast de Ã©xito
                Toastify({
                    text: `âœ“ Usuario Encontrado: ${empresaNombre}`,
                    duration: 3000,
                    gravity: 'top',
                    position: 'right',
                    backgroundColor: '#28a745',
                    stopOnFocus: true
                }).showToast();
                
            } else {
                // Usuario NO encontrado
                inputNombre.value = '';
                
                // Limpiar tabla
                const tbody = document.getElementById('usersTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No se encontraron resultados</td></tr>';
                }
                
                // Alerta de error
                Swal.fire({
                    icon: 'error',
                    title: 'Usuario No Encontrado',
                    html: `El usuario con ID <strong>${numeroId}</strong> no existe o no estÃ¡ activo en el sistema.<br><br><small class="text-muted">Verifique el nÃºmero de documento e intente nuevamente.</small>`,
                    confirmButtonColor: '#3f51b5',
                    confirmButtonText: 'Entendido'
                });
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GESTIÃ“N INDIVIDUAL DE DOCUMENTOS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function abrirGestionDocumentos(userId) {
            const user = usuariosStore.find(u => u.id === userId);
            if (!user) return;
            
            currentUsuarioGestion = user;
            
            const nombreCompleto = `${user.primerNombre || ''} ${user.primerApellido || ''}`.trim() || 'Sin nombre';
            const iniciales = nombreCompleto.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            
            document.getElementById('userAvatarLetter').textContent = iniciales;
            document.getElementById('userNameDisplay').textContent = nombreCompleto;
            document.getElementById('userDocDisplay').textContent = user.numeroId || '-';
            document.getElementById('userEmpresaDisplay').textContent = user.empresa_nombre || 'Sin asignar';
            
            document.getElementById('panelGestionDocumentos')?.classList.remove('d-none');
            
            await cargarEstadosAfiliaciones(userId);
            
            document.getElementById('panelGestionDocumentos')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function cerrarPanelGestion() {
            document.getElementById('panelGestionDocumentos')?.classList.add('d-none');
            currentUsuarioGestion = null;
        }

        async function cargarEstadosAfiliaciones(userId) {
            try {
                const response = await fetch(`${API_URL}/formularios/estado_afiliaciones/${userId}`, { 
                    credentials: 'include' 
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                
                ['eps', 'arl', 'pension', 'caja'].forEach(tipo => {
                    const tipoUpper = tipo.toUpperCase();
                    const estado = data.estados?.[tipoUpper];
                    const badge = document.getElementById(`badge-${tipo}`);
                    const viewBtn = document.getElementById(`view-${tipo}`);
                    
                    if (estado && estado.estado === 'COMPLETADO') {
                        if (badge) {
                            badge.className = 'badge bg-light-success text-success';
                            badge.textContent = 'âœ“ Completado';
                        }
                        viewBtn?.classList.remove('d-none');
                    } else {
                        if (badge) {
                            badge.className = 'badge bg-light-secondary text-secondary';
                            badge.textContent = 'Pendiente';
                        }
                        viewBtn?.classList.add('d-none');
                    }
                });
            } catch (error) {
                console.error('Error cargando estados:', error);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SUBIDA DE ARCHIVOS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function handleFileUpload(tipoEntidad, inputElement) {
            if (!currentUsuarioGestion) {
                showMessage('No hay usuario seleccionado', 'warning');
                return;
            }

            const archivo = inputElement.files[0];
            if (!archivo) return;

            const formData = new FormData();
            formData.append('usuario_id', currentUsuarioGestion.id);
            formData.append('tipo_entidad', tipoEntidad);
            formData.append('archivo', archivo);

            try {
                showMessage(`Subiendo documento ${tipoEntidad}...`, 'info');

                const response = await fetch(`${API_URL}/formularios/subir_constancia`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(`âœ… ${data.message}`, 'success');
                    await cargarEstadosAfiliaciones(currentUsuarioGestion.id);
                } else {
                    showMessage(`âŒ Error: ${data.error}`, 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error al subir el documento', 'danger');
            } finally {
                inputElement.value = '';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GENERADOR AUTOMÃTICO DE FORMULARIOS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Generar formulario automÃ¡tico con datos pre-llenados
         */
        async function generarFormularioAutomatico(event) {
            event.preventDefault();
            
            const plantilla = document.getElementById('selectPlantillaFormulario').value;
            const cedula = document.getElementById('inputCedulaGenerador').value;
            const btnGenerar = document.getElementById('btnGenerarPDF');
            
            if (!plantilla || !cedula) {
                showMessage('âš ï¸ Por favor seleccione una plantilla e ingrese una cÃ©dula', 'warning');
                return;
            }

            try {
                // Cambiar estado del botÃ³n
                const originalBtnHtml = btnGenerar.innerHTML;
                btnGenerar.disabled = true;
                btnGenerar.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span> Generando PDF...';

                showMessage('â³ Generando formulario automÃ¡tico...', 'info');

                // Llamar al endpoint de generaciÃ³n
                const response = await fetch(`${API_URL}/formularios/generar-pdf`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        plantilla: plantilla,
                        cedula: cedula
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Error al generar formulario');
                }

                // Descargar PDF
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `formulario_${plantilla}_${cedula}_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showMessage('âœ… Formulario generado y descargado exitosamente', 'success');
                
                // Resetear formulario
                document.getElementById('formGeneradorAuto').reset();

                console.log('âœ… Formulario generado:', plantilla, 'para usuario:', cedula);

            } catch (error) {
                console.error('âŒ Error generando formulario:', error);
                showMessage(`âŒ Error: ${error.message}`, 'danger');
            } finally {
                // Restaurar botÃ³n
                btnGenerar.disabled = false;
                btnGenerar.innerHTML = originalBtnHtml;
            }
        }

        /**
         * Poblar el datalist con usuarios para autocompletado
         */
        function poblarDatalistUsuarios() {
            const datalist = document.getElementById('usuariosDatalist');
            if (!datalist) return;

            datalist.innerHTML = '';
            
            usuariosStore.forEach(user => {
                const nombreCompleto = `${user.primerNombre || ''} ${user.primerApellido || ''}`.trim();
                const option = document.createElement('option');
                option.value = user.numeroId;
                option.textContent = `${user.numeroId} - ${nombreCompleto}`;
                datalist.appendChild(option);
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GENERAR FORMULARIO EPS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function generarFormularioEPS() {
            if (!currentUsuarioGestion) return;
            
            const url = `/formularios/generador?usuario=${currentUsuarioGestion.numeroId}`;
            window.open(url, '_blank');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VER DOCUMENTO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function verDocumento(tipoEntidad) {
            if (!currentUsuarioGestion) return;
            
            showMessage(`Funcionalidad de visualizaciÃ³n en desarrollo para ${tipoEntidad}`, 'info');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INICIALIZACIÃ“N
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.addEventListener('DOMContentLoaded', function() {
            const loader = document.querySelector('.loader-bg');
            if(loader) loader.style.display = 'none';

            cargarUsuarios();

            // Event listener para bÃºsqueda con Enter en el campo de NÃºmero ID
            document.getElementById('inputNumeroId')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('formBuscarAfiliado')?.requestSubmit();
                }
            });

            if (typeof layout_change === 'function') layout_change('false');
            if (typeof layout_theme_sidebar_change === 'function') layout_theme_sidebar_change('dark');
            if (typeof change_box_container === 'function') change_box_container('false');
            if (typeof layout_caption_change === 'function') layout_caption_change('true');
            if (typeof layout_rtl_change === 'function') layout_rtl_change('false');
            if (typeof preset_change === 'function') preset_change('preset-1');
            if (typeof main_layout_change === 'function') main_layout_change('vertical');
        });
    </script>

  </body>
</html>
