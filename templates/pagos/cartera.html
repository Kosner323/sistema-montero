<!doctype html>
<html lang="es" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
  <head>
    <meta charset="utf-8" />
    <title>Gesti√≥n de Cartera | Portal Montero</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="Sistema de gesti√≥n de cartera - Cuentas por cobrar y seguridad social" />
    <meta name="author" content="Montero y Negocio" />
    <link rel="icon" href="/assets/images/favicon.svg" type="image/x-icon" />

    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/fonts/phosphor/duotone/style.css" />
    <link rel="stylesheet" href="/assets/fonts/tabler-icons.min.css" />
    <link rel="stylesheet" href="/assets/fonts/feather.css" />
    <link rel="stylesheet" href="/assets/fonts/fontawesome.css" />
    <link rel="stylesheet" href="/assets/fonts/material.css" />
    <link rel="stylesheet" href="/assets/css/style.css" id="main-style-link" />
    <!-- ‚úÖ REDISE√ëO CORPORATIVO ENTERPRISE -->
    <link rel="stylesheet" href="/assets/css/corporate-redesign.css" />

    <script>
      (async function checkAuthentication() {
        const loader = document.querySelector('.loader-bg');
        if (loader) loader.style.display = 'flex';

        try {
          const response = await fetch('/api/check_auth', {
            method: 'GET',
            headers: { 'Accept': 'application/json' },
            credentials: 'include'
          });

          if (!response.ok) {
            window.location.href = '/login';
            return;
          }

          const data = await response.json();

          if (!data.authenticated) {
            window.location.href = '/login';
          } else {
            if (loader) loader.style.display = 'none';
            sessionStorage.setItem('userName', data.user_name);
          }
        } catch (error) {
          console.error('Error de autenticaci√≥n:', error);
          window.location.href = '/login';
        }
      })();
    </script>
  </head>
  <body>
    <div class="loader-bg fixed inset-0 bg-white dark:bg-themedark-cardbg z-[1034]" style="display: flex;">
      <div class="loader-track h-[5px] w-full inline-block absolute overflow-hidden top-0">
        <div class="loader-fill w-[300px] h-[5px] bg-primary-500 absolute top-0 left-0 animate-[hitZak_0.6s_ease-in-out_infinite_alternate]"></div>
      </div>
    </div>

    {% include '_sidebar.html' %}
    {% include '_header.html' %}

    <div class="pc-container">
      <div class="pc-content">
        
        <!-- Encabezado de P√°gina -->
        <div class="page-header">
          <div class="page-block">
            <div class="row align-items-center">
              <div class="col-md-12">
                <ul class="breadcrumb">
                  <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                  <li class="breadcrumb-item"><a href="/pagos">Pagos</a></li>
                  <li class="breadcrumb-item" aria-current="page">Cartera</li>
                </ul>
              </div>
              <div class="col-md-12">
                <div class="page-header-title">
                  <h2 class="mb-0">üí∞ Gesti√≥n de Cartera</h2>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tarjetas de M√©tricas Ejecutivas -->
        <div class="row mb-4 g-3">
          <div class="col-xl-3 col-md-6">
            <div class="card shadow-none border">
              <div class="card-body p-3">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <h6 class="text-muted mb-1 small text-uppercase fw-bold">Total Cartera</h6>
                    <h3 class="mb-0 fw-bold text-dark" id="stat-total-cobrar">$ 0</h3>
                    <small class="text-success fw-medium">
                      <i data-feather="trending-up" style="width: 14px; height: 14px;"></i> +12.5% vs mes anterior
                    </small>
                  </div>
                  <div class="avatar bg-light-primary text-primary rounded p-2">
                    <i data-feather="dollar-sign" style="width: 24px; height: 24px;"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-xl-3 col-md-6">
            <div class="card shadow-none border">
              <div class="card-body p-3">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <h6 class="text-muted mb-1 small text-uppercase fw-bold">Cartera Vencida</h6>
                    <h3 class="mb-0 fw-bold text-dark" id="stat-cartera-vencida">$ 0</h3>
                    <small class="text-danger fw-medium">
                      <i data-feather="trending-down" style="width: 14px; height: 14px;"></i> Requiere atenci√≥n
                    </small>
                  </div>
                  <div class="avatar bg-light-danger text-danger rounded p-2">
                    <i data-feather="alert-circle" style="width: 24px; height: 24px;"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-xl-3 col-md-6">
            <div class="card shadow-none border">
              <div class="card-body p-3">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <h6 class="text-muted mb-1 small text-uppercase fw-bold">Recaudo del Mes</h6>
                    <h3 class="mb-0 fw-bold text-dark" id="stat-total-pagar">$ 0</h3>
                    <small class="text-success fw-medium">
                      <i data-feather="trending-up" style="width: 14px; height: 14px;"></i> +18.3% vs mes anterior
                    </small>
                  </div>
                  <div class="avatar bg-light-success text-success rounded p-2">
                    <i data-feather="pie-chart" style="width: 24px; height: 24px;"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-xl-3 col-md-6">
            <div class="card shadow-none border">
              <div class="card-body p-3">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <h6 class="text-muted mb-1 small text-uppercase fw-bold">Clientes Deudores</h6>
                    <h3 class="mb-0 fw-bold text-dark" id="stat-total-pension">0</h3>
                    <small class="text-warning fw-medium">
                      <i data-feather="alert-triangle" style="width: 14px; height: 14px;"></i> En seguimiento activo
                    </small>
                  </div>
                  <div class="avatar bg-light-warning text-warning rounded p-2">
                    <i data-feather="users" style="width: 24px; height: 24px;"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ========== CONSOLA DE DIGITACI√ìN R√ÅPIDA ========== -->
        <div class="card mb-4" style="border-left: 4px solid #0056b3;">
          <div class="card-header card-header-corporate" style="background: linear-gradient(135deg, #e8f0fe 0%, #d4e4fc 100%);">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h5 class="mb-1 fw-bold" style="color: #0056b3;">
                  <i data-feather="zap" class="me-2"></i>
                  Consola de Digitaci√≥n R√°pida
                </h5>
                <p class="mb-0 small text-muted">Agregue m√∫ltiples deudas manualmente de forma r√°pida</p>
              </div>
              <span class="badge fs-6 px-3 py-2" style="background-color: #0056b3;">
                <i data-feather="layers" class="me-1"></i>
                <span id="contadorTemporal">0</span> pendientes
              </span>
            </div>
          </div>
          <div class="card-body">
            <!-- ========== BUSCADOR UNIVERSAL DE USUARIOS ========== -->
            <div class="col-12 mb-4">
              <div class="alert alert-info border-start border-4 border-info" role="alert">
                <div class="d-flex align-items-center mb-2">
                  <i class="ti ti-search fs-4 me-2"></i>
                  <strong>B√∫squeda R√°pida de Usuario</strong>
                </div>
                <p class="mb-3 small">¬øEl usuario ya est√° registrado? B√∫scalo por documento para autocompletar sus datos.</p>
                
                <div class="row g-3">
                  <div class="col-md-3">
                    <label for="tipoDocBusqueda" class="form-label small fw-semibold">
                      <i class="ti ti-id-badge"></i> Tipo Documento
                    </label>
                    <select class="form-select" id="tipoDocBusqueda">
                      <option value="">Seleccione...</option>
                      <option value="C√©dula de Ciudadan√≠a">C√©dula de Ciudadan√≠a</option>
                      <option value="C√©dula de Extranjer√≠a">C√©dula de Extranjer√≠a</option>
                      <option value="Tarjeta de Identidad">Tarjeta de Identidad</option>
                      <option value="Pasaporte">Pasaporte</option>
                    </select>
                  </div>
                  <div class="col-md-9">
                    <label for="numeroDocBusqueda" class="form-label small fw-semibold">
                      <i class="ti ti-number"></i> N√∫mero de Documento
                    </label>
                    <div class="input-group">
                      <span class="input-group-text bg-white">
                        <i class="ti ti-search text-primary"></i>
                      </span>
                      <input 
                        type="text" 
                        class="form-control" 
                        id="numeroDocBusqueda" 
                        placeholder="Escribe y presiona Enter..."
                        maxlength="15"
                      />
                    </div>
                    <small class="text-muted">
                      <i class="ti ti-info-circle"></i> 
                      Datos se cargar√°n autom√°ticamente si existe
                    </small>
                  </div>
                </div>
              </div>
            </div>
            <!-- ========== FIN BUSCADOR ========== -->

            <!-- Formulario de Ingreso R√°pido -->
            <form id="formDigitacionRapida" class="mb-3">
              <div class="row g-2 align-items-end">
                <div class="col-md-2">
                  <label for="inputIdUsuario" class="form-label small fw-semibold">ID Usuario</label>
                  <input 
                    type="text" 
                    class="form-control form-control-sm" 
                    id="inputIdUsuario" 
                    list="usuariosDatalist"
                    placeholder="C√©dula..."
                    required
                  >
                  <datalist id="usuariosDatalist"></datalist>
                  <small class="text-muted d-block" id="nombreUsuarioDisplay">-</small>
                </div>
                
                <div class="col-md-2">
                  <label for="inputNitEmpresa" class="form-label small fw-semibold">NIT Empresa</label>
                  <input 
                    type="text" 
                    class="form-control form-control-sm" 
                    id="inputNitEmpresa" 
                    list="empresasDatalist"
                    placeholder="NIT..."
                    required
                  >
                  <datalist id="empresasDatalist"></datalist>
                  <small class="text-muted d-block" id="nombreEmpresaDisplay">-</small>
                </div>
                
                <div class="col-md-2">
                  <label for="selectEntidad" class="form-label small fw-semibold">Entidad</label>
                  <select class="form-select form-select-sm" id="selectEntidad" required>
                    <option value="">Seleccione...</option>
                    <option value="EPS">EPS</option>
                    <option value="ARL">ARL</option>
                    <option value="AFP">AFP (Pensi√≥n)</option>
                    <option value="CCF">Caja de Compensaci√≥n</option>
                    <option value="ICBF">ICBF</option>
                    <option value="SENA">SENA</option>
                  </select>
                </div>
                
                <div class="col-md-2">
                  <label for="inputMonto" class="form-label small fw-semibold">Monto (COP)</label>
                  <div class="input-group input-group-sm">
                    <span class="input-group-text">$</span>
                    <input 
                      type="number" 
                      class="form-control" 
                      id="inputMonto" 
                      placeholder="0"
                      min="0"
                      step="1000"
                      required
                    >
                  </div>
                </div>
                
                <div class="col-md-2">
                  <label for="inputDiasMora" class="form-label small fw-semibold">D√≠as Mora</label>
                  <div class="input-group input-group-sm">
                    <input 
                      type="number" 
                      class="form-control" 
                      id="inputDiasMora" 
                      placeholder="0"
                      min="0"
                      required
                    >
                    <span class="input-group-text">d√≠as</span>
                  </div>
                </div>
                
                <div class="col-md-2">
                  <button type="submit" class="btn btn-success btn-sm w-100">
                    <i data-feather="plus-circle" class="me-1" style="width: 16px; height: 16px;"></i>
                    Agregar (+)
                  </button>
                </div>
              </div>
            </form>

            <!-- Tabla Temporal de Deudas Pendientes -->
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
              <table class="table table-excel table-bordered table-sm" id="tablaDigitacionTemporal">
                <thead>
                  <tr>
                    <th style="width: 40px;">#</th>
                    <th>ID Usuario</th>
                    <th>Nombre Usuario</th>
                    <th>NIT Empresa</th>
                    <th>Nombre Empresa</th>
                    <th>Entidad</th>
                    <th class="text-end">Monto</th>
                    <th class="text-center">D√≠as Mora</th>
                    <th class="text-center" style="width: 80px;">Acciones</th>
                  </tr>
                </thead>
                <tbody id="tbodyDigitacionTemporal">
                  <tr>
                    <td colspan="9" class="text-center text-muted py-4">
                      <i data-feather="inbox" class="me-2"></i>
                      No hay deudas pendientes de guardar
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Bot√≥n Final de Guardado -->
            <div class="d-flex justify-content-end gap-2 mt-3">
              <button type="button" class="btn btn-outline-secondary" onclick="limpiarTablaTemporal()">
                <i data-feather="trash-2" class="me-1" style="width: 16px; height: 16px;"></i>
                Limpiar Todo
              </button>
              <button type="button" class="btn btn-primary btn-lg" id="btnGuardarTodo" onclick="guardarTodasLasDeudas()" disabled>
                <i data-feather="save" class="me-2" style="width: 20px; height: 20px;"></i>
                üíæ Guardar Todo (<span id="contadorGuardar">0</span>)
              </button>
            </div>
          </div>
        </div>
        <!-- ========== FIN CONSOLA DE DIGITACI√ìN R√ÅPIDA ========== -->

        <!-- Tarjeta Principal con Pesta√±as -->
        <div class="card">
          <div class="card-header card-header-corporate d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="ti ti-file-invoice"></i> Control de Flujo de Caja
            </h5>
            <a href="/cartera/crear" class="btn btn-corporate btn-sm">
              <i class="ti ti-plus"></i> Nueva Obligaci√≥n
            </a>
          </div>
          <div class="card-body">
            
            <!-- Nav Tabs -->
            <ul class="nav nav-tabs mb-3" id="carteraTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-entidades" data-bs-toggle="tab" data-bs-target="#content-entidades" type="button" role="tab">
                  <i class="ti ti-building-bank"></i> üí≥ Deudas Entidades (Seguridad Social)
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-clientes" data-bs-toggle="tab" data-bs-target="#content-clientes" type="button" role="tab">
                  <i class="ti ti-users"></i> üìã Cobro a Clientes
                </button>
              </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="carteraTabContent">
              
              <!-- TAB 1: Deudas Entidades (Seguridad Social) -->
              <div class="tab-pane fade show active" id="content-entidades" role="tabpanel">
                <div class="table-responsive">
                  <table class="table table-excel table-bordered table-sm" id="tabla-pagar">
                    <thead>
                      <tr>
                        <th>Empresa</th>
                        <th>Entidad</th>
                        <th>Tipo</th>
                        <th>Per√≠odo</th>
                        <th>Fecha L√≠mite</th>
                        <th class="text-end">Monto</th>
                        <th class="text-center">Estado</th>
                        <th class="text-center">Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="tbody-pagar">
                      <tr>
                        <td colspan="8" class="text-center text-muted">
                          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                          Cargando obligaciones de seguridad social...
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- TAB 2: Cobro a Clientes -->
              <div class="tab-pane fade" id="content-clientes" role="tabpanel">
                <div class="alert alert-info mb-3" role="alert">
                  <i class="ti ti-info-circle me-2"></i>
                  <strong>Gesti√≥n de Cobros:</strong> Clientes con saldos pendientes. Genere cuentas de cobro y env√≠e recordatorios por WhatsApp.
                </div>
                
                <div class="table-responsive">
                  <table class="table table-excel table-bordered table-sm" id="tabla-cobrar">
                    <thead>
                      <tr>
                        <th>Cliente</th>
                        <th>NIT/CC</th>
                        <th>Contacto</th>
                        <th>Tel√©fono</th>
                        <th>Concepto</th>
                        <th>Fecha Vencimiento</th>
                        <th class="text-end">Saldo Pendiente</th>
                        <th class="text-center">Estado</th>
                        <th class="text-center">Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="tbody-cobrar">
                      <tr>
                        <td colspan="9" class="text-center text-muted">
                          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                          Cargando clientes con saldos pendientes...
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

            </div>

          </div>
        </div>

      </div>
    </div>

    {% include '_footer.html' %}

    <script src="/assets/js/plugins/simplebar.min.js"></script>
    <script src="/assets/js/plugins/popper.min.js"></script>
    <script src="/assets/js/icon/custom-icon.js"></script>
    <script src="/assets/js/plugins/feather.min.js"></script>
    <script src="/assets/js/component.js"></script>
    <script src="/assets/js/theme.js"></script>
    <script>
        // --- POLYFILLS PARA TEMA (Ejecutar ANTES de script.js) ---
        // Previene errores de ReferenceError cuando script.js intenta llamar estas funciones
        window.layout_change = window.layout_change || function() {};
        window.layout_theme_sidebar_change = window.layout_theme_sidebar_change || function() {};
        window.change_box_container = window.change_box_container || function() {};
        window.layout_caption_change = window.layout_caption_change || function() {};
        window.layout_rtl_change = window.layout_rtl_change || function() {};
        window.preset_change = window.preset_change || function() {};
        window.main_layout_change = window.main_layout_change || function() {};
    </script>

    <script src="/assets/js/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    {% include '_theme_config.html' %}

    <style>
      .badge-vencido { background-color: #dc3545; color: white; }
      .badge-pendiente { background-color: #ffc107; color: #000; }
      .badge-parcial { background-color: #0dcaf0; color: #000; }
      .badge-pagado { background-color: #198754; color: white; }
      .row-vencida { background-color: #fff5f5 !important; }
      .row-vencida td { color: #dc3545 !important; font-weight: 600; }
      .stat-card { border-left: 4px solid; transition: all 0.3s ease; }
      .stat-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
      .border-l-blue-500 { border-left-color: #3b82f6; }
      .border-l-red-500 { border-left-color: #ef4444; }
      .border-l-green-500 { border-left-color: #22c55e; }
      .border-l-orange-500 { border-left-color: #f97316; }
      .monto { font-family: 'Courier New', monospace; font-weight: 600; }
      .table-responsive { max-height: 600px; overflow-y: auto; }
      .table thead th { position: sticky; top: 0; background-color: #fff; z-index: 10; box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1); }
    </style>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
        let cuentasCobrar = [];
        let obligacionesPagar = [];
        
        cargarStats();
        cargarCuentasCobrar();
        cargarObligacionesPagar();
        
        async function cargarStats() {
          try {
            const response = await fetch('/api/cartera/stats');
            if (!response.ok) throw new Error('Error al cargar estad√≠sticas');
            const stats = await response.json();
            document.getElementById('stat-total-cobrar').textContent = formatMoney(stats.total_cobrar);
            document.getElementById('stat-cartera-vencida').textContent = formatMoney(stats.cartera_vencida);
            document.getElementById('stat-total-pagar').textContent = formatMoney(stats.total_pagar);
            document.getElementById('stat-total-pension').textContent = formatMoney(stats.total_pension);
          } catch (error) {
            console.error('Error cargando estad√≠sticas:', error);
          }
        }
        
        async function cargarCuentasCobrar() {
          try {
            const response = await fetch('/api/cartera/cobrar');
            if (!response.ok) throw new Error('Error al cargar cuentas');
            cuentasCobrar = await response.json();
            renderCuentasCobrar();
          } catch (error) {
            console.error('Error cargando cuentas por cobrar:', error);
            document.getElementById('tbody-cobrar').innerHTML = '<tr><td colspan="7" class="text-center text-danger"><i class="ti ti-alert-circle"></i> Error al cargar datos</td></tr>';
          }
        }
        
        function renderCuentasCobrar() {
          const tbody = document.getElementById('tbody-cobrar');
          if (cuentasCobrar.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted"><i class="ti ti-inbox"></i> No hay clientes con saldos pendientes</td></tr>';
            return;
          }
          tbody.innerHTML = cuentasCobrar.map(cuenta => {
            const esVencida = cuenta.estado === 'Vencido' || (cuenta.estado === 'Pendiente' && new Date(cuenta.fecha_vencimiento) < new Date());
            const rowClass = esVencida ? 'row-vencida' : '';
            const estadoBadge = getBadgeEstado(esVencida ? 'Vencido' : cuenta.estado);
            const montoPendiente = cuenta.monto - (cuenta.monto_pagado || 0);
            const telefono = cuenta.telefono || '';
            const tieneWhatsApp = telefono && telefono.length >= 10;
            
            return `<tr class="${rowClass}">
              <td><strong>${cuenta.nombre_empresa || cuenta.cliente}</strong></td>
              <td>${cuenta.empresa_nit || cuenta.nit || 'N/A'}</td>
              <td>${cuenta.contacto || 'N/A'}</td>
              <td>${telefono || 'Sin tel√©fono'}</td>
              <td>${cuenta.concepto}</td>
              <td>${formatDate(cuenta.fecha_vencimiento)}${esVencida ? '<br><span class="badge bg-danger">VENCIDA</span>' : ''}</td>
              <td class="text-end monto">${formatMoney(montoPendiente)}</td>
              <td class="text-center">${estadoBadge}</td>
              <td class="text-center">
                <div class="btn-group" role="group">
                  <button class="btn btn-sm btn-info" onclick="generarCuentaCobro(${cuenta.id}, '${cuenta.nombre_empresa || cuenta.cliente}')" title="Generar Cuenta de Cobro">
                    <i class="ti ti-file-invoice"></i>
                  </button>
                  ${tieneWhatsApp ? `
                    <button class="btn btn-sm btn-success" onclick="enviarWhatsAppCobro('${telefono}', '${cuenta.nombre_empresa || cuenta.cliente}', ${montoPendiente})" title="Enviar por WhatsApp">
                      <i data-feather="message-circle" class="w-4 h-4"></i>
                    </button>
                  ` : ''}
                </div>
              </td>
            </tr>`;
          }).join('');
          feather.replace();
        }
        
        async function cargarObligacionesPagar() {
          try {
            const response = await fetch('/api/cartera/pagar');
            if (!response.ok) throw new Error('Error al cargar obligaciones');
            obligacionesPagar = await response.json();
            renderObligacionesPagar();
          } catch (error) {
            console.error('Error cargando obligaciones:', error);
            document.getElementById('tbody-pagar').innerHTML = '<tr><td colspan="8" class="text-center text-danger"><i class="ti ti-alert-circle"></i> Error al cargar datos</td></tr>';
          }
        }
        
        function renderObligacionesPagar() {
          const tbody = document.getElementById('tbody-pagar');
          if (obligacionesPagar.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted"><i class="ti ti-inbox"></i> No hay obligaciones registradas</td></tr>';
            return;
          }
          tbody.innerHTML = obligacionesPagar.map(ob => {
            const esVencida = ob.estado === 'Atrasado' || (ob.estado === 'Pendiente' && new Date(ob.fecha_limite) < new Date());
            const rowClass = esVencida ? 'row-vencida' : '';
            const estadoBadge = getBadgeEstado(esVencida ? 'Vencido' : ob.estado);
            return `<tr class="${rowClass}"><td><strong>${ob.nombre_empresa || ob.empresa_nit}</strong><br><small class="text-muted">NIT: ${ob.empresa_nit}</small></td><td>${ob.nombre_entidad}</td><td><span class="badge bg-info">${ob.tipo_entidad}</span></td><td>${ob.periodo}</td><td>${formatDate(ob.fecha_limite)}${esVencida ? '<br><span class="badge bg-danger">VENCIDA</span>' : ''}</td><td class="text-end monto">${formatMoney(ob.monto)}</td><td class="text-center">${estadoBadge}</td><td class="text-center">${ob.estado !== 'Pagado' ? `<button class="btn btn-sm btn-success" onclick="marcarPagadaSS(${ob.id})"><i class="ti ti-check"></i> Pagar</button>` : `<small class="text-muted">Planilla: ${ob.numero_planilla || 'N/A'}</small>`}</td></tr>`;
          }).join('');
        }
        
        window.marcarPagadaCobrar = async function(cuentaId, montoPendiente) {
          const { value: montoPagado } = await Swal.fire({
            title: 'Registrar Pago',
            html: `<p>Monto pendiente: <strong>${formatMoney(montoPendiente)}</strong></p><input type="number" id="monto-pago" class="swal2-input" placeholder="Monto pagado" value="${montoPendiente}" min="0" step="0.01">`,
            showCancelButton: true,
            confirmButtonText: 'Registrar Pago',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
              const monto = document.getElementById('monto-pago').value;
              if (!monto || monto <= 0) { Swal.showValidationMessage('Ingrese un monto v√°lido'); return false; }
              return parseFloat(monto);
            }
          });
          if (montoPagado) {
            try {
              const response = await fetch(`/api/cartera/cobrar/${cuentaId}/pagar`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ monto_pagado: montoPagado }) });
              if (!response.ok) throw new Error('Error al registrar pago');
              Swal.fire({ icon: 'success', title: '¬°Pago Registrado!', text: 'La cuenta ha sido actualizada', timer: 2000, showConfirmButton: false });
              cargarStats(); cargarCuentasCobrar();
            } catch (error) { Swal.fire({ icon: 'error', title: 'Error', text: error.message }); }
          }
        };
        
        /**
         * Generar cuenta de cobro en PDF
         */
        window.generarCuentaCobro = async function(cuentaId, clienteNombre) {
          try {
            Swal.fire({
              title: 'Generando Cuenta de Cobro...',
              html: `Cliente: <strong>${clienteNombre}</strong>`,
              allowOutsideClick: false,
              showConfirmButton: false,
              didOpen: () => { Swal.showLoading(); }
            });

            const response = await fetch(`/api/cartera/cobrar/${cuentaId}/cuenta-cobro`, {
              method: 'GET',
              credentials: 'include'
            });

            if (!response.ok) throw new Error('Error al generar cuenta de cobro');

            // Descargar PDF
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cuenta_cobro_${clienteNombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            Swal.fire({
              icon: 'success',
              title: '¬°Cuenta de Cobro Generada!',
              text: 'El PDF se ha descargado correctamente',
              timer: 2000,
              showConfirmButton: false
            });

            console.log('‚úÖ Cuenta de cobro generada para:', clienteNombre);

          } catch (error) {
            console.error('‚ùå Error generando cuenta de cobro:', error);
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: error.message
            });
          }
        };

        /**
         * Enviar recordatorio de cobro por WhatsApp
         */
        window.enviarWhatsAppCobro = function(telefono, clienteNombre, montoPendiente) {
          if (!telefono) {
            Swal.fire({
              icon: 'warning',
              title: 'Sin Tel√©fono',
              text: 'Este cliente no tiene un n√∫mero de tel√©fono registrado'
            });
            return;
          }

          // Limpiar el n√∫mero
          const telefonoLimpio = telefono.replace(/\D/g, '');

          // Mensaje predefinido de cobro
          const mensaje = `Hola ${clienteNombre},\n\nLe recordamos que tiene un saldo pendiente de ${formatMoney(montoPendiente)} por concepto de servicios prestados.\n\nPor favor proceda con el pago a la brevedad posible.\n\n¬°Gracias!\nMontero y Negocio`;

          // Generar URL de WhatsApp
          const whatsappURL = `https://wa.me/57${telefonoLimpio}?text=${encodeURIComponent(mensaje)}`;

          // Abrir WhatsApp Web
          window.open(whatsappURL, '_blank');

          console.log('üì± WhatsApp abierto para cobro a:', clienteNombre);
        };
        
        window.marcarPagadaSS = async function(obligacionId) {
          const { value: formValues } = await Swal.fire({
            title: 'Registrar Pago de Planilla',
            html: '<input type="text" id="numero-planilla" class="swal2-input" placeholder="N√∫mero de planilla (opcional)">',
            showCancelButton: true,
            confirmButtonText: 'Marcar como Pagada',
            cancelButtonText: 'Cancelar',
            preConfirm: () => ({ numero_planilla: document.getElementById('numero-planilla').value })
          });
          if (formValues) {
            try {
              const response = await fetch(`/api/cartera/pagar/${obligacionId}/pagar`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formValues) });
              if (!response.ok) throw new Error('Error al registrar pago');
              Swal.fire({ icon: 'success', title: '¬°Pago Registrado!', text: 'La obligaci√≥n ha sido marcada como pagada', timer: 2000, showConfirmButton: false });
              cargarStats(); cargarObligacionesPagar();
            } catch (error) { Swal.fire({ icon: 'error', title: 'Error', text: error.message }); }
          }
        };
        
        function formatMoney(amount) {
          return '$ ' + parseFloat(amount || 0).toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
        
        function formatDate(dateString) {
          if (!dateString) return '‚Äî';
          const date = new Date(dateString);
          return date.toLocaleDateString('es-CO', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        
        function getBadgeEstado(estado) {
          const badges = {
            'Pendiente': '<span class="badge badge-pendiente">Pendiente</span>',
            'Vencido': '<span class="badge badge-vencido">Vencido</span>',
            'Pagado': '<span class="badge badge-pagado">Pagado</span>',
            'Parcial': '<span class="badge badge-parcial">Parcial</span>',
            'Atrasado': '<span class="badge badge-vencido">Atrasado</span>'
          };
          return badges[estado] || `<span class="badge bg-secondary">${estado}</span>`;
        }
        
        // ========== CONSOLA DE DIGITACI√ìN R√ÅPIDA ==========
        let deudas_temporales = [];
        let usuariosCache = [];
        let empresasCache = [];
        
        // Cargar usuarios y empresas al iniciar
        async function cargarDatosAutocomplete() {
          try {
            // Cargar usuarios
            const respUsuarios = await fetch('/api/usuarios');
            const dataUsuarios = await respUsuarios.json();
            usuariosCache = dataUsuarios.items ? dataUsuarios.items : (Array.isArray(dataUsuarios) ? dataUsuarios : []);
            
            // Cargar empresas
            const respEmpresas = await fetch('/api/empresas');
            const dataEmpresas = await respEmpresas.json();
            empresasCache = dataEmpresas.items ? dataEmpresas.items : (Array.isArray(dataEmpresas) ? dataEmpresas : []);
            
            // Poblar datalists
            poblarDatalistUsuarios();
            poblarDatalistEmpresas();
          } catch (error) {
            console.error('Error cargando datos para autocompletado:', error);
          }
        }
        
        function poblarDatalistUsuarios() {
          const datalist = document.getElementById('usuariosDatalist');
          datalist.innerHTML = usuariosCache.map(u => {
            const nombre = u.nombre || u.primer_nombre + ' ' + u.primer_apellido;
            return `<option value="${u.id_usuario || u.identificacion}">${u.id_usuario || u.identificacion} - ${nombre}</option>`;
          }).join('');
        }
        
        function poblarDatalistEmpresas() {
          const datalist = document.getElementById('empresasDatalist');
          datalist.innerHTML = empresasCache.map(e => {
            return `<option value="${e.nit}">${e.nit} - ${e.nombre}</option>`;
          }).join('');
        }
        
        // Actualizar displays cuando se selecciona
        document.getElementById('inputIdUsuario')?.addEventListener('input', function(e) {
          const valor = e.target.value.split(' - ')[0].trim();
          const usuario = usuariosCache.find(u => (u.id_usuario || u.identificacion) == valor);
          const display = document.getElementById('nombreUsuarioDisplay');
          if (usuario) {
            const nombre = usuario.nombre || usuario.primer_nombre + ' ' + usuario.primer_apellido;
            display.textContent = nombre;
            display.classList.add('text-success');
          } else {
            display.textContent = '-';
            display.classList.remove('text-success');
          }
        });
        
        document.getElementById('inputNitEmpresa')?.addEventListener('input', function(e) {
          const valor = e.target.value.split(' - ')[0].trim();
          const empresa = empresasCache.find(emp => emp.nit == valor);
          const display = document.getElementById('nombreEmpresaDisplay');
          if (empresa) {
            display.textContent = empresa.nombre;
            display.classList.add('text-success');
          } else {
            display.textContent = '-';
            display.classList.remove('text-success');
          }
        });
        
        // Manejar submit del formulario de digitaci√≥n
        document.getElementById('formDigitacionRapida')?.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const idUsuario = document.getElementById('inputIdUsuario').value.split(' - ')[0].trim();
          const nitEmpresa = document.getElementById('inputNitEmpresa').value.split(' - ')[0].trim();
          const entidad = document.getElementById('selectEntidad').value;
          const monto = parseFloat(document.getElementById('inputMonto').value);
          const diasMora = parseInt(document.getElementById('inputDiasMora').value);
          
          // Buscar nombres
          const usuario = usuariosCache.find(u => (u.id_usuario || u.identificacion) == idUsuario);
          const empresa = empresasCache.find(e => e.nit == nitEmpresa);
          
          if (!usuario) {
            Swal.fire('Error', 'Usuario no encontrado', 'error');
            return;
          }
          
          if (!empresa) {
            Swal.fire('Error', 'Empresa no encontrada', 'error');
            return;
          }
          
          // Agregar a la tabla temporal
          const deuda = {
            id_temporal: Date.now(),
            id_usuario: idUsuario,
            nombre_usuario: usuario.nombre || usuario.primer_nombre + ' ' + usuario.primer_apellido,
            nit_empresa: nitEmpresa,
            nombre_empresa: empresa.nombre,
            entidad: entidad,
            monto: monto,
            dias_mora: diasMora
          };
          
          deudas_temporales.push(deuda);
          renderTablaDigitacion();
          
          // Limpiar formulario
          e.target.reset();
          document.getElementById('nombreUsuarioDisplay').textContent = '-';
          document.getElementById('nombreEmpresaDisplay').textContent = '-';
          document.getElementById('inputIdUsuario').focus();
          
          // Feedback visual
          Swal.fire({
            icon: 'success',
            title: 'Agregado',
            text: 'Deuda agregada a la lista temporal',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000
          });
        });
        
        function renderTablaDigitacion() {
          const tbody = document.getElementById('tbodyDigitacionTemporal');
          const contador = deudas_temporales.length;
          
          document.getElementById('contadorTemporal').textContent = contador;
          document.getElementById('contadorGuardar').textContent = contador;
          document.getElementById('btnGuardarTodo').disabled = contador === 0;
          
          if (contador === 0) {
            tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-4"><i data-feather="inbox" class="me-2"></i>No hay deudas pendientes de guardar</td></tr>`;
            feather.replace();
            return;
          }
          
          tbody.innerHTML = deudas_temporales.map((deuda, idx) => `
            <tr>
              <td class="text-center">${idx + 1}</td>
              <td><code>${deuda.id_usuario}</code></td>
              <td>${deuda.nombre_usuario}</td>
              <td><code>${deuda.nit_empresa}</code></td>
              <td>${deuda.nombre_empresa}</td>
              <td><span class="badge bg-info">${deuda.entidad}</span></td>
              <td class="text-end"><strong>$${deuda.monto.toLocaleString('es-CO')}</strong></td>
              <td class="text-center">${deuda.dias_mora > 0 ? `<span class="badge bg-danger">${deuda.dias_mora} d√≠as</span>` : '<span class="badge bg-success">0 d√≠as</span>'}</td>
              <td class="text-center">
                <button class="btn btn-sm btn-danger" onclick="eliminarDeudaTemporal(${deuda.id_temporal})" title="Eliminar">
                  <i data-feather="trash-2" style="width: 14px; height: 14px;"></i>
                </button>
              </td>
            </tr>
          `).join('');
          
          feather.replace();
        }
        
        window.eliminarDeudaTemporal = function(idTemporal) {
          deudas_temporales = deudas_temporales.filter(d => d.id_temporal !== idTemporal);
          renderTablaDigitacion();
        }
        
        window.limpiarTablaTemporal = function() {
          if (deudas_temporales.length === 0) return;
          
          Swal.fire({
            title: '¬øLimpiar todo?',
            text: `Se eliminar√°n ${deudas_temporales.length} deuda(s) pendiente(s)`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'S√≠, limpiar',
            cancelButtonText: 'Cancelar'
          }).then((result) => {
            if (result.isConfirmed) {
              deudas_temporales = [];
              renderTablaDigitacion();
              Swal.fire('Limpiado', 'Tabla temporal limpiada', 'success');
            }
          });
        }
        
        window.guardarTodasLasDeudas = async function() {
          if (deudas_temporales.length === 0) return;
          
          const resultado = await Swal.fire({
            title: 'Confirmar Guardado',
            html: `¬øDesea guardar <strong>${deudas_temporales.length}</strong> deuda(s) manualmente ingresada(s)?<br><small class="text-muted">Esta acci√≥n no se puede deshacer</small>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#10b981',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'üíæ Guardar Todo',
            cancelButtonText: 'Cancelar'
          });
          
          if (!resultado.isConfirmed) return;
          
          try {
            const response = await fetch('/api/cartera/deudas/batch', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ deudas: deudas_temporales })
            });
            
            if (!response.ok) throw new Error('Error al guardar');
            
            const data = await response.json();
            
            Swal.fire({
              icon: 'success',
              title: '¬°Guardado Exitoso!',
              html: `Se guardaron <strong>${data.guardadas || deudas_temporales.length}</strong> deuda(s) en el sistema`,
              confirmButtonColor: '#10b981'
            });
            
            // Limpiar y recargar
            deudas_temporales = [];
            renderTablaDigitacion();
            cargarCartera();
          } catch (error) {
            console.error('Error guardando deudas:', error);
            Swal.fire('Error', 'No se pudieron guardar las deudas: ' + error.message, 'error');
          }
        }
        
        // Inicializar autocompletado
        cargarDatosAutocomplete();
        // ========== FIN CONSOLA DE DIGITACI√ìN R√ÅPIDA ==========
      });
    </script>

    <!-- Sistema de B√∫squeda Universal -->
    <script src="/assets/js/universal-search.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof UniversalSearch !== 'undefined') {
            // Buscar el input de ID de usuario en Speed Entry
            const buscadorCartera = new UniversalSearch({
                inputId: 'inputIdUsuario',
                mapping: {
                    'numeroId': '#inputIdUsuario'
                },
                callback: function(usuario) {
                    // Autocompletar ID de usuario en el formulario
                    const inputIdUsuario = document.getElementById('inputIdUsuario');
                    if (inputIdUsuario && usuario.numeroId) {
                        inputIdUsuario.value = usuario.numeroId;
                        
                        // Actualizar display de nombre
                        const nombreDisplay = document.getElementById('nombreUsuarioDisplay');
                        if (nombreDisplay) {
                            const nombreCompleto = `${usuario.primerNombre || ''} ${usuario.primerApellido || ''}`.trim();
                            nombreDisplay.textContent = nombreCompleto;
                            nombreDisplay.classList.add('text-success');
                            nombreDisplay.classList.remove('text-danger');
                        }
                        
                        // Desbloquear campo de Monto (Speed Entry)
                        const inputMonto = document.getElementById('inputMonto');
                        if (inputMonto) {
                            inputMonto.disabled = false;
                            inputMonto.focus();
                        }
                        
                        console.log('‚úÖ Usuario encontrado en cartera:', usuario);
                    }
                }
            });
            console.log('‚úÖ Buscador Universal activado en Cartera (Speed Entry)');
        }
    });
    </script>

  </body>
</html>
