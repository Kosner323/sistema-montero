<!doctype html>
<html lang="es" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
  <head>
    <meta charset="utf-8" />
    <title>GestiÃ³n de Cartera | Portal Montero</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="Sistema de gestiÃ³n de cartera - Cuentas por cobrar y seguridad social" />
    <meta name="author" content="Montero y Negocio" />
    <link rel="icon" href="/assets/images/favicon.svg" type="image/x-icon" />

    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/fonts/phosphor/duotone/style.css" />
    <link rel="stylesheet" href="/assets/fonts/tabler-icons.min.css" />
    <link rel="stylesheet" href="/assets/fonts/feather.css" />
    <link rel="stylesheet" href="/assets/fonts/fontawesome.css" />
    <link rel="stylesheet" href="/assets/fonts/material.css" />
    <link rel="stylesheet" href="/assets/css/style.css" id="main-style-link" />

    <script>
      (async function checkAuthentication() {
        const loader = document.querySelector('.loader-bg');
        if (loader) loader.style.display = 'flex';

        try {
          const response = await fetch('/api/check_auth', {
            method: 'GET',
            headers: { 'Accept': 'application/json' },
            credentials: 'include'
          });

          if (!response.ok) {
            window.location.href = '/login';
            return;
          }

          const data = await response.json();

          if (!data.authenticated) {
            window.location.href = '/login';
          } else {
            if (loader) loader.style.display = 'none';
            sessionStorage.setItem('userName', data.user_name);
          }
        } catch (error) {
          console.error('Error de autenticaciÃ³n:', error);
          window.location.href = '/login';
        }
      })();
    </script>
  </head>
  <body>
    <div class="loader-bg fixed inset-0 bg-white dark:bg-themedark-cardbg z-[1034]" style="display: flex;">
      <div class="loader-track h-[5px] w-full inline-block absolute overflow-hidden top-0">
        <div class="loader-fill w-[300px] h-[5px] bg-primary-500 absolute top-0 left-0 animate-[hitZak_0.6s_ease-in-out_infinite_alternate]"></div>
      </div>
    </div>

    {% include '_sidebar.html' %}
    {% include '_header.html' %}

    <div class="pc-container">
      <div class="pc-content">
        
        <!-- Encabezado de PÃ¡gina -->
        <div class="page-header">
          <div class="page-block">
            <div class="row align-items-center">
              <div class="col-md-12">
                <ul class="breadcrumb">
                  <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                  <li class="breadcrumb-item"><a href="/pagos">Pagos</a></li>
                  <li class="breadcrumb-item" aria-current="page">Cartera</li>
                </ul>
              </div>
              <div class="col-md-12">
                <div class="page-header-title">
                  <h2 class="mb-0">ðŸ’° GestiÃ³n de Cartera</h2>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tarjetas de MÃ©tricas Ejecutivas -->
        <div class="row mb-4 g-3">
          <div class="col-xl-3 col-md-6">
            <div class="card shadow-none border">
              <div class="card-body p-3">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <h6 class="text-muted mb-1 small text-uppercase fw-bold">Total Cartera</h6>
                    <h3 class="mb-0 fw-bold text-dark" id="stat-total-cobrar">$ 0</h3>
                    <small class="text-success fw-medium">
                      <i data-feather="trending-up" style="width: 14px; height: 14px;"></i> +12.5% vs mes anterior
                    </small>
                  </div>
                  <div class="avatar bg-light-primary text-primary rounded p-2">
                    <i data-feather="dollar-sign" style="width: 24px; height: 24px;"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-xl-3 col-md-6">
            <div class="card shadow-none border">
              <div class="card-body p-3">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <h6 class="text-muted mb-1 small text-uppercase fw-bold">Cartera Vencida</h6>
                    <h3 class="mb-0 fw-bold text-dark" id="stat-cartera-vencida">$ 0</h3>
                    <small class="text-danger fw-medium">
                      <i data-feather="trending-down" style="width: 14px; height: 14px;"></i> Requiere atenciÃ³n
                    </small>
                  </div>
                  <div class="avatar bg-light-danger text-danger rounded p-2">
                    <i data-feather="alert-circle" style="width: 24px; height: 24px;"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-xl-3 col-md-6">
            <div class="card shadow-none border">
              <div class="card-body p-3">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <h6 class="text-muted mb-1 small text-uppercase fw-bold">Recaudo del Mes</h6>
                    <h3 class="mb-0 fw-bold text-dark" id="stat-total-pagar">$ 0</h3>
                    <small class="text-success fw-medium">
                      <i data-feather="trending-up" style="width: 14px; height: 14px;"></i> +18.3% vs mes anterior
                    </small>
                  </div>
                  <div class="avatar bg-light-success text-success rounded p-2">
                    <i data-feather="pie-chart" style="width: 24px; height: 24px;"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-xl-3 col-md-6">
            <div class="card shadow-none border">
              <div class="card-body p-3">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <h6 class="text-muted mb-1 small text-uppercase fw-bold">Clientes Deudores</h6>
                    <h3 class="mb-0 fw-bold text-dark" id="stat-total-pension">0</h3>
                    <small class="text-warning fw-medium">
                      <i data-feather="alert-triangle" style="width: 14px; height: 14px;"></i> En seguimiento activo
                    </small>
                  </div>
                  <div class="avatar bg-light-warning text-warning rounded p-2">
                    <i data-feather="users" style="width: 24px; height: 24px;"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tarjeta Principal con PestaÃ±as -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="ti ti-file-invoice"></i> Control de Flujo de Caja
            </h5>
            <a href="/cartera/crear" class="btn btn-primary btn-sm">
              <i class="ti ti-plus"></i> Nueva ObligaciÃ³n
            </a>
          </div>
          <div class="card-body">
            
            <!-- Nav Tabs -->
            <ul class="nav nav-tabs mb-3" id="carteraTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-cobrar" data-bs-toggle="tab" data-bs-target="#content-cobrar" type="button" role="tab">
                  <i class="ti ti-arrow-down-circle"></i> ðŸ“¥ Cuentas por Cobrar (Clientes)
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-pagar" data-bs-toggle="tab" data-bs-target="#content-pagar" type="button" role="tab">
                  <i class="ti ti-arrow-up-circle"></i> ðŸ“¤ Seguridad Social (Pasivos)
                </button>
              </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="carteraTabContent">
              
              <!-- TAB 1: Cuentas por Cobrar -->
              <div class="tab-pane fade show active" id="content-cobrar" role="tabpanel">
                <div class="table-responsive">
                  <table class="table table-hover table-bordered text-sm whitespace-nowrap" id="tabla-cobrar">
                    <thead>
                      <tr>
                        <th>Cliente</th>
                        <th>Concepto</th>
                        <th>Fecha Vencimiento</th>
                        <th class="text-end">Monto</th>
                        <th class="text-end">Pagado</th>
                        <th class="text-center">Estado</th>
                        <th class="text-center">Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="tbody-cobrar">
                      <tr>
                        <td colspan="7" class="text-center text-muted">
                          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                          Cargando cuentas por cobrar...
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- TAB 2: Seguridad Social -->
              <div class="tab-pane fade" id="content-pagar" role="tabpanel">
                <div class="table-responsive">
                  <table class="table table-hover table-bordered text-sm whitespace-nowrap" id="tabla-pagar">
                    <thead>
                      <tr>
                        <th>Empresa</th>
                        <th>Entidad</th>
                        <th>Tipo</th>
                        <th>PerÃ­odo</th>
                        <th>Fecha LÃ­mite</th>
                        <th class="text-end">Monto</th>
                        <th class="text-center">Estado</th>
                        <th class="text-center">Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="tbody-pagar">
                      <tr>
                        <td colspan="8" class="text-center text-muted">
                          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                          Cargando obligaciones de seguridad social...
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

            </div>

          </div>
        </div>

      </div>
    </div>

    {% include '_footer.html' %}

    <script src="/assets/js/plugins/simplebar.min.js"></script>
    <script src="/assets/js/plugins/popper.min.js"></script>
    <script src="/assets/js/icon/custom-icon.js"></script>
    <script src="/assets/js/plugins/feather.min.js"></script>
    <script src="/assets/js/component.js"></script>
    <script src="/assets/js/theme.js"></script>
    <script>
        // --- POLYFILLS PARA TEMA (Ejecutar ANTES de script.js) ---
        // Previene errores de ReferenceError cuando script.js intenta llamar estas funciones
        window.layout_change = window.layout_change || function() {};
        window.layout_theme_sidebar_change = window.layout_theme_sidebar_change || function() {};
        window.change_box_container = window.change_box_container || function() {};
        window.layout_caption_change = window.layout_caption_change || function() {};
        window.layout_rtl_change = window.layout_rtl_change || function() {};
        window.preset_change = window.preset_change || function() {};
        window.main_layout_change = window.main_layout_change || function() {};
    </script>

    <script src="/assets/js/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    {% include '_theme_config.html' %}

    <style>
      .badge-vencido { background-color: #dc3545; color: white; }
      .badge-pendiente { background-color: #ffc107; color: #000; }
      .badge-parcial { background-color: #0dcaf0; color: #000; }
      .badge-pagado { background-color: #198754; color: white; }
      .row-vencida { background-color: #fff5f5 !important; }
      .row-vencida td { color: #dc3545 !important; font-weight: 600; }
      .stat-card { border-left: 4px solid; transition: all 0.3s ease; }
      .stat-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
      .border-l-blue-500 { border-left-color: #3b82f6; }
      .border-l-red-500 { border-left-color: #ef4444; }
      .border-l-green-500 { border-left-color: #22c55e; }
      .border-l-orange-500 { border-left-color: #f97316; }
      .monto { font-family: 'Courier New', monospace; font-weight: 600; }
      .table-responsive { max-height: 600px; overflow-y: auto; }
      .table thead th { position: sticky; top: 0; background-color: #fff; z-index: 10; box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1); }
    </style>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
        let cuentasCobrar = [];
        let obligacionesPagar = [];
        
        cargarStats();
        cargarCuentasCobrar();
        cargarObligacionesPagar();
        
        async function cargarStats() {
          try {
            const response = await fetch('/api/cartera/stats');
            if (!response.ok) throw new Error('Error al cargar estadÃ­sticas');
            const stats = await response.json();
            document.getElementById('stat-total-cobrar').textContent = formatMoney(stats.total_cobrar);
            document.getElementById('stat-cartera-vencida').textContent = formatMoney(stats.cartera_vencida);
            document.getElementById('stat-total-pagar').textContent = formatMoney(stats.total_pagar);
            document.getElementById('stat-total-pension').textContent = formatMoney(stats.total_pension);
          } catch (error) {
            console.error('Error cargando estadÃ­sticas:', error);
          }
        }
        
        async function cargarCuentasCobrar() {
          try {
            const response = await fetch('/api/cartera/cobrar');
            if (!response.ok) throw new Error('Error al cargar cuentas');
            cuentasCobrar = await response.json();
            renderCuentasCobrar();
          } catch (error) {
            console.error('Error cargando cuentas por cobrar:', error);
            document.getElementById('tbody-cobrar').innerHTML = '<tr><td colspan="7" class="text-center text-danger"><i class="ti ti-alert-circle"></i> Error al cargar datos</td></tr>';
          }
        }
        
        function renderCuentasCobrar() {
          const tbody = document.getElementById('tbody-cobrar');
          if (cuentasCobrar.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted"><i class="ti ti-inbox"></i> No hay cuentas por cobrar registradas</td></tr>';
            return;
          }
          tbody.innerHTML = cuentasCobrar.map(cuenta => {
            const esVencida = cuenta.estado === 'Vencido' || (cuenta.estado === 'Pendiente' && new Date(cuenta.fecha_vencimiento) < new Date());
            const rowClass = esVencida ? 'row-vencida' : '';
            const estadoBadge = getBadgeEstado(esVencida ? 'Vencido' : cuenta.estado);
            const montoPendiente = cuenta.monto - (cuenta.monto_pagado || 0);
            return `<tr class="${rowClass}"><td><strong>${cuenta.nombre_empresa || cuenta.empresa_nit}</strong><br><small class="text-muted">NIT: ${cuenta.empresa_nit}</small></td><td>${cuenta.concepto}</td><td>${formatDate(cuenta.fecha_vencimiento)}${esVencida ? '<br><span class="badge bg-danger">VENCIDA</span>' : ''}</td><td class="text-end monto">${formatMoney(cuenta.monto)}</td><td class="text-end monto">${formatMoney(cuenta.monto_pagado || 0)}</td><td class="text-center">${estadoBadge}</td><td class="text-center">${cuenta.estado !== 'Pagado' ? `<button class="btn btn-sm btn-success" onclick="marcarPagadaCobrar(${cuenta.id}, ${montoPendiente})"><i class="ti ti-check"></i> Pagar</button>` : '<span class="text-muted">â€”</span>'}</td></tr>`;
          }).join('');
        }
        
        async function cargarObligacionesPagar() {
          try {
            const response = await fetch('/api/cartera/pagar');
            if (!response.ok) throw new Error('Error al cargar obligaciones');
            obligacionesPagar = await response.json();
            renderObligacionesPagar();
          } catch (error) {
            console.error('Error cargando obligaciones:', error);
            document.getElementById('tbody-pagar').innerHTML = '<tr><td colspan="8" class="text-center text-danger"><i class="ti ti-alert-circle"></i> Error al cargar datos</td></tr>';
          }
        }
        
        function renderObligacionesPagar() {
          const tbody = document.getElementById('tbody-pagar');
          if (obligacionesPagar.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted"><i class="ti ti-inbox"></i> No hay obligaciones registradas</td></tr>';
            return;
          }
          tbody.innerHTML = obligacionesPagar.map(ob => {
            const esVencida = ob.estado === 'Atrasado' || (ob.estado === 'Pendiente' && new Date(ob.fecha_limite) < new Date());
            const rowClass = esVencida ? 'row-vencida' : '';
            const estadoBadge = getBadgeEstado(esVencida ? 'Vencido' : ob.estado);
            return `<tr class="${rowClass}"><td><strong>${ob.nombre_empresa || ob.empresa_nit}</strong><br><small class="text-muted">NIT: ${ob.empresa_nit}</small></td><td>${ob.nombre_entidad}</td><td><span class="badge bg-info">${ob.tipo_entidad}</span></td><td>${ob.periodo}</td><td>${formatDate(ob.fecha_limite)}${esVencida ? '<br><span class="badge bg-danger">VENCIDA</span>' : ''}</td><td class="text-end monto">${formatMoney(ob.monto)}</td><td class="text-center">${estadoBadge}</td><td class="text-center">${ob.estado !== 'Pagado' ? `<button class="btn btn-sm btn-success" onclick="marcarPagadaSS(${ob.id})"><i class="ti ti-check"></i> Pagar</button>` : `<small class="text-muted">Planilla: ${ob.numero_planilla || 'N/A'}</small>`}</td></tr>`;
          }).join('');
        }
        
        window.marcarPagadaCobrar = async function(cuentaId, montoPendiente) {
          const { value: montoPagado } = await Swal.fire({
            title: 'Registrar Pago',
            html: `<p>Monto pendiente: <strong>${formatMoney(montoPendiente)}</strong></p><input type="number" id="monto-pago" class="swal2-input" placeholder="Monto pagado" value="${montoPendiente}" min="0" step="0.01">`,
            showCancelButton: true,
            confirmButtonText: 'Registrar Pago',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
              const monto = document.getElementById('monto-pago').value;
              if (!monto || monto <= 0) { Swal.showValidationMessage('Ingrese un monto vÃ¡lido'); return false; }
              return parseFloat(monto);
            }
          });
          if (montoPagado) {
            try {
              const response = await fetch(`/api/cartera/cobrar/${cuentaId}/pagar`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ monto_pagado: montoPagado }) });
              if (!response.ok) throw new Error('Error al registrar pago');
              Swal.fire({ icon: 'success', title: 'Â¡Pago Registrado!', text: 'La cuenta ha sido actualizada', timer: 2000, showConfirmButton: false });
              cargarStats(); cargarCuentasCobrar();
            } catch (error) { Swal.fire({ icon: 'error', title: 'Error', text: error.message }); }
          }
        };
        
        window.marcarPagadaSS = async function(obligacionId) {
          const { value: formValues } = await Swal.fire({
            title: 'Registrar Pago de Planilla',
            html: '<input type="text" id="numero-planilla" class="swal2-input" placeholder="NÃºmero de planilla (opcional)">',
            showCancelButton: true,
            confirmButtonText: 'Marcar como Pagada',
            cancelButtonText: 'Cancelar',
            preConfirm: () => ({ numero_planilla: document.getElementById('numero-planilla').value })
          });
          if (formValues) {
            try {
              const response = await fetch(`/api/cartera/pagar/${obligacionId}/pagar`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formValues) });
              if (!response.ok) throw new Error('Error al registrar pago');
              Swal.fire({ icon: 'success', title: 'Â¡Pago Registrado!', text: 'La obligaciÃ³n ha sido marcada como pagada', timer: 2000, showConfirmButton: false });
              cargarStats(); cargarObligacionesPagar();
            } catch (error) { Swal.fire({ icon: 'error', title: 'Error', text: error.message }); }
          }
        };
        
        function formatMoney(amount) {
          return '$ ' + parseFloat(amount || 0).toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
        
        function formatDate(dateString) {
          if (!dateString) return 'â€”';
          const date = new Date(dateString);
          return date.toLocaleDateString('es-CO', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        
        function getBadgeEstado(estado) {
          const badges = {
            'Pendiente': '<span class="badge badge-pendiente">Pendiente</span>',
            'Vencido': '<span class="badge badge-vencido">Vencido</span>',
            'Pagado': '<span class="badge badge-pagado">Pagado</span>',
            'Parcial': '<span class="badge badge-parcial">Parcial</span>',
            'Atrasado': '<span class="badge badge-vencido">Atrasado</span>'
          };
          return badges[estado] || `<span class="badge bg-secondary">${estado}</span>`;
        }
      });
    </script>

  </body>
</html>
