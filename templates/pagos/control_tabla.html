<!doctype html>
<html lang="en" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
  <head>
    <title>Tabla de Control de Pagos | Portal Montero</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="Sistema de control y gestión de pagos de planillas - Portal Montero" />
    <meta name="author" content="Portal Montero" />
    <link rel="icon" href="/assets/images/favicon.svg" type="image/x-icon" />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/fonts/phosphor/duotone/style.css" />
    <link rel="stylesheet" href="/assets/fonts/tabler-icons.min.css" />
    <link rel="stylesheet" href="/assets/fonts/feather.css" />
    <link rel="stylesheet" href="/assets/fonts/fontawesome.css" />
    <link rel="stylesheet" href="/assets/fonts/material.css" />
    <link rel="stylesheet" href="/assets/css/style.css" id="main-style-link" />
    <!-- ✅ REDISEÑO CORPORATIVO ENTERPRISE -->
    <link rel="stylesheet" href="/assets/css/corporate-redesign.css" />
    
    <style>
        .row-pendiente {
            background-color: #ffeaea !important; /* Fondo muy claro para indicar PENDIENTE */
        }
    </style>
  </head>
  <body>
    <div class="loader-bg fixed inset-0 bg-white dark:bg-themedark-cardbg z-[1034]">
  <div class="loader-track h-[5px] w-full inline-block absolute overflow-hidden top-0">
    <div class="loader-fill w-[300px] h-[5px] bg-primary-500 absolute top-0 left-0 animate-[hitZak_0.6s_ease-in-out_infinite_alternate]"></div>
  </div>
</div>
{% include '_sidebar.html' %}
{% include '_header.html' %}
<div class="pc-container">
      <div class="pc-content">
        <div class="page-header">
          <div class="page-block">
            <div class="page-header-title">
              <h5 class="mb-0 font-medium">Tabla de Control de Pagos y Liquidación (PILA)</h5>
            </div>
            <ul class="breadcrumb">
              <li class="breadcrumb-item"><a href="/dashboard">Home</a></li>
              <li class="breadcrumb-item"><a href="#!">Contabilidad</a></li>
              <li class="breadcrumb-item" aria-current="page">Tabla</li>
            </ul>
          </div>
        </div>

        <div class="grid grid-cols-12 gap-x-6">
          
          <div class="col-span-12">
            <div class="card-flat">
                <div class="card-header card-header-corporate flex justify-between items-center">
                    <h5 class="mb-0">Detalle de Empleados y Aportes</h5>
                    <div class="flex items-center space-x-2">
                        <select class="form-select form-select-sm w-auto" id="filtroEmpresa">
                            <option value="todos" selected>Todas las Empresas</option>
                        </select>
                        
                        <select class="form-select form-select-sm w-auto" id="filtroEstado">
                            <option value="todos" selected>Todos los Estados</option>
                            <option value="Pagado">✅ Pagado</option>
                            <option value="Pendiente">⏳ Pendiente</option>
                            <option value="Moroso">📢 Morosos</option>
                        </select>

                        <input type="month" class="form-control form-control-sm w-auto" id="filtroMes" value="">
                        
                        <button class="btn btn-corporate btn-sm" id="btnConsultar">
                            <i data-feather="search" class="mr-1"></i> Consultar
                        </button>

                        <button class="btn btn-excel btn-sm" data-bs-toggle="modal" data-bs-target="#modalExportarExcel">
                            <i data-feather="download" class="mr-1"></i> 📊 Exportar
                        </button>

                        <span id="whatsappReminderContainer" style="display: none;">
                            <button class="btn btn-success btn-sm" id="btnEnviarRecordatorio">
                                <i class="ti ti-brand-whatsapp mr-1"></i> Recordatorio
                            </button>
                        </span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <p class="text-muted px-3 pt-3 mb-2" style="font-size: 0.85rem;">Lista detallada de empleados. El color del estado indica el pago de seguridad social para el periodo seleccionado.</p>
                    <div class="table-responsive">
                        <table class="table table-excel table-bordered table-sm" id="tablaPagos">
                            <thead>
                                <tr>
                                    <th rowspan="2" class="align-middle"><input type="checkbox" id="selectAll" onclick="toggleAll(this)"></th>
                                    
                                    <th rowspan="2" class="align-middle">ID</th>
                                    <th rowspan="2" class="align-middle">NOMBRE(S)</th>
                                    <th rowspan="2" class="align-middle">APELLIDO(S)</th>
                                    <th rowspan="2" class="align-middle">EDAD</th>
                                    
                                    <th rowspan="2" class="align-middle">ESTADO</th>
                                    <th rowspan="2" class="align-middle">PERIODO</th>
                                    
                                    <th colspan="4" class="text-center">ENTIDADES SEG. SOCIAL</th>
                                    
                                    <th colspan="3" class="text-center">DATOS INGRESO/BASE</th>
                                    
                                    <th colspan="5" class="text-center">APORTES ($COP)</th>
                                    
                                    <th rowspan="2" class="align-middle">TOTAL</th>
                                    <th rowspan="2" class="align-middle">ACC.</th>
                                </tr>
                                <tr>
                                    <th>EPS</th>
                                    <th>ARL</th>
                                    <th>AFP</th>
                                    <th>CCF</th>
                                    
                                    <th>F.INGRESO</th>
                                    <th>MES</th>
                                    <th>IBC</th>
                                    
                                    <th>EPS</th>
                                    <th>ARL</th>
                                    <th>AFP</th>
                                    <th>CCF</th>
                                    <th>ADM.</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
          </div>
        </div>
        </div>
</div>

<!-- Modal: Exportar Excel para Contador -->
<div class="modal fade" id="modalExportarExcel" tabindex="-1" aria-labelledby="modalExportarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: #217346; color: white;">
                <h5 class="modal-title" id="modalExportarLabel">
                    <i data-feather="download" class="inline mr-2"></i>
                    📊 Exportar Reporte Contable
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">Seleccione el periodo a exportar. El sistema generará un archivo Excel con todos los datos contables del mes.</p>
                
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="exportAnio" class="form-label fw-bold text-uppercase" style="font-size: 11px;">
                            <i data-feather="calendar" class="inline mr-1"></i>
                            Año
                        </label>
                        <select class="form-select" id="exportAnio" required>
                            <!-- Se llena dinámicamente con JavaScript -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="exportMes" class="form-label fw-bold text-uppercase" style="font-size: 11px;">
                            <i data-feather="calendar" class="inline mr-1"></i>
                            Mes
                        </label>
                        <select class="form-select" id="exportMes" required>
                            <!-- Se llena dinámicamente con JavaScript -->
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" class="btn btn-excel w-100" id="btnDescargarExcel">
                            <i data-feather="download" class="inline mr-1"></i>
                            Descargar
                        </button>
                    </div>
                </div>

                <div class="alert alert-info mt-4 mb-0" style="border-left: 4px solid #0dcaf0;">
                    <strong>📋 Información:</strong><br>
                    El reporte incluirá:
                    <ul class="mb-0 mt-2">
                        <li>Nómina completa del periodo</li>
                        <li>Aportes seguridad social detallados</li>
                        <li>Estados de pago por empleado</li>
                        <li>Totales consolidados por empresa</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
                    <i data-feather="x" class="inline mr-1"></i>
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Programar Recordatorio de Cobro -->
<div class="modal fade" id="modalProgramarRecordatorio" tabindex="-1" aria-labelledby="modalProgramarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: #0056b3; color: white;">
                <h5 class="modal-title" id="modalProgramarLabel">
                    <i data-feather="clock" class="inline mr-2"></i>
                    Programar Recordatorio de Cobro
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-uppercase" style="font-size: 11px;">Cliente/Empresa</label>
                        <p class="text-muted mb-0" id="recordatorioClienteNombre">-</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-uppercase" style="font-size: 11px;">Monto Pendiente</label>
                        <p class="text-danger mb-0" style="font-size: 1.2rem; font-weight: 700;" id="recordatorioMonto">$0</p>
                    </div>
                    <div class="col-md-12">
                        <label for="recordatorioFecha" class="form-label fw-bold text-uppercase" style="font-size: 11px;">
                            <i data-feather="calendar" class="inline mr-1"></i>
                            Fecha del Recordatorio
                        </label>
                        <input type="date" class="form-control" id="recordatorioFecha" required min="">
                        <small class="text-muted">Selecciona la fecha en la que deseas recibir el recordatorio.</small>
                    </div>
                    <div class="col-md-12">
                        <label for="recordatorioNotas" class="form-label fw-bold text-uppercase" style="font-size: 11px;">Notas (Opcional)</label>
                        <textarea class="form-control" id="recordatorioNotas" rows="3" placeholder="Agrega notas o detalles adicionales..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i data-feather="x" class="inline mr-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnGuardarRecordatorio">
                    <i data-feather="check" class="inline mr-1"></i>
                    Guardar Recordatorio
                </button>
            </div>
        </div>
    </div>
</div>

    {% include '_footer.html' %}

    <script src="/assets/js/plugins/simplebar.min.js"></script>
    <script src="/assets/js/plugins/popper.min.js"></script>
    <script src="/assets/js/icon/custom-icon.js"></script>
    <script src="/assets/js/plugins/feather.min.js"></script>
    <script src="/assets/js/component.js"></script>
    <script src="/assets/js/theme.js"></script>
    <script>
        // --- POLYFILLS PARA TEMA (Ejecutar ANTES de script.js) ---
        // Previene errores de ReferenceError cuando script.js intenta llamar estas funciones
        window.layout_change = window.layout_change || function() {};
        window.layout_theme_sidebar_change = window.layout_theme_sidebar_change || function() {};
        window.change_box_container = window.change_box_container || function() {};
        window.layout_caption_change = window.layout_caption_change || function() {};
        window.layout_rtl_change = window.layout_rtl_change || function() {};
        window.preset_change = window.preset_change || function() {};
        window.main_layout_change = window.main_layout_change || function() {};
    </script>

    <script src="/assets/js/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      function toggleAll(source) {
        const checkboxes = document.querySelectorAll('input[name="selectRow"]');
        checkboxes.forEach(checkbox => {
          const row = checkbox.closest('tr');
          if (row.style.display !== 'none') {
            checkbox.checked = source.checked;
          }
        });
      }

      function enviarRecordatorio() {
        const filasSeleccionadas = Array.from(document.querySelectorAll('input[name="selectRow"]:checked')).map(checkbox => checkbox.value);
        if (filasSeleccionadas.length === 0) {
            alert('🚨 Por favor, selecciona al menos un empleado para enviar el recordatorio.');
            return;
        }
        const mes = document.getElementById('filtroMes').value;
        alert(`✅ Recordatorio simulado enviado a ${filasSeleccionadas.length} empleado(s) para el periodo ${mes}. IDs: ${filasSeleccionadas.join(', ')}.`);
      }

      function renderTable(dataToRender) {
          const tbody = document.getElementById('tablaPagos').querySelector('tbody');
          tbody.innerHTML = '';

          if(dataToRender.length === 0) {
              tbody.innerHTML = '<tr><td colspan="20" class="text-center text-muted">No se encontraron usuarios para los filtros seleccionados.</td></tr>';
              return;
          }

          // Función para calcular edad
          function calcularEdad(fecha) {
              if (!fecha) return 'N/A';
              const hoy = new Date();
              const cumpleanos = new Date(fecha);
              let edad = hoy.getFullYear() - cumpleanos.getFullYear();
              const m = hoy.getMonth() - cumpleanos.getMonth();
              if (m < 0 || (m === 0 && hoy.getDate() < cumpleanos.getDate())) {
                  edad--;
              }
              return isNaN(edad) ? 'N/A' : edad;
          }

          dataToRender.forEach(user => {
              const ibc = parseFloat(user.ibc) || 0;
              const costoEps = parseFloat(user.epsCosto) || 0;
              const costoArl = parseFloat(user.arlCosto) || 0;
              const costoPension = parseFloat(user.afpCosto) || 0;
              const costoCaja = parseFloat(user.ccfCosto) || 0;
              const costoAdmin = 0;
              const totalAporte = costoEps + costoArl + costoPension + costoCaja + costoAdmin;

              // Calcular edad
              const edad = user.edad || calcularEdad(user.fechaNacimiento);

              const fechaIngreso = new Date(user.fechaIngreso);
              const mesIngreso = fechaIngreso.toLocaleString('es-CO', { month: 'long' }).toUpperCase();
              const anioIngreso = fechaIngreso.getFullYear();

              const estadoPago = user.estadoPago || 'Pendiente';
              const esMoroso = user.mora === true || user.esMoroso === true; // Verificar si está marcado como moroso
              const rowClass = estadoPago === 'Pendiente' ? 'row-pendiente' : '';
              const badgeClass = estadoPago === 'Pendiente' ? 'bg-danger' : 'bg-success';
              
              // Botón de marcar como pagado
              const actionButton = estadoPago === 'Pendiente' 
                ? `<button class="btn btn-sm btn-success btn-marcar-pagado" data-id="${user.numeroId}" title="Marcar como Pagado"><i data-feather="check-circle" class="w-4 h-4"></i></button>`
                : '';

              // Botón de recordatorio WhatsApp (solo para morosos o pendientes)
              const whatsappButton = (estadoPago === 'Pendiente' || esMoroso)
                ? `<button class="btn btn-sm btn-success ms-1" onclick="enviarRecordatorioWhatsApp('${user.primerNombre} ${user.primerApellido}', '${user.telefono || ''}', ${totalAporte}, ${user.saldo_a_favor || 0})" title="Recordar Pago por WhatsApp">
                     <i class="ti ti-brand-whatsapp" style="font-size: 1.1rem;"></i>
                   </button>`
                : '';

              // Botón de programar recordatorio
              const programarButton = `<button class="btn btn-sm btn-warning ms-1" onclick="abrirModalProgramar('${user.numeroId}', '${user.primerNombre} ${user.primerApellido}', ${totalAporte}, '${user.administracion || 'N/A'}')" title="Programar Recordatorio">
                     <i data-feather="clock" class="w-4 h-4"></i>
                   </button>`;

              const row = `
                  <tr class="${rowClass}">
                      <td><input type="checkbox" name="selectRow" value="${user.numeroId}"></td>
                      <td>${user.numeroId}</td>
                      <td>${user.primerNombre || ''} ${user.segundoNombre || ''}</td>
                      <td>${user.primerApellido || ''} ${user.segundoApellido || ''}</td>
                      <td class="text-center font-weight-bold">${edad}</td>
                      <td><span class="badge ${badgeClass}">${estadoPago.toUpperCase()}</span></td>
                      <td>${document.getElementById('filtroMes').value.replace('-', '/')}</td>
                      <td>${user.epsNombre || 'N/A'}</td>
                      <td>${user.arlNombre || 'N/A'} (${user.claseRiesgoARL || 'N/A'})</td>
                      <td>${user.afpNombre || 'N/A'}</td>
                      <td>${user.ccfNombre || 'N/A'}</td>
                      <td>${user.fechaIngreso || 'N/A'}</td>
                      <td>${mesIngreso}/${anioIngreso}</td>
                      <td class="text-right">${ibc.toLocaleString('es-CO')}</td>
                      <td class="text-right">${costoEps.toLocaleString('es-CO')}</td>
                      <td class="text-right">${costoArl.toLocaleString('es-CO')}</td>
                      <td class="text-right">${costoPension.toLocaleString('es-CO')}</td>
                      <td class="text-right">${costoCaja.toLocaleString('es-CO')}</td>
                      <td class="text-right">${costoAdmin.toLocaleString('es-CO')}</td>
                      <td class="text-right font-semibold bg-primary-50">${totalAporte.toLocaleString('es-CO')}</td>
                      <td class="text-center">${actionButton}${whatsappButton}${programarButton}</td>
                  </tr>
              `;
              tbody.insertAdjacentHTML('beforeend', row);
          });
          feather.replace();
      }

      function consultarTabla() {
          const empresaSeleccionada = document.getElementById('filtroEmpresa').value;
          const estadoSeleccionado = document.getElementById('filtroEstado').value;
          const reminderContainer = document.getElementById('whatsappReminderContainer');
          
          let userDataStore = JSON.parse(localStorage.getItem('userDataStore')) || [];

          let filteredData = (empresaSeleccionada === 'todos') 
              ? userDataStore 
              : userDataStore.filter(user => user.administracion === empresaSeleccionada);
          
          if (estadoSeleccionado !== 'todos') {
              if (estadoSeleccionado === 'Moroso') {
                  // Filtrar solo usuarios morosos (pendientes con mora)
                  filteredData = filteredData.filter(user => 
                      (user.estadoPago === 'Pendiente' || !user.estadoPago) && 
                      (user.mora === true || user.esMoroso === true)
                  );
              } else {
                  filteredData = filteredData.filter(user => (user.estadoPago || 'Pendiente') === estadoSeleccionado);
              }
          }
          
          renderTable(filteredData);

          reminderContainer.style.display = (estadoSeleccionado === 'Pendiente' || estadoSeleccionado === 'Moroso') ? '' : 'none';
          if (document.getElementById('selectAll')) document.getElementById('selectAll').checked = false;
      }
      
      document.addEventListener('DOMContentLoaded', () => {
          let userDataStore = JSON.parse(localStorage.getItem('userDataStore')) || [];
          
          const filtroEmpresa = document.getElementById('filtroEmpresa');
          const empresas = [...new Set(userDataStore.map(user => user.administracion).filter(Boolean))];
          empresas.forEach(empresa => {
              filtroEmpresa.insertAdjacentHTML('beforeend', `<option value="${empresa}">${empresa}</option>`);
          });

          const filtroMes = document.getElementById('filtroMes');
          const now = new Date();
          filtroMes.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

          renderTable(userDataStore);
          
          document.getElementById('btnConsultar').addEventListener('click', consultarTabla);
          document.getElementById('btnEnviarRecordatorio').addEventListener('click', enviarRecordatorio);
          document.getElementById('btnLimpiarFiltro')?.addEventListener('click', () => {
              document.getElementById('filtroEmpresa').value = 'todos';
              document.getElementById('filtroEstado').value = 'todos';
              consultarTabla();
          });

          document.getElementById('tablaPagos').addEventListener('click', function(e) {
              const target = e.target.closest('.btn-marcar-pagado');
              if (target) {
                  const userId = target.dataset.id;
                  const userIndex = userDataStore.findIndex(user => user.numeroId === userId);
                  if (userIndex !== -1) {
                      userDataStore[userIndex].estadoPago = 'Pagado';
                      localStorage.setItem('userDataStore', JSON.stringify(userDataStore));
                      consultarTabla(); // Re-renderizar la tabla para reflejar el cambio
                      alert(`El estado del usuario con ID ${userId} ha sido actualizado a "Pagado".`);
                  }
              }
          });
          
          feather.replace();
      });

      // ========== FUNCIÓN WHATSAPP RECORDATORIO ==========
      
      /**
       * Envía recordatorio de pago por WhatsApp Web
       * @param {string} nombreCompleto - Nombre del cliente
       * @param {string} telefono - Número de teléfono (opcional)
       * @param {number} montoPendiente - Monto adeudado
       * @param {number} saldoFavor - Saldo a favor disponible
       */
      function enviarRecordatorioWhatsApp(nombreCompleto, telefono, montoPendiente, saldoFavor = 0) {
          const mensaje = `Hola ${nombreCompleto}, recordamos que su pago de seguridad social presenta mora.\n\n` +
                          `💰 Monto pendiente: $${montoPendiente.toLocaleString('es-CO')}\n` +
                          `${saldoFavor > 0 ? `🌟 Saldo a favor disponible: $${saldoFavor.toLocaleString('es-CO')}\n` : ''}` +
                          `\nPor favor regularizar a la brevedad posible.\n\n` +
                          `Gracias por su atención.`;

          // Si hay teléfono, abrir WhatsApp con número, sino solo el mensaje
          let whatsappURL;
          if (telefono && telefono.trim() !== '') {
              // Limpiar número (quitar espacios, guiones, paréntesis)
              const telefonoLimpio = telefono.replace(/\D/g, '');
              whatsappURL = `https://wa.me/57${telefonoLimpio}?text=${encodeURIComponent(mensaje)}`;
          } else {
              // Sin número, abrir WhatsApp Web con mensaje solamente
              whatsappURL = `https://web.whatsapp.com/send?text=${encodeURIComponent(mensaje)}`;
          }

          window.open(whatsappURL, '_blank');
      }

      // ========== FIN FUNCIÓN WHATSAPP ==========

      // ========== FUNCIÓN PROGRAMAR RECORDATORIO ==========
      
      let datosRecordatorioActual = {};

      /**
       * Abre el modal para programar un recordatorio de cobro
       * @param {string} clienteId - ID del cliente/usuario
       * @param {string} nombreCompleto - Nombre del cliente
       * @param {number} monto - Monto pendiente
       * @param {string} empresa - Nombre de la empresa
       */
      function abrirModalProgramar(clienteId, nombreCompleto, monto, empresa) {
          // Guardar datos para uso posterior
          datosRecordatorioActual = {
              clienteId: clienteId,
              nombreCompleto: nombreCompleto,
              monto: monto,
              empresa: empresa
          };

          // Llenar modal
          document.getElementById('recordatorioClienteNombre').textContent = `${nombreCompleto} (${empresa})`;
          document.getElementById('recordatorioMonto').textContent = `$${monto.toLocaleString('es-CO')}`;
          
          // Establecer fecha mínima (hoy)
          const hoy = new Date().toISOString().split('T')[0];
          document.getElementById('recordatorioFecha').setAttribute('min', hoy);
          document.getElementById('recordatorioFecha').value = '';
          document.getElementById('recordatorioNotas').value = '';

          // Abrir modal
          const modal = new bootstrap.Modal(document.getElementById('modalProgramarRecordatorio'));
          modal.show();
          
          // Reemplazar iconos
          feather.replace();
      }

      /**
       * Guarda el recordatorio programado
       */
      async function guardarRecordatorio() {
          const fecha = document.getElementById('recordatorioFecha').value;
          const notas = document.getElementById('recordatorioNotas').value;

          if (!fecha) {
              alert('⚠️ Por favor selecciona una fecha para el recordatorio.');
              return;
          }

          const payload = {
              cliente_id: datosRecordatorioActual.clienteId,
              nombre_completo: datosRecordatorioActual.nombreCompleto,
              empresa: datosRecordatorioActual.empresa,
              monto: datosRecordatorioActual.monto,
              fecha_recordatorio: fecha,
              notas: notas || ''
          };

          try {
              const response = await fetch('/api/finanzas/programar-cobro', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  credentials: 'include',
                  body: JSON.stringify(payload)
              });

              const result = await response.json();

              if (response.ok) {
                  // Cerrar modal
                  const modal = bootstrap.Modal.getInstance(document.getElementById('modalProgramarRecordatorio'));
                  modal.hide();

                  // Mostrar Toast de éxito
                  mostrarToast(
                      '✅ Recordatorio Programado', 
                      `Recordatorio programado para el ${new Date(fecha).toLocaleDateString('es-CO', { day: 'numeric', month: 'long', year: 'numeric' })}. Te avisaré en Novedades.`,
                      'success'
                  );

                  console.log('✅ Recordatorio guardado:', result);
              } else {
                  throw new Error(result.error || 'Error al guardar recordatorio');
              }

          } catch (error) {
              console.error('❌ Error al programar recordatorio:', error);
              mostrarToast(
                  '❌ Error', 
                  'No se pudo programar el recordatorio. Intenta nuevamente.',
                  'danger'
              );
          }
      }

      /**
       * Muestra un toast de notificación
       * @param {string} titulo - Título del toast
       * @param {string} mensaje - Mensaje del toast
       * @param {string} tipo - Tipo: success, danger, warning, info
       */
      function mostrarToast(titulo, mensaje, tipo = 'info') {
          const colorMap = {
              'success': '#28a745',
              'danger': '#dc3545',
              'warning': '#ffc107',
              'info': '#17a2b8'
          };

          const iconMap = {
              'success': '✅',
              'danger': '❌',
              'warning': '⚠️',
              'info': 'ℹ️'
          };

          // Crear toast container si no existe
          let toastContainer = document.getElementById('toastContainer');
          if (!toastContainer) {
              toastContainer = document.createElement('div');
              toastContainer.id = 'toastContainer';
              toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
              document.body.appendChild(toastContainer);
          }

          // Crear toast
          const toastHTML = `
              <div class="toast align-items-center text-white border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: ${colorMap[tipo]}; min-width: 300px;">
                  <div class="d-flex">
                      <div class="toast-body">
                          <strong>${iconMap[tipo]} ${titulo}</strong><br>
                          ${mensaje}
                      </div>
                      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                  </div>
              </div>
          `;

          toastContainer.insertAdjacentHTML('beforeend', toastHTML);
          const toastElement = toastContainer.lastElementChild;
          const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
          toast.show();

          // Eliminar del DOM después de ocultarse
          toastElement.addEventListener('hidden.bs.toast', () => {
              toastElement.remove();
          });
      }

      // Event Listener para botón de guardar
      document.addEventListener('DOMContentLoaded', () => {
          document.getElementById('btnGuardarRecordatorio')?.addEventListener('click', guardarRecordatorio);
          document.getElementById('btnDescargarExcel')?.addEventListener('click', descargarExcel);
          
          // Cargar años y meses en modal exportar
          cargarAniosExport();
          cargarMesesExport();
      });

      // ========== FIN FUNCIÓN PROGRAMAR RECORDATORIO ==========

      // ========== 📊 EXPORTAR EXCEL PARA CONTADOR ==========
      function descargarExcel() {
          const anio = document.getElementById('exportAnio').value;
          const mes = document.getElementById('exportMes').value;

          if (!anio || !mes) {
              alert('⚠️ Por favor seleccione año y mes');
              return;
          }

          // Cerrar modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('modalExportarExcel'));
          modal.hide();

          // Mostrar notificación de descarga
          mostrarToast('📥 Descargando Excel', `Generando reporte de ${mes}/${anio}...`, 'info');

          // En producción: descomentar
          // window.location.href = `/api/contabilidad/exportar?anio=${anio}&mes=${mes}`;

          // Simulación temporal
          setTimeout(() => {
              console.log(`📊 Exportando datos contables: ${mes}/${anio}`);
              mostrarToast('✅ Exportación Completa', `Excel de ${mes}/${anio} descargado correctamente`, 'success');
              
              // Simulación de descarga (en producción se reemplaza por el endpoint real)
              const fakeDownload = document.createElement('a');
              fakeDownload.href = '#';
              fakeDownload.download = `Reporte_Contable_${mes}_${anio}.xlsx`;
              // fakeDownload.click(); // Descomentar en producción
          }, 1500);
      }

      // Llenar select de años (2020 - año actual + 1)
      function cargarAniosExport() {
          const selectAnio = document.getElementById('exportAnio');
          if (!selectAnio) return;

          const anioActual = new Date().getFullYear();
          const anioInicio = 2020;

          for (let anio = anioActual + 1; anio >= anioInicio; anio--) {
              const option = document.createElement('option');
              option.value = anio;
              option.textContent = anio;
              if (anio === anioActual) option.selected = true;
              selectAnio.appendChild(option);
          }
      }

      // Llenar select de meses
      function cargarMesesExport() {
          const selectMes = document.getElementById('exportMes');
          if (!selectMes) return;

          const meses = [
              { valor: '01', nombre: 'Enero' },
              { valor: '02', nombre: 'Febrero' },
              { valor: '03', nombre: 'Marzo' },
              { valor: '04', nombre: 'Abril' },
              { valor: '05', nombre: 'Mayo' },
              { valor: '06', nombre: 'Junio' },
              { valor: '07', nombre: 'Julio' },
              { valor: '08', nombre: 'Agosto' },
              { valor: '09', nombre: 'Septiembre' },
              { valor: '10', nombre: 'Octubre' },
              { valor: '11', nombre: 'Noviembre' },
              { valor: '12', nombre: 'Diciembre' }
          ];

          const mesActual = String(new Date().getMonth() + 1).padStart(2, '0');

          meses.forEach(mes => {
              const option = document.createElement('option');
              option.value = mes.valor;
              option.textContent = mes.nombre;
              if (mes.valor === mesActual) option.selected = true;
              selectMes.appendChild(option);
          });
      }
      // ========== FIN EXPORTAR EXCEL ==========
      
{% include '_theme_config.html' %}
    </script>

  </body>
</html>