<header class="pc-header">
  <div class="header-wrapper flex max-sm:px-[15px] px-[25px] grow">
    
    <div class="me-auto pc-mob-drp">
      <ul class="inline-flex *:min-h-header-height *:inline-flex *:items-center">
        <li class="pc-h-item pc-sidebar-collapse max-lg:hidden lg:inline-flex">
          <a href="#" class="pc-head-link ltr:!ml-0 rtl:!mr-0" id="sidebar-hide"><i data-feather="menu"></i></a>
        </li>
        <li class="pc-h-item pc-sidebar-popup lg:hidden">
          <a href="#" class="pc-head-link ltr:!ml-0 rtl:!mr-0" id="mobile-collapse"><i data-feather="menu"></i></a>
        </li>
        
        <li class="dropdown pc-h-item">
          <a class="pc-head-link dropdown-toggle me-0" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
            <i data-feather="search"></i>
          </a>
          <div class="dropdown-menu pc-h-dropdown drp-search">
            <form class="px-2 py-1" onsubmit="handleSearch(event)">
              <input type="search" id="headerSearchInput" class="form-control !border-0 !shadow-none" placeholder="Buscar (Ej: Juan P칠rez)..." />
            </form>
          </div>
        </li>
      </ul>
    </div>

    <div class="ms-auto">
      <ul class="inline-flex *:min-h-header-height *:inline-flex *:items-center">
        
        <li class="dropdown pc-h-item">
          <a class="pc-head-link dropdown-toggle me-0" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
            <i data-feather="sun"></i>
          </a>
          <div class="dropdown-menu dropdown-menu-end pc-h-dropdown">
            <a href="#!" class="dropdown-item" onclick="layout_change('dark')"><i data-feather="moon"></i><span>Oscuro</span></a>
            <a href="#!" class="dropdown-item" onclick="layout_change('light')"><i data-feather="sun"></i><span>Claro</span></a>
            <a href="#!" class="dropdown-item" onclick="layout_change_default()"><i data-feather="settings"></i><span>Sistema</span></a>
          </div>
        </li>

        <li class="dropdown pc-h-item">
          <a class="pc-head-link dropdown-toggle me-0" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
            <i data-feather="settings"></i>
          </a>
          <div class="dropdown-menu dropdown-menu-end pc-h-dropdown">
            <a href="#!" class="dropdown-item" onclick="openWhatsAppSupport()">
                <i class="ti ti-brand-whatsapp text-success-500"></i>
                <span>Soporte WhatsApp</span>
            </a>
            <a href="#!" class="dropdown-item" onclick="lockScreen()">
                <i class="ti ti-lock text-warning-500"></i>
                <span>Bloquear Pantalla</span>
            </a>
          </div>
        </li>

        <li class="dropdown pc-h-item">
          <a class="pc-head-link dropdown-toggle me-0" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
            <i data-feather="bell"></i>
            <span class="badge bg-success-500 text-white rounded-full z-10 absolute right-0 top-0" id="notifBadge">0</span>
          </a>
          <div class="dropdown-menu dropdown-notification dropdown-menu-end pc-h-dropdown p-2">
             <div class="dropdown-header flex items-center justify-between py-2">
                <h6 class="m-0">Notificaciones</h6>
                <a href="#!" class="text-muted hover:text-primary" onclick="markAllAsRead()">Marcar le칤das</a>
             </div>
             <div class="dropdown-body p-0 relative" style="max-height: 300px; overflow-y: auto;" id="notificationList">
                <div class="text-center py-4 text-muted">Cargando...</div>
             </div>
          </div>
        </li>

        <li class="dropdown pc-h-item header-user-profile">
          <a class="pc-head-link dropdown-toggle arrow-none me-0" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="false" data-bs-auto-close="outside" aria-expanded="false">
            <i data-feather="user"></i>
          </a>
          <div class="dropdown-menu dropdown-user-profile dropdown-menu-end pc-h-dropdown p-2 overflow-hidden">
            <div class="dropdown-header flex items-center justify-between py-4 px-5 bg-primary-500">
              <div class="flex mb-1 items-center">
                <div class="shrink-0"><i data-feather="user" class="w-10 h-10 text-white"></i></div>
                <div class="grow ms-3">
                  <h6 class="mb-1 text-white" id="userNameDisplay">Usuario</h6>
                  <small class="text-white opacity-75" id="userRoleDisplay">Admin</small>
                </div>
              </div>
            </div>
            <div class="dropdown-body py-4 px-5">
              <div class="profile-notification-scroll position-relative" style="max-height: calc(100vh - 225px)">
                
                <div class="grid mb-3">
                    <a href="/configuracion" class="btn btn-outline-secondary flex items-center justify-center">
                        <i data-feather="settings" class="me-2"></i>Configuraci칩n
                    </a>
                </div>

                <div class="grid mb-3">
                    <button onclick="lockScreen()" class="btn btn-outline-secondary flex items-center justify-center w-full">
                        <i data-feather="lock" class="me-2"></i>Bloquear
                    </button>
                </div>
                
                <hr class="border-secondary-500/10 my-4">

                <div class="grid my-3">
                   <button class="btn btn-primary flex items-center justify-center" id="logoutButtonHeader">
                     <i data-feather="log-out" class="me-2"></i>Cerrar Sesi칩n
                   </button>
                </div>

              </div>
            </div>
          </div>
        </li>
      </ul>
    </div>
  </div>
</header>

<div id="lockScreenOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-[2000] hidden flex-col items-center justify-center text-center">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg max-w-sm w-full">
        <div class="mb-4 text-primary-500"><i data-feather="lock" class="w-12 h-12 mx-auto"></i></div>
        <h4 class="mb-2 text-xl font-bold dark:text-white">Sesi칩n Bloqueada</h4>
        <p class="text-gray-500 mb-4">Ingresa tu contrase침a para volver</p>

        <!-- Mensaje de error -->
        <div id="lockscreenError" class="alert alert-danger mb-3" style="display: none;"></div>

        <!-- Input de contrase침a -->
        <input type="password" id="lockscreen-password" class="form-control mb-4 text-center" placeholder="Contrase침a..." onkeypress="if(event.key==='Enter') desbloquearPantalla()" />

        <!-- Bot칩n de desbloqueo -->
        <button class="btn btn-primary w-full" id="unlockButton" onclick="desbloquearPantalla()">
            <i data-feather="unlock" class="me-2"></i>
            Desbloquear
        </button>
    </div>
</div>

<script>
// ============================================================================
// L칍GICA UNIFICADA DEL HEADER
// ============================================================================

// 1. SOPORTE WHATSAPP
function openWhatsAppSupport() {
  const phoneNumber = '573001234567'; // Pon tu n칰mero aqu칤
  const message = encodeURIComponent('Hola, necesito ayuda t칠cnica con el Portal Montero');
  window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank');
}

// 2. BLOQUEO DE PANTALLA (MODAL SEGURO)
function lockScreen() {
    const overlay = document.getElementById('lockScreenOverlay');
    const passwordInput = document.getElementById('lockscreen-password');
    const errorDiv = document.getElementById('lockscreenError');

    if(overlay) {
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');

        // Limpiar input y error
        if(passwordInput) passwordInput.value = '';
        if(errorDiv) errorDiv.style.display = 'none';

        // Guardar estado en sessionStorage para persistir si recarga
        sessionStorage.setItem('isLocked', 'true');

        // Focus en el input de contrase침a
        setTimeout(() => passwordInput?.focus(), 100);
    }
}

async function desbloquearPantalla() {
    const overlay = document.getElementById('lockScreenOverlay');
    const passwordInput = document.getElementById('lockscreen-password');
    const errorDiv = document.getElementById('lockscreenError');
    const unlockButton = document.getElementById('unlockButton');

    const password = passwordInput?.value;

    // Validaci칩n b치sica
    if (!password) {
        mostrarErrorLockscreen('Por favor ingresa tu contrase침a');
        return;
    }

    // Deshabilitar bot칩n mientras procesa
    if(unlockButton) {
        unlockButton.disabled = true;
        unlockButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verificando...';
    }

    try {
        // Llamar a la API de verificaci칩n de contrase침a (endpoint de auth)
        const response = await fetch('/api/verify-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ password })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            // Contrase침a correcta - desbloquear
            if(overlay) {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
                sessionStorage.removeItem('isLocked');
            }

            // Limpiar input
            if(passwordInput) passwordInput.value = '';
            if(errorDiv) errorDiv.style.display = 'none';

            // Feedback visual de 칠xito (opcional)
            console.log('游댑 Pantalla desbloqueada exitosamente');

        } else {
            // Contrase침a incorrecta
            mostrarErrorLockscreen(data.message || 'Contrase침a incorrecta');

            // Limpiar input para reintentar
            if(passwordInput) {
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

    } catch (error) {
        console.error('Error al verificar contrase침a:', error);
        mostrarErrorLockscreen('Error de conexi칩n. Intenta de nuevo.');
    } finally {
        // Restaurar bot칩n
        if(unlockButton) {
            unlockButton.disabled = false;
            unlockButton.innerHTML = '<i data-feather="unlock" class="me-2"></i>Desbloquear';
            feather.replace();
        }
    }
}

function mostrarErrorLockscreen(mensaje) {
    const errorDiv = document.getElementById('lockscreenError');
    if(errorDiv) {
        errorDiv.textContent = mensaje;
        errorDiv.style.display = 'block';

        // Auto-ocultar despu칠s de 5 segundos
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }
}

// Verificar bloqueo al cargar
document.addEventListener('DOMContentLoaded', () => {
    if(sessionStorage.getItem('isLocked') === 'true') {
        lockScreen();
    }
});

// 3. B칔SQUEDA
function handleSearch(event) {
  event.preventDefault();
  const searchInput = document.getElementById('headerSearchInput');
  const query = searchInput.value.trim().toLowerCase();
  
  if (query) {
      // Mapeo inteligente de atajos
      const routeMap = {
          'pagos': '/pagos/recaudo',
          'usuarios': '/usuarios/gestion',
          'empleados': '/usuarios/gestion',
          'novedades': '/novedades',
          'marketing': '/marketing/redes',
          'cartera': '/pagos/cartera',
          'planillas': '/pagos/planillas',
          'impuestos': '/pagos/impuestos',
          'configuracion': '/configuracion'
      };

      // Buscar coincidencia exacta o parcial
      for (const [key, route] of Object.entries(routeMap)) {
          if (query.includes(key)) {
              window.location.href = route;
              return;
          }
      }
      
      // Si no encuentra mapeo, alertar (o llevar a p치gina de resultados)
      alert('Buscando: ' + query + ' (Funci칩n de b칰squeda avanzada en desarrollo)');
  }
}

// 4. LOGOUT (Delegar al script principal si existe, o manejar aqu칤)
document.getElementById('logoutButtonHeader')?.addEventListener('click', async () => {
    if(confirm('쮼st치s seguro de cerrar sesi칩n?')) {
         // Intenta llamar a la API de logout si existe
         try {
             await fetch('/api/logout', { method: 'POST' });
         } catch(e) { console.log('Logout local'); }
         window.location.href = '/login';
    }
});

</script>