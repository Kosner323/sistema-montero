<!doctype html>
<html lang="es" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
<head>
  <meta charset="utf-8" />
  <title>Gesti√≥n de Unificaci√≥n | Portal Montero</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link rel="icon" href="/assets/images/favicon.svg" type="image/x-icon" />

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/fonts/phosphor/duotone/style.css" />
  <link rel="stylesheet" href="/assets/fonts/tabler-icons.min.css" />
  <link rel="stylesheet" href="/assets/fonts/feather.css" />
  <link rel="stylesheet" href="/assets/fonts/fontawesome.css" />
  <link rel="stylesheet" href="/assets/fonts/material.css" />

  <!-- Theme CSS -->
  <link rel="stylesheet" href="/assets/css/style.css" id="main-style-link" />
  <link rel="stylesheet" href="/assets/css/style-preset.css" />

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* ========== ESTILOS ESTILO TABLA DE CONTROL ========== */

    /* Estados de filas */
    .row-sin-empresa {
      background-color: #ffeaea !important; /* Fondo rojo claro para usuarios sin empresa */
    }

    .row-activo {
      background-color: #e8f5e9 !important; /* Fondo verde claro para activos */
    }

    /* Tabla principal */
    .table {
      font-size: 0.875rem;
    }

    .table th {
      background-color: #f8f9fa;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.5px;
      color: #495057;
      border: 1px solid #dee2e6;
      white-space: nowrap;
      vertical-align: middle;
    }

    .table td {
      vertical-align: middle;
      padding: 0.75rem;
      border: 1px solid #dee2e6;
    }

    .table-hover tbody tr:hover {
      background-color: rgba(79, 70, 229, 0.05);
      cursor: default;
    }

    /* Encabezados con fondo gris */
    .bg-gray-100 {
      background-color: #f8f9fa !important;
    }

    /* Encabezado con fondo azul claro */
    .bg-primary-100 {
      background-color: #e3f2fd !important;
      font-weight: 700;
    }

    /* Badges de estado */
    .badge {
      font-weight: 500;
      padding: 0.35rem 0.65rem;
      font-size: 0.7rem;
      border-radius: 0.25rem;
    }

    .bg-success { background-color: #28a745 !important; color: white; }
    .bg-danger { background-color: #dc3545 !important; color: white; }
    .bg-warning { background-color: #ffc107 !important; color: #212529; }
    .bg-secondary { background-color: #6c757d !important; color: white; }
    .bg-info { background-color: #17a2b8 !important; color: white; }
    .bg-primary { background-color: #007bff !important; color: white; }

    /* Alineaci√≥n de texto */
    .text-right {
      text-align: right;
    }

    .text-center {
      text-align: center;
    }

    .align-middle {
      vertical-align: middle !important;
    }

    /* Botones de acci√≥n */
    .btn-sm {
      padding: 0.35rem 0.7rem;
      font-size: 0.75rem;
    }

    /* Card header */
    .card-header {
      background-color: white;
      border-bottom: 1px solid #dee2e6;
      padding: 1rem 1.5rem;
    }

    .card-header h5 {
      margin: 0;
      font-weight: 600;
      font-size: 1.1rem;
    }

    /* Filtros en header */
    .form-select,
    .form-control {
      font-size: 0.875rem;
      padding: 0.5rem 0.75rem;
    }

    .form-select:focus,
    .form-control:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.15);
    }

    /* Whitespace */
    .whitespace-nowrap {
      white-space: nowrap;
    }

    .text-sm {
      font-size: 0.875rem;
    }

    /* Estados vac√≠os */
    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
    }

    .loading-row {
      text-align: center;
      padding: 3rem 2rem;
    }

    .spinner-border-lg {
      width: 3rem;
      height: 3rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .table {
        font-size: 0.75rem;
      }

      .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div class="loader-bg">
      <div class="loader-track">
          <div class="loader-fill"></div>
      </div>
  </div>

  {% include '_sidebar.html' ignore missing %}
  {% include '_header.html' ignore missing %}

  <div class="pc-container">
    <div class="pc-content">

      <!-- ========== BREADCRUMB ========== -->
      <div class="page-header">
        <div class="page-block">
          <div class="row align-items-center">
            <div class="col-md-12">
              <div class="page-header-title">
                <h5 class="m-b-10">Gesti√≥n de Unificaci√≥n</h5>
              </div>
              <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="/dashboard"><i class="feather icon-home"></i></a></li>
                <li class="breadcrumb-item">Administraci√≥n</li>
                <li class="breadcrumb-item" aria-current="page">Unificaci√≥n Masiva</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- ========== CARD SUPERIOR: FILTROS DE B√öSQUEDA ========== -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header card-header-custom">
              <h5>
                <i class="feather icon-filter"></i>
                Filtros de B√∫squeda y Unificaci√≥n
              </h5>
            </div>
            <div class="card-body p-4">
              <form id="formBusqueda">
                
                <!-- FILA 1: DATOS DEL USUARIO -->
                <div class="section-divider">
                  <div class="section-title">
                    <i class="feather icon-user"></i>
                    Datos del Usuario / Empleado
                  </div>
                </div>
                <div class="row mb-4">
                  <div class="col-md-4 mb-3">
                    <label for="filtroUserTipoDoc" class="form-label">
                      <i class="feather icon-credit-card me-1"></i>
                      Tipo de Documento
                    </label>
                    <select class="form-select" id="filtroUserTipoDoc">
                      <option value="">-- Todos los Tipos --</option>
                      <option value="CC">C√©dula de Ciudadan√≠a (CC)</option>
                      <option value="CE">C√©dula de Extranjer√≠a (CE)</option>
                      <option value="PA">Pasaporte (PA)</option>
                      <option value="TI">Tarjeta de Identidad (TI)</option>
                      <option value="RC">Registro Civil (RC)</option>
                    </select>
                  </div>

                  <div class="col-md-4 mb-3">
                    <label for="filtroUserDoc" class="form-label">
                      <i class="feather icon-hash me-1"></i>
                      N√∫mero de Documento
                    </label>
                    <input 
                      type="text" 
                      class="form-control" 
                      id="filtroUserDoc" 
                      placeholder="Ej: 1010123456"
                      autocomplete="off"
                    />
                    <small class="text-muted">B√∫squeda parcial permitida</small>
                  </div>

                  <div class="col-md-4 mb-3">
                    <label for="filtroUserNombre" class="form-label">
                      <i class="feather icon-user me-1"></i>
                      Nombre del Usuario
                    </label>
                    <input 
                      type="text" 
                      class="form-control" 
                      id="filtroUserNombre" 
                      placeholder="Buscar por nombre o apellido..."
                      autocomplete="off"
                    />
                    <small class="text-muted">Busca en nombre y apellidos</small>
                  </div>
                </div>

                <!-- FILA 2: DATOS DE LA EMPRESA -->
                <div class="section-divider">
                  <div class="section-title">
                    <i class="feather icon-briefcase"></i>
                    Datos de la Empresa
                  </div>
                </div>
                <div class="row mb-4">
                  <div class="col-md-4 mb-3">
                    <label for="filtroEmpresaTipoDoc" class="form-label">
                      <i class="feather icon-file-text me-1"></i>
                      Tipo de Identificaci√≥n
                    </label>
                    <select class="form-select" id="filtroEmpresaTipoDoc">
                      <option value="">-- Todos los Tipos --</option>
                      <option value="NIT">NIT (N√∫mero de Identificaci√≥n Tributaria)</option>
                      <option value="RUT">RUT (Registro √önico Tributario)</option>
                      <option value="CC">C√©dula de Ciudadan√≠a</option>
                      <option value="CE">C√©dula de Extranjer√≠a</option>
                      <option value="OTRO">Otro</option>
                    </select>
                  </div>

                  <div class="col-md-4 mb-3">
                    <label for="filtroEmpresaNit" class="form-label">
                      <i class="feather icon-hash me-1"></i>
                      N√∫mero de Identificaci√≥n (NIT)
                    </label>
                    <input 
                      type="text" 
                      class="form-control" 
                      id="filtroEmpresaNit" 
                      placeholder="Ej: 900123456-1"
                      autocomplete="off"
                    />
                    <small class="text-muted">B√∫squeda parcial permitida</small>
                  </div>

                  <div class="col-md-4 mb-3">
                    <label for="filtroEmpresaNombre" class="form-label">
                      <i class="feather icon-briefcase me-1"></i>
                      Raz√≥n Social / Nombre
                    </label>
                    <input 
                      type="text" 
                      class="form-control" 
                      id="filtroEmpresaNombre" 
                      placeholder="Buscar por nombre de empresa..."
                      autocomplete="off"
                    />
                    <small class="text-muted">Busca en nombre de empresa</small>
                  </div>
                </div>

                <!-- FILA 3: BOTONES DE ACCI√ìN -->
                <div class="row">
                  <div class="col-12">
                    <div class="d-flex justify-content-end gap-2">
                      <button 
                        type="button" 
                        class="btn btn-outline-secondary btn-lg"
                        id="btnLimpiar"
                      >
                        <i class="feather icon-x me-2"></i>
                        Limpiar Filtros
                      </button>
                      <button 
                        type="submit" 
                        class="btn btn-primary btn-lg px-5"
                        id="btnConsultar"
                      >
                        <i class="feather icon-search me-2"></i>
                        Consultar Registros
                      </button>
                    </div>
                  </div>
                </div>

              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- ========== CARD INFERIOR: TABLA DE RESULTADOS ========== -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header flex justify-between items-center">
              <h5>Detalle de Empleados y Vinculaci√≥n Laboral</h5>
              <div class="flex items-center space-x-2">
                <span class="badge bg-secondary" id="contadorRegistros">0 registros</span>
                <button class="btn btn-primary btn-sm" id="btnRecargar" onclick="cargarDatosIniciales()">
                  <i data-feather="refresh-cw" class="w-4 h-4 mr-1"></i> Recargar
                </button>
              </div>
            </div>
            <div class="card-body">
              <p class="text-muted mb-3">
                Lista detallada de empleados y su vinculaci√≥n laboral.
                El color de fondo de la fila indica el estado de vinculaci√≥n
                (üü¢ Verde = Activo con empresa | üî¥ Rojo = Sin empresa asignada).
              </p>
              <div class="table-responsive">
                <table class="table table-hover table-bordered text-sm whitespace-nowrap" id="tablaUnificacion">
                  <thead>
                    <tr>
                      <th rowspan="2" class="align-middle text-center" style="width: 50px;">#</th>

                      <th colspan="3" class="text-center bg-gray-100">DATOS PERSONALES</th>

                      <th colspan="2" class="text-center bg-gray-100">VINCULACI√ìN LABORAL</th>

                      <th rowspan="2" class="align-middle text-center bg-primary-100">EMPRESA ASIGNADA</th>

                      <th rowspan="2" class="align-middle text-center" style="width: 120px;">ACCIONES</th>
                    </tr>
                    <tr>
                      <!-- DATOS PERSONALES -->
                      <th>NOMBRE(S)</th>
                      <th>APELLIDO(S)</th>
                      <th>DOCUMENTO</th>

                      <!-- VINCULACI√ìN LABORAL -->
                      <th>ESTADO</th>
                      <th>ROL</th>
                    </tr>
                  </thead>
                  <tbody id="tablaResultadosBody">
                    <!-- Loading inicial -->
                    <tr>
                      <td colspan="8" class="loading-row">
                        <div class="spinner-border spinner-border-lg text-primary" role="status">
                          <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="text-muted mt-3 mb-0">Cargando datos del sistema...</p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
    {% include '_footer.html' ignore missing %}
  </div>

  <!-- ========== SCRIPTS ========== -->
  <script src="/assets/js/plugins/popper.min.js"></script>
  <script src="/assets/js/plugins/simplebar.min.js"></script>
  <script src="/assets/js/plugins/bootstrap.min.js"></script>
  <script src="/assets/js/fonts/custom-font.js"></script>
  <script src="/assets/js/pcoded.js"></script>
  <script src="/assets/js/plugins/feather.min.js"></script>

  <script>
    // ==========================================================================
    // VARIABLES GLOBALES
    // ==========================================================================
    let todosLosUsuarios = []; // Cach√© completo de usuarios
    let todasLasEmpresas = []; // Cach√© completo de empresas

    // ==========================================================================
    // INICIALIZACI√ìN
    // ==========================================================================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Inicializando m√≥dulo de Unificaci√≥n...');

      // Inicializar iconos Feather
      if (typeof feather !== 'undefined') {
        feather.replace();
      }

      // Ocultar loader inicial
      const loader = document.querySelector('.loader-bg');
      if (loader) {
        setTimeout(() => { loader.style.display = 'none'; }, 500);
      }

      // Event Listeners
      document.getElementById('formBusqueda').addEventListener('submit', function(e) {
        e.preventDefault();
        filtrarYRenderizar();
      });

      document.getElementById('btnLimpiar').addEventListener('click', limpiarFiltros);

      // Cargar datos iniciales
      cargarDatosIniciales();
    });

    // ==========================================================================
    // FUNCI√ìN: CARGAR DATOS INICIALES
    // ==========================================================================
    async function cargarDatosIniciales() {
      try {
        console.log('üì• Cargando datos del servidor...');

        // Petici√≥n al endpoint /master
        const response = await fetch('/api/unificacion/master', {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          },
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Error al cargar datos');
        }

        console.log('‚úÖ Datos cargados:', data);

        // Guardar en cach√©
        todosLosUsuarios = data.usuarios || [];
        todasLasEmpresas = data.empresas || [];

        // Renderizar todos los registros inicialmente
        renderizarTabla(todosLosUsuarios);

        // Mostrar toast de √©xito
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: 'success',
          title: `${todosLosUsuarios.length} registros cargados`,
          showConfirmButton: false,
          timer: 2000,
          timerProgressBar: true
        });

      } catch (error) {
        console.error('‚ùå Error al cargar datos:', error);

        document.getElementById('tablaResultadosBody').innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              <div class="empty-state-icon">
                <i class="feather icon-alert-triangle"></i>
              </div>
              <p class="empty-state-text">
                Error al cargar los datos del sistema
              </p>
              <small class="text-muted">${error.message}</small>
              <br><br>
              <button class="btn btn-primary" onclick="cargarDatosIniciales()">
                <i class="feather icon-refresh-cw me-2"></i>
                Reintentar
              </button>
            </td>
          </tr>
        `;

        Swal.fire({
          icon: 'error',
          title: 'Error al Cargar Datos',
          text: error.message,
          confirmButtonText: 'OK'
        });
      }
    }

    // ==========================================================================
    // FUNCI√ìN: FILTRAR Y RENDERIZAR
    // ==========================================================================
    function filtrarYRenderizar() {
      console.log('üîç Aplicando filtros...');

      // Obtener valores de los filtros
      const filtros = {
        userTipoDoc: document.getElementById('filtroUserTipoDoc').value.trim(),
        userDoc: document.getElementById('filtroUserDoc').value.trim().toLowerCase(),
        userNombre: document.getElementById('filtroUserNombre').value.trim().toLowerCase(),
        empresaTipoDoc: document.getElementById('filtroEmpresaTipoDoc').value.trim(),
        empresaNit: document.getElementById('filtroEmpresaNit').value.trim().toLowerCase(),
        empresaNombre: document.getElementById('filtroEmpresaNombre').value.trim().toLowerCase()
      };

      console.log('üìã Filtros activos:', filtros);

      // Verificar si hay al menos un filtro
      const hayFiltros = Object.values(filtros).some(v => v !== '');

      if (!hayFiltros) {
        // Si no hay filtros, mostrar todos
        renderizarTabla(todosLosUsuarios);
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: 'info',
          title: 'Mostrando todos los registros',
          showConfirmButton: false,
          timer: 2000
        });
        return;
      }

      // Filtrar usuarios
      const usuariosFiltrados = todosLosUsuarios.filter(usuario => {
        let cumple = true;

        // Filtro: N√∫mero de Documento Usuario
        if (filtros.userDoc) {
          const numeroId = (usuario.numeroId || '').toString().toLowerCase();
          cumple = cumple && numeroId.includes(filtros.userDoc);
        }

        // Filtro: Nombre Usuario
        if (filtros.userNombre) {
          const nombreCompleto = `${usuario.primerNombre || ''} ${usuario.segundoNombre || ''} ${usuario.primerApellido || ''} ${usuario.segundoApellido || ''}`.toLowerCase();
          cumple = cumple && nombreCompleto.includes(filtros.userNombre);
        }

        // Filtro: NIT Empresa
        if (filtros.empresaNit) {
          const empresaNit = (usuario.empresa_nit || '').toString().toLowerCase();
          cumple = cumple && empresaNit.includes(filtros.empresaNit);
        }

        // Filtro: Nombre Empresa
        if (filtros.empresaNombre) {
          const nombreEmpresa = (usuario.nombre_empresa || '').toLowerCase();
          cumple = cumple && nombreEmpresa.includes(filtros.empresaNombre);
        }

        return cumple;
      });

      console.log(`‚úÖ Filtrados: ${usuariosFiltrados.length} de ${todosLosUsuarios.length}`);

      // Renderizar resultados
      renderizarTabla(usuariosFiltrados);

      // Mostrar notificaci√≥n
      if (usuariosFiltrados.length === 0) {
        Swal.fire({
          icon: 'info',
          title: 'Sin Resultados',
          text: 'No se encontraron registros que coincidan con los criterios de b√∫squeda.',
          confirmButtonText: 'OK'
        });
      } else {
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: 'success',
          title: `${usuariosFiltrados.length} registro(s) encontrado(s)`,
          showConfirmButton: false,
          timer: 2000,
          timerProgressBar: true
        });
      }
    }

    // ==========================================================================
    // FUNCI√ìN: RENDERIZAR TABLA (Estilo Control de Pagos)
    // ==========================================================================
    function renderizarTabla(usuarios) {
      const tbody = document.getElementById('tablaResultadosBody');
      const contador = document.getElementById('contadorRegistros');

      // Actualizar contador
      contador.textContent = `${usuarios.length} registro${usuarios.length !== 1 ? 's' : ''}`;

      // Si no hay usuarios
      if (!usuarios || usuarios.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center text-muted py-5">
              <i class="feather icon-inbox" style="font-size: 3rem; color: #ccc;"></i>
              <p class="mt-3 mb-0">No se encontraron registros</p>
              <small>Intente ajustar los filtros de b√∫squeda</small>
            </td>
          </tr>
        `;

        // Reinicializar iconos
        if (typeof feather !== 'undefined') {
          feather.replace();
        }
        return;
      }

      // Generar HTML de la tabla
      let html = '';
      usuarios.forEach((usuario, index) => {
        // Determinar clase de fila seg√∫n estado y empresa
        const estado = (usuario.estado || 'activo').toLowerCase();
        const tieneEmpresa = !!(usuario.empresa_nit && usuario.nombre_empresa);

        let rowClass = '';
        if (!tieneEmpresa) {
          rowClass = 'row-sin-empresa'; // Rojo claro si no tiene empresa
        } else if (estado === 'activo') {
          rowClass = 'row-activo'; // Verde claro si est√° activo
        }

        // Nombres y apellidos
        const nombres = `${usuario.primerNombre || ''} ${usuario.segundoNombre || ''}`.trim();
        const apellidos = `${usuario.primerApellido || ''} ${usuario.segundoApellido || ''}`.trim();

        // Badge de estado
        const estadoBadge = estado === 'activo'
          ? '<span class="badge bg-success">ACTIVO</span>'
          : '<span class="badge bg-danger">INACTIVO</span>';

        // Badge de rol
        const rolText = (usuario.role || 'USER').toUpperCase();
        let rolClass = 'bg-primary';
        if (rolText === 'EMPLEADO') rolClass = 'bg-info';
        if (rolText === 'AFILIADO') rolClass = 'bg-warning';
        if (rolText === 'OPERATIVO') rolClass = 'bg-secondary';

        const rolBadge = `<span class="badge ${rolClass}">${rolText}</span>`;

        // Empresa vinculada
        const empresaHTML = tieneEmpresa
          ? `
            <div>
              <strong>${usuario.nombre_empresa}</strong><br>
              <small class="text-muted">NIT: ${usuario.empresa_nit}</small>
            </div>
          `
          : `<span class="text-danger font-weight-bold">üö´ SIN EMPRESA</span>`;

        html += `
          <tr class="${rowClass}">
            <td class="text-center font-weight-bold">${index + 1}</td>
            <td>${nombres || 'N/A'}</td>
            <td>${apellidos || 'N/A'}</td>
            <td class="text-center">${usuario.numeroId || 'N/A'}</td>
            <td class="text-center">${estadoBadge}</td>
            <td class="text-center">${rolBadge}</td>
            <td>${empresaHTML}</td>
            <td class="text-center">
              <a
                href="/api/unificacion/formulario_vinculacion/${usuario.id}"
                target="_blank"
                class="btn btn-sm btn-success"
                title="Gestionar vinculaci√≥n"
              >
                <i data-feather="edit-2" class="w-4 h-4"></i>
              </a>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;

      // Reinicializar iconos Feather
      if (typeof feather !== 'undefined') {
        feather.replace();
      }
    }

    // ==========================================================================
    // FUNCI√ìN: LIMPIAR FILTROS
    // ==========================================================================
    function limpiarFiltros() {
      console.log('üßπ Limpiando filtros...');

      document.getElementById('filtroUserTipoDoc').value = '';
      document.getElementById('filtroUserDoc').value = '';
      document.getElementById('filtroUserNombre').value = '';
      document.getElementById('filtroEmpresaTipoDoc').value = '';
      document.getElementById('filtroEmpresaNit').value = '';
      document.getElementById('filtroEmpresaNombre').value = '';

      // Renderizar todos los registros
      renderizarTabla(todosLosUsuarios);

      Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'info',
        title: 'Filtros limpiados',
        showConfirmButton: false,
        timer: 2000
      });
    }

  </script>
</body>
</html>
