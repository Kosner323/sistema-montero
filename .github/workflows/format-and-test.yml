name: Format & Test Pipeline

# Trigger: Se ejecuta en cada push o pull request a main
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Jobs principales
jobs:
  # ============================================================================
  # JOB 1: VERIFICACI√ìN DE FORMATEO CON BLACK
  # ============================================================================
  format-check:
    name: Format Check (Black)
    runs-on: ubuntu-latest

    steps:
    # Paso 1: Checkout del c√≥digo
    - name: Checkout code
      uses: actions/checkout@v4

    # Paso 2: Configurar Python
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    # Paso 3: Instalar Black
    - name: Install Black
      run: |
        python -m pip install --upgrade pip
        pip install black>=24.0.0

    # Paso 4: Ejecutar Black en modo check
    - name: Run Black formatter check
      run: |
        echo "Verificando formato de codigo con Black..."
        black --check --diff .
        if [ $? -eq 0 ]; then
          echo "‚úÖ Codigo formateado correctamente"
        else
          echo "‚ùå Codigo no cumple con el formato de Black"
          echo "Ejecuta 'black .' localmente para formatear"
          exit 1
        fi

  # ============================================================================
  # JOB 2: EJECUCI√ìN DE TESTS
  # ============================================================================
  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
    # Paso 1: Checkout del c√≥digo
    - name: Checkout code
      uses: actions/checkout@v4

    # Paso 2: Configurar Python
    - name: Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    # Paso 3: Crear directorios necesarios
    - name: Setup environment & Directories
      run: |
        mkdir -p data logs formularios_pdf
        mkdir -p test_data/usuarios test_data/empresas

        # Crear archivo .env para testing
        cat > .env << 'EOF'
        SECRET_KEY=test-secret-key-for-ci-12345678901234567890123456789012
        ENCRYPTION_KEY=HLh9Yfi7v5-QnQ4WYALaTPIC__LX-VqCK01eJBNK8Zw=
        FLASK_ENV=testing
        DATABASE_PATH=./test_ci_db.db
        LOG_LEVEL=ERROR
        MAIL_SERVER=smtp.gmail.com
        MAIL_PORT=587
        MAIL_USE_TLS=True
        MAIL_USERNAME=test@example.com
        MAIL_PASSWORD=test_password
        MAIL_DEFAULT_SENDER=Test <test@example.com>
        EOF

    # Paso 4: Instalar dependencias
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # Paso 5: Inicializar base de datos de prueba
    - name: Initialize test database
      run: |
        python -c "import sqlite3; conn = sqlite3.connect('./test_ci_db.db'); conn.close()"

    # Paso 6: Ejecutar tests
    - name: Run tests with pytest
      run: |
        echo "Ejecutando tests con pytest..."
        pytest --cov=. --cov-report=xml --cov-report=term-missing -v
      env:
        FLASK_ENV: testing
        SECRET_KEY: test-secret-key-for-ci-12345678901234567890123456789012
        ENCRYPTION_KEY: HLh9Yfi7v5-QnQ4WYALaTPIC__LX-VqCK01eJBNK8Zw=
        DATABASE_PATH: './test_ci_db.db'

    # Paso 7: Upload de resultados
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-python-${{ matrix.python-version }}
        path: |
          coverage.xml
          htmlcov

  # ============================================================================
  # JOB 3: RESUMEN (se ejecuta despu√©s de los otros dos)
  # ============================================================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [format-check, run-tests]
    if: always()

    steps:
    - name: Check results
      run: |
        echo "============================================="
        echo "RESUMEN DEL PIPELINE"
        echo "============================================="

        if [ "${{ needs.format-check.result }}" == "success" ]; then
          echo "‚úÖ Formateo: PASSED"
        else
          echo "‚ùå Formateo: FAILED"
        fi

        if [ "${{ needs.run-tests.result }}" == "success" ]; then
          echo "‚úÖ Tests: PASSED"
        else
          echo "‚ùå Tests: FAILED"
        fi

        echo "============================================="

        if [ "${{ needs.format-check.result }}" == "success" ] && [ "${{ needs.run-tests.result }}" == "success" ]; then
          echo "üéâ PIPELINE EXITOSO"
          exit 0
        else
          echo "üí• PIPELINE FALL√ì"
          exit 1
        fi
