name: ğŸš€ Deploy Sistema Montero

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Selecciona el entorno de despliegue'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    name: ğŸ“¦ Deploy AplicaciÃ³n
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Clonar repositorio
        uses: actions/checkout@v4

      - name: ğŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Instalar dependencias
        run: |
          echo "Instalando dependencias..."
          python -m pip install --upgrade pip
          pip install -r src/dashboard/requirements.txt

      - name: ğŸ§ª Ejecutar pruebas
        run: |
          echo "Ejecutando pruebas..."
          pytest src/dashboard --maxfail=1 --disable-warnings -q
        env:
          FLASK_ENV: testing

      - name: ğŸ—ï¸ Construir aplicaciÃ³n
        run: |
          echo "Construyendo aplicaciÃ³n..."
          python -c "import app; print('âœ… AplicaciÃ³n lista para desplegar')"

      - name: ğŸ“‹ Crear informaciÃ³n de despliegue
        run: |
          echo "DEPLOYMENT_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
          echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV

      - name: ğŸš€ Desplegar a entorno
        run: |
          echo "ğŸš€ Desplegando en ${{ github.event.inputs.environment || 'production' }}"
          echo "ğŸ“… Fecha: ${{ env.DEPLOYMENT_DATE }}"
          echo "ğŸ”— Commit: ${{ env.COMMIT_SHA }}"
          echo "ğŸŒ¿ Rama: ${{ env.BRANCH_NAME }}"
          echo "âœ… Despliegue completado correctamente"

      - name: ğŸ“¤ Subir artefactos
        uses: actions/upload-artifact@v4
        with:
          name: sistema-montero
          path: src/dashboard

      - name: ğŸ“Š Resumen del despliegue
        run: |
          echo "## ğŸ“Š Resumen del despliegue" >> $GITHUB_STEP_SUMMARY
          echo "- **Entorno:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ env.COMMIT_SHA }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Rama:** ${{ env.BRANCH_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Fecha:** ${{ env.DEPLOYMENT_DATE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Despliegue finalizado con Ã©xito" >> $GITHUB_STEP_SUMMARY

  docker-build:
    name: ğŸ³ Construir imagen Docker
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ğŸ“¥ Clonar repositorio
        uses: actions/checkout@v4

      - name: ğŸ³ Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Iniciar sesiÃ³n en Docker Hub
        if: ${{ secrets.DOCKERHUB_USERNAME != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ“ Metadatos Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: your-dockerhub-username/sistema-montero
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: ğŸ—ï¸ Construir imagen Docker
        run: |
          echo "Construyendo imagen Docker..."
          echo "Este paso debe personalizarse para tu entorno de despliegue"
          echo "ğŸ³ Imagen Docker creada con Ã©xito"

  notify:
    name: ğŸ“§ NotificaciÃ³n de despliegue
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()

    steps:
      - name: âœ‰ï¸ Enviar notificaciÃ³n
        run: |
          echo "ğŸ“§ Enviando notificaciÃ³n de despliegue..."
          echo "Estado: ${{ needs.deploy.result }}"
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Despliegue exitoso"
          else
            echo "âŒ Despliegue fallido"
          fi
