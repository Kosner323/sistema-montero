name: Deploy

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ§ª Run quick tests
      run: |
        pytest -v --maxfail=1
      env:
        FLASK_ENV: testing
    
    - name: ğŸ—ï¸ Build application
      run: |
        echo "Building application..."
        python -c "import app; print('âœ… Application ready')"
    
    - name: ğŸ“‹ Create deployment info
      run: |
        echo "DEPLOYMENT_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
        echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
    
    - name: ğŸš€ Deploy to Environment
      run: |
        echo "ğŸš€ Deploying to ${{ github.event.inputs.environment || 'production' }}"
        echo "ğŸ“… Date: ${{ env.DEPLOYMENT_DATE }}"
        echo "ğŸ”— Commit: ${{ env.COMMIT_SHA }}"
        echo "ğŸŒ¿ Branch: ${{ env.BRANCH_NAME }}"
        
        # Here you would add your actual deployment commands
        # Examples:
        # - SSH to server and pull changes
        # - Upload to cloud provider (AWS, Azure, GCP)
        # - Deploy to container registry
        # - Update Kubernetes manifests
        
        echo "âœ… Deployment completed successfully"
    
    - name: ğŸ“Š Deployment summary
      run: |
        echo "## Deployment Summary ğŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ env.COMMIT_SHA }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ env.BRANCH_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Date:** ${{ env.DEPLOYMENT_DATE }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Deployment completed successfully" >> $GITHUB_STEP_SUMMARY

  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ” Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
      # ***** INICIO DE LA CORRECCIÃ“N *****
      # Se quitaron los ${{ }} de la condiciÃ³n if
      if: secrets.DOCKERHUB_USERNAME != ''
      # ***** FIN DE LA CORRECCIÃ“N *****
    
    - name: ğŸ“ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          your-dockerhub-username/sistema-montero
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
    
    - name: ğŸ—ï¸ Build Docker image
      run: |
        echo "Building Docker image..."
        echo "This is a placeholder - configure with your Docker registry"
        
        # Uncomment when ready to use:
        # docker build -t sistema-montero:${{ github.ref_name }} .
    
    - name: âœ… Docker Build Complete
      run: |
        echo "ğŸ³ Docker image built successfully"
        echo "ğŸ“¦ Tag: ${{ github.ref_name }}"

  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
    - name: ğŸ“§ Send notification
      run: |
        echo "ğŸ“§ Sending deployment notification..."
        echo "Status: ${{ needs.deploy.result }}"
        
        # Here you would add notification logic:
        # - Slack webhook
        # - Discord webhook
        # - Email notification
        # - Teams webhook
        
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… Deployment successful - notifications sent"
        else
          echo "âŒ Deployment failed - alert sent"
        fi
