name: Security Scans

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans every Monday at 9 AM
    - cron: '0 9 * * 1'

jobs:
  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety pip-audit
    
    - name: ğŸ”’ Run Bandit Security Scan
      run: |
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -f txt || true
      continue-on-error: true
    
    - name: ğŸ“¦ Check for known vulnerabilities in dependencies
      run: |
        safety check --json > safety-report.json || true
        safety check || true
      continue-on-error: true
    
    - name: ğŸ” Run pip-audit
      run: |
        pip-audit --desc || true
      continue-on-error: true
    
    - name: ğŸ“‹ Upload security reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
    
    - name: ğŸ›¡ï¸ Security Summary
      run: |
        echo "ğŸ”’ Security scan completed"
        echo "ğŸ“Š Check artifacts for detailed reports"
        echo "âš ï¸  Review any HIGH severity issues"

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Dependency Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: moderate
        comment-summary-in-pr: true

  secret-scanning:
    name: Secret Detection
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ” TruffleHog Secret Scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified
      continue-on-error: true
    
    - name: âœ… Secret Scan Complete
      run: |
        echo "ğŸ” Secret scanning completed"
        echo "âœ… Review any detected secrets in logs"
