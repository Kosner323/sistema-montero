<!doctype html>
<html lang="es" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
  <head>
    <meta charset="utf-8" />
    <title>Gestión de Unificación | Portal Montero</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="Unificación de usuarios y empresas en el Sistema Montero." />
    <meta name="author" content="Montero y Negocio" />
    <link rel="icon" href="/assets/images/favicon.svg" type="image/x-icon" />

    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/fonts/phosphor/duotone/style.css" />
    <link rel="stylesheet" href="/assets/fonts/tabler-icons.min.css" />
    <link rel="stylesheet" href="/assets/fonts/feather.css" />
    <link rel="stylesheet" href="/assets/fonts/fontawesome.css" />
    <link rel="stylesheet" href="/assets/fonts/material.css" />
    <link rel="stylesheet" href="/assets/css/style.css" id="main-style-link" />
    
    <style>
      /* Estilo para la tarjeta seleccionada */
      .user-empresa-card.selected {
        border: 2px solid #3f51b5;
        background-color: #f0f9ff;
        box-shadow: 0 5px 20px rgba(63, 81, 181, 0.2);
      }
      
      .user-empresa-card {
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .connection-line {
        border-left: 3px dashed #3f51b5;
        height: 50px;
        margin: 1rem auto;
        width: 0;
      }

      .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      /* Estilo para el 'Cuadro de Datos' del resultado */
      .info-card {
        background-color: #f8f9fa; /* Un fondo gris claro */
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
      }
      .info-card i {
        font-size: 2.5rem; /* Icono más grande */
        margin-bottom: 1rem;
        display: block;
      }
      .info-card h6 {
        font-weight: 700;
        margin-bottom: 0.25rem;
      }
      .info-card small {
        font-size: 0.9rem;
        color: #6c757d;
      }
      .info-card .badge {
        font-size: 0.9rem;
        font-weight: 600;
        padding: 0.5em 1em;
      }

    </style>
  </head>
  
  <body>
    <div class="loader-bg fixed inset-0 bg-white dark:bg-themedark-cardbg z-[1034]" style="display: none;">
      <div class="loader-track h-[5px] w-full inline-block absolute overflow-hidden top-0">
        <div class="loader-fill w-[300px] h-[5px] bg-primary-500 absolute top-0 left-0 animate-[hitZak_0.6s_ease-in-out_infinite_alternate]"></div>
      </div>
    </div>

    <nav class="pc-sidebar">
      <div class="navbar-wrapper">
        <div class="m-header flex items-center py-4 px-6 h-header-height">
          <a href="index.html" class="b-brand flex items-center gap-3">
            <img src="/assets/images/logo-white.svg" class="img-fluid logo logo-lg" alt="logo" />
            <img src="/assets/images/favicon.svg" class="img-fluid logo logo-sm" alt="logo" />
          </a>
        </div>
        <div class="navbar-content h-[calc(100vh_-_80px)] py-2.5 overflow-y-auto">
          <ul class="pc-navbar">
            <li class="pc-item pc-caption"><label>NAVIGATION</label></li>
            <li class="pc-item"><a href="index.html" class="pc-link"><span class="pc-micon"><i data-feather="home"></i></span><span class="pc-mtext">DASHBOARD</span></a></li>
            <li class="pc-item pc-caption"><label>ADMINISTRACIÓN Y FINANZAS</label><i data-feather="settings"></i></li>
            <li class="pc-item pc-hasmenu">
              <a href="#!" class="pc-link"><span class="pc-micon"><i data-feather="database"></i></span><span class="pc-mtext">BASE DE DATOS</span><span class="pc-arrow"><i class="ti ti-chevron-right"></i></span></a>
              <ul class="pc-submenu">
                <li class="pc-item"><a class="pc-link" href="base-datos-usuarios.html">USUARIOS</a></li>
                <li class="pc-item"><a class="pc-link" href="ingresar_empresa.html">EMPRESAS</a></li>
              </ul>
            </li>
            <li class="pc-item active">
              <a href="unificacion.html" class="pc-link is-active"><span class="pc-micon"><i data-feather="git-merge"></i></span><span class="pc-mtext">UNIFICACIÓN</span></a>
            </li>
            <li class="pc-item pc-hasmenu">
              <a href="#!" class="pc-link"><span class="pc-micon"><i data-feather="book-open"></i></span><span class="pc-mtext">CONTABILIDAD</span><span class="pc-arrow"><i class="ti ti-chevron-right"></i></span></a>
              <ul class="pc-submenu">
                <li class="pc-item"><a class="pc-link" href="pagos.html">PAGOS</a></li>
                <li class="pc-item"><a class="pc-link" href="tabla.html">TABLA</a></li>
                <li class="pc-item"><a class="pc-link" href="pago-planillas.html">PAGO DE PLANILLAS</a></li>
                <li class="pc-item"><a class="pc-link" href="enviar-planillas.html">ENVIAR PLANILLAS</a></li>
              </ul>
            </li>
            <li class="pc-item pc-caption"><label>GESTIÓN OPERATIVA</label><i data-feather="bar-chart-2"></i></li>
            <li class="pc-item"><a href="novedades.html" class="pc-link"><span class="pc-micon"><i data-feather="bell"></i></span><span class="pc-mtext">NOVEDADES</span></a></li>
            <li class="pc-item"><a href="formularios.html" class="pc-link"><span class="pc-micon"><i data-feather="align-justify"></i></span><span class="pc-mtext">FORMULARIOS</span></a></li>
            <li class="pc-item pc-hasmenu">
              <a href="#!" class="pc-link"><span class="pc-micon"><i data-feather="gavel"></i></span><span class="pc-mtext">GESTIÓN JURÍDICA</span><span class="pc-arrow"><i class="ti ti-chevron-right"></i></span></a>
              <ul class="pc-submenu">
                <li class="pc-item"><a class="pc-link" href="incapacidades.html">INCAPACIDADES</a></li>
                <li class="pc-item"><a class="pc-link" href="tutelas.html">TUTELAS</a></li>
                <li class="pc-item"><a class="pc-link" href="depuraciones.html">DEPURACIONES</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <header class="pc-header">
      <div class="header-wrapper flex max-sm:px-[15px] px-[25px] grow">
        <div class="me-auto pc-mob-drp">
          <ul class="inline-flex *:min-h-header-height *:inline-flex *:items-center">
            <li class="pc-h-item pc-sidebar-collapse max-lg:hidden lg:inline-flex">
              <a href="#" class="pc-head-link ltr:!ml-0 rtl:!mr-0" id="sidebar-hide">
                <i data-feather="menu"></i>
              </a>
            </li>
            <li class="pc-h-item pc-sidebar-popup lg:hidden">
              <a href="#" class="pc-head-link ltr:!ml-0 rtl:!mr-0" id="mobile-collapse">
                <i data-feather="menu"></i>
              </a>
            </li>
          </ul>
        </div>
        <div class="ms-auto">
          <ul class="inline-flex *:min-h-header-height *:inline-flex *:items-center">
            <li class="dropdown pc-h-item">
              <a class="pc-head-link dropdown-toggle me-0" data-pc-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
                <i data-feather="sun"></i>
              </a>
              <div class="dropdown-menu dropdown-menu-end pc-h-dropdown">
                <a href="#!" class="dropdown-item" onclick="layout_change('dark')">
                  <i data-feather="moon"></i> <span>Oscuro</span>
                </a>
                <a href="#!" class="dropdown-item" onclick="layout_change('light')">
                  <i data-feather="sun"></i> <span>Claro</span>
                </a>
                <a href="#!" class="dropdown-item" onclick="layout_change_default()">
                  <i data-feather="settings"></i> <span>Por Defecto</span>
                </a>
              </div>
            </li>
            
            <li class="dropdown pc-h-item">
              <a class="pc-head-link dropdown-toggle arrow-none me-0" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
                <i data-feather="user"></i>
              </a>
              <div class="dropdown-menu dropdown-menu-end pc-h-dropdown">
                <div class="dropdown-header">
                  <h6 class="text-overflow m-0">¡Hola, <span id="userNameDisplay">Usuario</span>!</h6>
                </div>
                <a href="#!" class="dropdown-item" id="logoutButton">
                  <i data-feather="log-out"></i>
                  <span>Cerrar Sesión</span>
                </a>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </header>
    
    <div class="pc-container">
      <div class="pc-content">
        
        <div class="page-header" id="pageHeaderBlock">
          <div class="page-block">
            <div class="row align-items-center">
              <div class="col-md-12">
                <ul class="breadcrumb mb-3">
                  <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                  <li class="breadcrumb-item"><a href="javascript: void(0)">Administración y Finanzas</a></li>
                  <li class="breadcrumb-item" aria-current="page">Unificación de Datos</li>
                </ul>
              </div>
              <div class="col-md-12">
                <div class="page-header-title">
                  <h2 class="mb-0" id="main-title">Gestión de Unificación Usuario-Empresa</h2>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="feedbackMessageFormularios" class="mb-4"></div>

        <div class="grid grid-cols-12 gap-x-6">
          <div class="col-span-12 md:col-span-6 lg:col-span-3">
            <div class="card bg-primary-50">
              <div class="card-body">
                <h5 class="text-muted mb-2">Total Usuarios</h5>
                <div class="flex items-center justify-between">
                  <h3 class="mb-0" id="totalUsuariosCount">0</h3>
                  <i data-feather="users" class="text-primary-600 text-2xl"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-span-12 md:col-span-6 lg:col-span-3">
            <div class="card bg-success-50">
              <div class="card-body">
                <h5 class="text-muted mb-2">Total Empresas</h5>
                <div class="flex items-center justify-between">
                  <h3 class="mb-0" id="totalEmpresasCount">0</h3>
                  <i data-feather="briefcase" class="text-success-600 text-2xl"></i>
                </div>
              </div>
            </div>
          </div>
           <div class="col-span-12 md:col-span-6 lg:col-span-3">
             <div class="card bg-info-50">
               <div class="card-body">
                 <h5 class="text-muted mb-2">Usuarios Asignados</h5>
                 <div class="flex items-center justify-between">
                   <h3 class="mb-0" id="usuariosAsignadosCount">0</h3>
                   <i data-feather="user-check" class="text-info-600 text-2xl"></i>
                 </div>
               </div>
             </div>
           </div>
           <div class="col-span-12 md:col-span-6 lg:col-span-3">
             <div class="card bg-danger-50">
               <div class="card-body">
                 <h5 class="text-muted mb-2">Sin Asignar</h5>
                 <div class="flex items-center justify-between">
                   <h3 class="mb-0" id="usuariosSinAsignarCount">0</h3>
                   <i data-feather="user-x" class="text-danger-600 text-2xl"></i>
                 </div>
               </div>
             </div>
           </div>
        </div>

        
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header bg-primary-500 text-white">
                <h5 class="mb-0 text-white">
                  <i data-feather="search" style="width: 20px; height: 20px; vertical-align: middle;"></i>
                  Buscar Usuario para Gestionar
                </h5>
              </div>
              <div class="card-body">
                <form id="formBuscarUsuario">
                  <div class="row g-3 align-items-end">
                    <div class="col-md-5">
                      <label for="searchNumeroId" class="form-label">Número de ID del Usuario</label>
                      <input type="text" class="form-control" id="searchNumeroId" placeholder="Ingresar documento para buscar..." required>
                      </div>
                    <div class="col-md-5">
                      <label for="searchNombre" class="form-label">Nombre (Opcional)</label>
                      <input type="text" class="form-control" id="searchNombre" placeholder="Filtrar por nombre...">
                      </div>
                    <div class="col-md-2">
                      <button type="submit" class="btn btn-primary w-100" id="btnBuscarUsuario">
                        <i data-feather="search" style="width: 16px; height: 16px;"></i>
                        <span>Buscar</span>
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <div id="resultadoCuadro" class="row" style="display: none;">
          
          <div class="col-md-5 mb-4">
            <h5 class="mb-3"><i data-feather="user" class="text-primary-500"></i> Usuario Encontrado</h5>
            <div class="info-card">
              <i data-feather="user" class="text-primary-500"></i>
              <h6 id="cuadroUsuarioNombre">Nombre Completo del Usuario</h6>
              <small id="cuadroUsuarioDoc">Documento: 123456789</small>
            </div>
          </div>

          <div class="col-md-2 mb-4">
            <h5 class="mb-3 text-center">Acciones</h5>
            <div class="d-flex flex-column align-items-center justify-content-center h-100">
              <button class="btn btn-primary w-100 mb-3" id="btnAsignarCambiar">
                <i data-feather="arrow-right" style="width: 16px; height: 16px;"></i>
                <span>Asignar / Cambiar</span>
              </button>
              <button class="btn btn-danger w-100" id="btnQuitarEmpresa" disabled>
                <i data-feather="x" style="width: 16px; height: 16px;"></i>
                <span>Quitar</span>
              </button>
            </div>
          </div>

          <div class="col-md-5 mb-4">
            <h5 class="mb-3"><i data-feather="briefcase" class="text-success-500"></i> Empresa Asignada</h5>
            <div id="cuadroInfoEmpresa" class="info-card">
              </div>
            
            <div id="cuadroBuscarEmpresa" class="card mt-3" style="display: none;">
               <div class="card-header bg-success-500 text-white">
                <h5 class="mb-0 text-white">Seleccionar Nueva Empresa</h5>
              </div>
              <div class="card-body">
                <div class="row g-3 mb-3">
                  <div class="col-md-6">
                    <label for="searchEmpresaNit" class="form-label">NIT</label>
                    <input type="text" class="form-control" id="searchEmpresaNit" placeholder="Buscar por NIT...">
                  </div>
                  <div class="col-md-6">
                    <label for="searchEmpresaNombre" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="searchEmpresaNombre" placeholder="Buscar por nombre...">
                  </div>
                </div>
                <div id="empresasContainer" style="max-height: 300px; overflow-y: auto;">
                  </div>
                 <button class="btn btn-success w-100 mt-3" id="btnConfirmarAsignacion" disabled>
                    <i data-feather="check" style="width: 16px; height: 16px;"></i>
                    <span>Confirmar Asignación</span>
                  </button>
              </div>
            </div>
            
          </div>
        </div>

      </div>
    </div>

    <footer class="pc-footer">
      <div class="footer-wrapper container-fluid mx-10">
        <div class="grid grid-cols-12 gap-1.5">
          <div class="col-span-12 sm:col-span-6 my-1"><p class="m-0">Datta Able &#9829; <a href="https://codedthemes.com/" target="_blank">CodedThemes</a></p></div>
          <div class="col-span-12 sm:col-span-6 my-1 justify-self-end"><p>Distributed by <a href="https://themewagon.com" target="_blank">ThemeWagon</a></p></div>
        </div>
      </div>
    </footer>

    <script src="/assets/js/plugins/popper.min.js"></script>
    <script src="/assets/js/plugins/simplebar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/plugins/feather.min.js"></script>
    <script src="/assets/js/component.js"></script>
    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/script.js"></script>

    <script>
      // === INICIO LÓGICA DE NUEVO DISEÑO ===
      
      // Variables globales
      let todosLosUsuarios = []; // Almacenará todos los usuarios
      let todasLasEmpresas = []; // Almacenará todas las empresas
      let usuarioGestionado = null; // El usuario que se buscó y encontró
      let empresaSeleccionada = null; // La nueva empresa seleccionada (si se cambia)

      // Elementos del DOM
      const formBuscarUsuario = document.getElementById('formBuscarUsuario');
      const btnBuscarUsuario = document.getElementById('btnBuscarUsuario');
      const resultadoCuadro = document.getElementById('resultadoCuadro');
      const feedbackDiv = document.getElementById('feedbackMessageFormularios');
      
      // Elementos del Cuadro de Datos
      const cuadroUsuarioNombre = document.getElementById('cuadroUsuarioNombre');
      const cuadroUsuarioDoc = document.getElementById('cuadroUsuarioDoc');
      const cuadroInfoEmpresa = document.getElementById('cuadroInfoEmpresa');
      const btnAsignarCambiar = document.getElementById('btnAsignarCambiar');
      const btnQuitarEmpresa = document.getElementById('btnQuitarEmpresa');
      const cuadroBuscarEmpresa = document.getElementById('cuadroBuscarEmpresa');
      const empresasContainer = document.getElementById('empresasContainer');
      const btnConfirmarAsignacion = document.getElementById('btnConfirmarAsignacion');


      // Cargar datos al iniciar
      document.addEventListener('DOMContentLoaded', async function() {
        feather.replace();
        
        // Verificar autenticación
        await verificarAutenticacion();
        
        // Cargar AMBOS listados en memoria para poder buscar
        await cargarUsuariosEnMemoria();
        await cargarEmpresasEnMemoria();
        
        // Actualizar estadísticas al cargar la página
        actualizarEstadisticas(); 
        
        // === Event Listeners del Nuevo Flujo ===
        formBuscarUsuario.addEventListener('submit', handleBuscarUsuario);
        
        btnAsignarCambiar.addEventListener('click', () => {
          // Muestra el cuadro de búsqueda de empresas
          cuadroBuscarEmpresa.style.display = 'block';
          renderizarEmpresas(todasLasEmpresas); // Muestra todas las empresas
          // Habilitar filtros de empresa
          document.getElementById('searchEmpresaNit').addEventListener('input', filtrarEmpresas);
          document.getElementById('searchEmpresaNombre').addEventListener('input', filtrarEmpresas);
        });
        
        btnQuitarEmpresa.addEventListener('click', desasignarEmpresa);
        btnConfirmarAsignacion.addEventListener('click', asignarEmpresa);
        document.getElementById('logoutButton').addEventListener('click', handleLogout);
      });

      // Verificar autenticación
      async function verificarAutenticacion() {
        try {
          const response = await fetch('/api/check_auth', { method: 'GET', credentials: 'include' });
          const data = await response.json();
          if (!response.ok || !data.authenticated) {
            window.location.href = 'ingresoportal.html';
          } else {
             const userNameDisplay = document.getElementById('userNameDisplay');
             if(userNameDisplay && data.user_name) userNameDisplay.textContent = data.user_name;
          }
        } catch (error) {
          console.error('Error verificando autenticación:', error);
          window.location.href = 'ingresoportal.html';
        }
      }

      // Cargar usuarios en memoria
      async function cargarUsuariosEnMemoria() {
        try {
          const response = await fetch('/api/unificacion/usuarios', { method: 'GET', credentials: 'include' });
          if (response.ok) {
            todosLosUsuarios = await response.json();
            console.log(`Cargados ${todosLosUsuarios.length} usuarios en memoria.`);
          } else {
            mostrarMensaje('Error fatal al cargar usuarios', 'error');
          }
        } catch (error) {
          mostrarMensaje('Error de conexión al cargar usuarios', 'error');
        }
      }

      // Cargar empresas en memoria
      async function cargarEmpresasEnMemoria() {
        try {
          const response = await fetch('/api/unificacion/empresas', { method: 'GET', credentials: 'include' });
          if (response.ok) {
            todasLasEmpresas = await response.json();
            console.log(`Cargadas ${todasLasEmpresas.length} empresas en memoria.`);
          } else {
            mostrarMensaje('Error fatal al cargar empresas', 'error');
          }
        } catch (error) {
          mostrarMensaje('Error de conexión al cargar empresas', 'error');
        }
      }
      
      // === Lógica de Búsqueda y Visualización ===

      // 1. Manejador del Formulario de Búsqueda
      function handleBuscarUsuario(e) {
        e.preventDefault();
        const numIdBuscado = document.getElementById('searchNumeroId').value.trim().toLowerCase();
        
        if (!numIdBuscado) {
          mostrarMensaje('Por favor, ingrese un Número de ID para buscar.', 'warning');
          return;
        }

        // Buscar en la lista de usuarios en memoria
        const encontrado = todosLosUsuarios.find(u => (u.numeroId || '').toLowerCase() === numIdBuscado);

        if (encontrado) {
          usuarioGestionado = encontrado; // Guardar usuario globalmente
          
          // Llenar el 'Cuadro de Datos'
          cuadroUsuarioNombre.textContent = usuarioGestionado.nombre || 'Usuario Sin Nombre';
          cuadroUsuarioDoc.textContent = `Documento: ${usuarioGestionado.numeroId}`;
          
          // Actualizar el cuadro de empresa
          actualizarCuadroEmpresa(usuarioGestionado.empresa_nit, usuarioGestionado.empresa_nombre);
          
          // Habilitar/deshabilitar botón de quitar
          btnQuitarEmpresa.disabled = !usuarioGestionado.empresa_nit;
          
          // Mostrar el 'Cuadro de Datos'
          resultadoCuadro.style.display = 'flex'; // 'flex' para que funcione el row
          cuadroBuscarEmpresa.style.display = 'none'; // Ocultar selector de empresa
          btnConfirmarAsignacion.disabled = true; // Deshabilitar confirmación
          empresaSeleccionada = null; // Limpiar selección
          mostrarMensaje(`Usuario "${usuarioGestionado.nombre}" encontrado.`, 'success');
          
        } else {
          // No se encontró
          usuarioGestionado = null;
          resultadoCuadro.style.display = 'none'; // Ocultar cuadro
          mostrarMensaje('No se encontró ningún usuario con ese Número de ID.', 'error');
        }
        feather.replace();
      }

      // 2. Actualizar el cuadro de empresa
      function actualizarCuadroEmpresa(nit, nombre) {
        if (nit) {
          cuadroInfoEmpresa.innerHTML = `
            <i data-feather="briefcase" class="text-success-500"></i>
            <h6>${nombre || 'Empresa Sin Nombre'}</h6>
            <small>NIT: ${nit}</small>
          `;
        } else {
          cuadroInfoEmpresa.innerHTML = `
            <i data-feather="alert-circle" class="text-danger-500"></i>
            <h6>Sin Empresa Asignada</h6>
            <span class="badge bg-danger-500">Este usuario no tiene empresa</span>
          `;
        }
        feather.replace();
      }

      // 3. Renderizar empresas (para seleccionar)
      function renderizarEmpresas(data) {
        if (data.length === 0) {
          empresasContainer.innerHTML = `<p class="text-center text-muted p-3">No se encontraron empresas.</p>`;
          return;
        }
        
        empresasContainer.innerHTML = data.map(empresa => `
          <div class="card user-empresa-card mb-2" data-empresa-nit="${empresa.nit}" onclick="seleccionarEmpresa('${empresa.nit}')">
            <div class="card-body p-3">
                <h6 class="mb-1 fw-bold">${empresa.nombre_empresa || 'Sin nombre'}</h6>
                <p class="mb-0 text-muted" style="font-size: 0.9rem;">NIT: ${empresa.nit}</p>
            </div>
          </div>
        `).join('');
      }
      
      // 4. Filtrar lista de empresas (para seleccionar)
      function filtrarEmpresas() {
        const searchTermNit = document.getElementById('searchEmpresaNit').value.toLowerCase();
        const searchTermNombre = document.getElementById('searchEmpresaNombre').value.toLowerCase();
        
        const filtradas = todasLasEmpresas.filter(e => 
          (e.nit || '').toLowerCase().includes(searchTermNit) &&
          (e.nombre_empresa || '').toLowerCase().includes(searchTermNombre)
        );
        renderizarEmpresas(filtradas);
      }

      // 5. Seleccionar nueva empresa
      function seleccionarEmpresa(nit) {
        // Limpiar selección previa
        document.querySelectorAll('#empresasContainer .user-empresa-card').forEach(card => {
          card.classList.remove('selected');
        });
        
        // Seleccionar nueva
        const card = document.querySelector(`[data-empresa-nit="${nit}"]`);
        if (card) {
          card.classList.add('selected');
          empresaSeleccionada = todasLasEmpresas.find(e => e.nit === nit);
          btnConfirmarAsignacion.disabled = false; // Habilitar botón de confirmar
        } else {
          empresaSeleccionada = null;
          btnConfirmarAsignacion.disabled = true;
        }
      }
      
      // === Lógica de Acciones (Asignar/Desasignar) ===

      // Asignar (Confirmar)
      async function asignarEmpresa() {
        if (!usuarioGestionado || !empresaSeleccionada) {
          mostrarMensaje('Error: No hay usuario o empresa seleccionada.', 'error');
          return;
        }
        
        const btn = btnConfirmarAsignacion;
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span><span>Asignando...</span>';
        
        try {
          const response = await fetch('/api/unificacion/asignar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({
              usuario_id: usuarioGestionado.numeroId,
              empresa_nit: empresaSeleccionada.nit
            })
          });
          
          const data = await response.json();
          if (response.ok) {
            mostrarMensaje('Usuario asignado exitosamente.', 'success');
            
            // Actualizar datos en memoria (IMPORTANTE)
            usuarioGestionado.empresa_nit = empresaSeleccionada.nit;
            usuarioGestionado.empresa_nombre = empresaSeleccionada.nombre_empresa;
            
            // Actualizar la UI
            actualizarCuadroEmpresa(empresaSeleccionada.nit, empresaSeleccionada.nombre_empresa);
            btnQuitarEmpresa.disabled = false;
            cuadroBuscarEmpresa.style.display = 'none'; // Ocultar cuadro de selección
            empresaSeleccionada = null;
            
            // Recargar listas en memoria y actualizar stats
            await cargarUsuariosEnMemoria();
            await cargarEmpresasEnMemoria();
            actualizarEstadisticas(); // <-- Actualizar stats
            
          } else {
            mostrarMensaje(data.error || 'Error al asignar empresa', 'error');
          }
        } catch (error) {
          mostrarMensaje('Error de conexión al asignar.', 'error');
        } finally {
          btn.innerHTML = originalHTML;
          feather.replace();
        }
      }

      // Desasignar
      async function desasignarEmpresa() {
        if (!usuarioGestionado || !usuarioGestionado.empresa_nit) return;
        
        if (!confirm(`¿Está seguro de quitar la empresa del usuario "${usuarioGestionado.nombre}"?`)) {
          return;
        }
        
        const btn = btnQuitarEmpresa;
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span><span>Quitando...</span>';
        
        try {
          const response = await fetch('/api/unificacion/desasignar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({ usuario_id: usuarioGestionado.numeroId })
          });
          
          const data = await response.json();
          if (response.ok) {
            mostrarMensaje('Empresa desasignada exitosamente.', 'success');

            // Actualizar datos en memoria
            usuarioGestionado.empresa_nit = null;
            usuarioGestionado.empresa_nombre = null;
            
            // Actualizar UI
            actualizarCuadroEmpresa(null, null);
            btn.disabled = true; // Deshabilitar botón de quitar
            
            // Recargar listas en memoria y actualizar stats
            await cargarUsuariosEnMemoria();
            await cargarEmpresasEnMemoria();
            actualizarEstadisticas(); // <-- Actualizar stats
            
          } else {
            mostrarMensaje(data.error || 'Error al desasignar', 'error');
          }
        } catch (error) {
          mostrarMensaje('Error de conexión al desasignar.', 'error');
        } finally {
          btn.innerHTML = originalHTML;
          feather.replace();
        }
      }

      // --- Funciones de Utilidad ---
      
      // Actualizar estadísticas
      async function actualizarEstadisticas() {
        // Usar los datos ya cargados en las variables globales
        try {
            const totalUsuarios = todosLosUsuarios.length;
            const totalEmpresas = todasLasEmpresas.length;
            const usuariosAsignados = todosLosUsuarios.filter(u => u.empresa_nit).length;
            const usuariosSinAsignar = totalUsuarios - usuariosAsignados;
            
            document.getElementById('totalUsuariosCount').textContent = totalUsuarios;
            document.getElementById('totalEmpresasCount').textContent = totalEmpresas;
            document.getElementById('usuariosAsignadosCount').textContent = usuariosAsignados;
            document.getElementById('usuariosSinAsignarCount').textContent = usuariosSinAsignar;

        } catch(error) {
            console.error("Error actualizando estadísticas:", error);
            // Poner valores por defecto en caso de error
            document.getElementById('totalUsuariosCount').textContent = 'N/A';
            document.getElementById('totalEmpresasCount').textContent = 'N/A';
            document.getElementById('usuariosAsignadosCount').textContent = 'N/A';
            document.getElementById('usuariosSinAsignarCount').textContent = 'N/A';
        }
      }
      
      function mostrarMensaje(message, type = 'info') {
         if (feedbackDiv) {
             const typeClass = type === 'error' ? 'danger' : (type === 'warning' ? 'warning' : (type ===_name="alert alert-${typeClass} alert-dismissible fade show" role="alert">
                                       ${message}
                                       <button type,"button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>`;
            feedbackDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
         } else {
             alert(message);
         }
      }

      async function handleLogout() {
        try {
          const response = await fetch('/api/logout', { method: 'POST', credentials: 'include' });
          if (response.ok) {
            window.location.href = 'ingresoportal.html';
          }
        } catch (error) {
          console.error('Error en logout:', error);
          window.location.href = 'ingresoportal.html';
        }
      }
    </script>
  </body>
</html>