<header class="pc-header">
  <meta charset="utf-8" />
  <div class="header-wrapper ...">
      <li class="dropdown pc-h-item">
          <a class="pc-head-link dropdown-toggle me-0" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
            <i data-feather="sun" id="themeIcon"></i>
          </a>
          <div class="dropdown-menu dropdown-menu-end pc-h-dropdown">
            <a href="#!" class="dropdown-item" onclick="layout_change('dark')">
              <i data-feather="moon"></i>
              <span>Modo Oscuro</span>
            </a>
            <a href="#!" class="dropdown-item" onclick="layout_change('light')">
              <i data-feather="sun"></i>
              <span>Modo Claro</span>
            </a>
            <a href="#!" class="dropdown-item" onclick="layout_change_default()">
              <i data-feather="settings"></i>
              <span>Por Defecto</span>
            </a>
          </div>
        </li>
      </div>
</header>

<script>
// ============================================================================
// FUNCIONES DE NAVEGACI√ìN Y UTILIDADES (Estas s√≠ pueden quedarse aqu√≠)
// ============================================================================

function navigateToPage(page) {
  window.location.href = page;
}

function openWhatsAppSupport() {
  const phoneNumber = '573001234567'; // Cambiar por el n√∫mero real
  const message = encodeURIComponent('Hola, necesito ayuda con el Portal Montero');
  window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank');
}

function lockScreen() {
  if (confirm('¬øDeseas bloquear la pantalla? Deber√°s iniciar sesi√≥n nuevamente.')) {
    sessionStorage.setItem('screenLocked', 'true');
    window.location.href = 'ingresoportal.html';
  }
}

function handleSearch(event) {
  event.preventDefault();
  const searchInput = document.getElementById('headerSearchInput');
  const query = searchInput.value.trim();
  if (query) {
    window.location.href = `busqueda.html?q=${encodeURIComponent(query)}`;
  }
}

// ============================================================================
// FUNCIONES DE NOTIFICACIONES (Se quedan aqu√≠)
// ============================================================================

async function markAllAsRead(event) {
  // ... (c√≥digo sin cambios) ...
}

function updateNotificationBadge(count) {
  // ... (c√≥digo sin cambios) ...
}

async function loadNotifications() {
  // ... (c√≥digo sin cambios) ...
}

async function markAsRead(notificationId, event) {
  // ... (c√≥digo sin cambios) ...
}

// ============================================================================
// INICIALIZACI√ìN DEL HEADER (Se queda aqu√≠)
// ============================================================================

function initializeHeaderFunctionality() {
  console.log('üé® Initializing header functionality...');
  try {
    // Configurar nombre de usuario
    const storedUserName = sessionStorage.getItem('userName');
    const userNameDisplay = document.getElementById('userNameDisplay');
    if (userNameDisplay) {
      userNameDisplay.textContent = storedUserName || 'Usuario';
    }

    const userRoleDisplay = document.getElementById('userRoleDisplay');
    if (userRoleDisplay) {
      userRoleDisplay.textContent = sessionStorage.getItem('userRole') || 'Rol';
    }

    // Inicializar tema (Llama a la funci√≥n GLOBAL de theme.js)
    // Es importante que theme.js se haya cargado ANTES que layout-loader.js llame a esto.
    if (typeof initializeTheme === 'function') {
        initializeTheme(); // Llama a la funci√≥n global
    } else {
        console.warn("initializeTheme() no est√° definida globalmente al inicializar el header.");
        // Intentar aplicar un tema b√°sico como fallback
         const savedTheme = localStorage.getItem('pc-theme');
         const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
         const theme = savedTheme || (prefersDark ? 'dark' : 'light');
         const html = document.querySelector('html');
         if(html) html.setAttribute('data-pc-theme', theme);
         updateThemeIcon(theme); // Llama a la funci√≥n global si existe, o no hace nada seguro
    }


    // Cargar notificaciones
    loadNotifications();

    // Reemplazar iconos de Feather
    if (typeof feather !== 'undefined') {
      feather.replace();
    }

    console.log('‚úÖ Header initialized successfully.');
  } catch(e) {
    console.error('‚ùå Error initializing header:', e);
  }
}

// Exponer SOLO las funciones que realmente necesitan ser globales DESDE AQU√ç
window.initializeHeaderFunctionality = initializeHeaderFunctionality;
window.navigateToPage = navigateToPage;
window.lockScreen = lockScreen;
window.handleSearch = handleSearch;
window.markAllAsRead = markAllAsRead;
window.markAsRead = markAsRead;

// Escuchar cambios en el tema del sistema (Se queda aqu√≠)
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
  if (!localStorage.getItem('pc-theme')) {
     // Llama a la funci√≥n GLOBAL
     if (typeof layout_change_default === 'function') {
         layout_change_default();
     } else {
          console.warn("layout_change_default() no definida al detectar cambio de esquema.");
     }
  }
});

// Llamada inicial (Opcional, layout-loader.js ya lo hace)
// initializeHeaderFunctionality(); // Comentado, layout-loader.js se encarga
</script>