<!doctype html>
<html lang="en" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-direction="ltr" dir="ltr" data-pc-theme="light">
  <head>
  <meta charset="utf-8" />
    <title>Registro | Portal Montero</title> 
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="description"
      content="PÃ¡gina de registro en el portal de Montero y Negocio." />
    <meta name="author" content="Montero y Negocio" />
    
    <link rel="icon" href="/assets/images/favicon.svg" type="image/x-icon" />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/fonts/phosphor/duotone/style.css" />
    <link rel="stylesheet" href="/assets/fonts/tabler-icons.min.css" />
    <link rel="stylesheet" href="/assets/fonts/feather.css" />
    <link rel="stylesheet" href="/assets/fonts/fontawesome.css" />
    <link rel="stylesheet" href="/assets/fonts/material.css" />
    <link rel="stylesheet" href="/assets/css/style.css" id="main-style-link" />
    
    <style>
      /* Estilos opcionales para mensajes */
      #messageContainer .alert {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
        font-size: 0.9em;
      }
      #messageContainer .alert-success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      #messageContainer .alert-danger {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      
      /* --- CSS DEL CAPTCHA AÃ‘ADIDO --- */
      .captcha-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }
      .captcha-question {
        color: white;
        font-size: 1.1em;
        font-weight: 500;
        text-align: center;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      .captcha-input {
        background: white;
        border: 2px solid rgba(255,255,255,0.3);
        text-align: center;
        font-size: 1.2em;
        font-weight: bold;
        color: #667eea;
        border-radius: 8px;
        padding: 10px;
        transition: all 0.3s ease;
      }
      .captcha-input:focus {
        border-color: #764ba2;
        box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.2);
        outline: none;
      }
      .captcha-refresh {
        background: rgba(255,255,255,0.2);
        color: white;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        padding: 8px 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        margin-top: 10px;
      }
      .captcha-refresh:hover {
        background: rgba(255,255,255,0.3);
        transform: translateY(-2px);
      }
    </style>

  </head>
  <body>
    <div class="loader-bg fixed inset-0 bg-white dark:bg-themedark-cardbg z-[1034]">
      <div class="loader-track h-[5px] w-full inline-block absolute overflow-hidden top-0">
        <div class="loader-fill w-[300px] h-[5px] bg-primary-500 absolute top-0 left-0 animate-[hitZak_0.6s_ease-in-out_infinite_alternate]"></div>
      </div>
    </div>
    <div class="auth-main relative">
      <div class="auth-wrapper v1 flex items-center w-full h-full min-h-screen">
        <div class="auth-form flex items-center justify-center grow flex-col min-h-screen relative p-6 ">
          <div class="w-full max-w-[350px] relative">
            <div class="auth-bg ">
              <span class="absolute top-[-100px] right-[-100px] w-[300px] h-[300px] block rounded-full bg-theme-bg-1 animate-[floating_7s_infinite]"></span>
              <span class="absolute top-[150px] right-[-150px] w-5 h-5 block rounded-full bg-primary-500 animate-[floating_9s_infinite]"></span>
              <span class="absolute left-[-150px] bottom-[150px] w-5 h-5 block rounded-full bg-theme-bg-1 animate-[floating_7s_infinite]"></span>
              <span class="absolute left-[-100px] bottom-[-100px] w-[300px] h-[300px] block rounded-full bg-theme-bg-2 animate-[floating_9s_infinite]"></span>
            </div>
            <div class="card sm:my-12  w-full shadow-none">
              <div class="card-body !p-10">
                <div class="text-center mb-8">
                  <a href="#"><img src="/assets/images/logo-dark.svg" alt="img" class="mx-auto auth-logo"/></a>
                  </div>
                
                <h4 class="text-center font-medium mb-4">Crear Cuenta</h4>

                <div id="messageContainer"></div>

                <form id="registerForm">
                  <div class="mb-3">
                    <input type="text" class="form-control" id="nombre" placeholder="Nombre Completo" required />
                  </div>
                  <div class="mb-3">
                    <input type="email" class="form-control" id="email" placeholder="Correo ElectrÃ³nico" required />
                  </div>
                  <div class="mb-3">
                    <input type="password" class="form-control" id="password" placeholder="ContraseÃ±a (mÃ­n. 6 caracteres)" required />
                  </div>
                  <div class="mb-3">
                    <input type="password" class="form-control" id="password_confirm" placeholder="Confirmar ContraseÃ±a" required />
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label text-muted" style="font-size: 0.85em;">TelÃ©fono (opcional)</label>
                    <div class="input-group">
                      <select class="form-select" id="country_code" style="max-width: 130px;">
                        <option value="+57" data-country="ğŸ‡¨ğŸ‡´ CO">ğŸ‡¨ğŸ‡´ +57</option>
                        <option value="+1" data-country="ğŸ‡ºğŸ‡¸ US">ğŸ‡ºğŸ‡¸ +1</option>
                        <option value="+52" data-country="ğŸ‡²ğŸ‡½ MX">ğŸ‡²ğŸ‡½ +52</option>
                        <option value="+34" data-country="ğŸ‡ªğŸ‡¸ ES">ğŸ‡ªğŸ‡¸ +34</option>
                        <option value="+54" data-country="ğŸ‡¦ğŸ‡· AR">ğŸ‡¦ğŸ‡· +54</option>
                        <option value="+56" data-country="ğŸ‡¨ğŸ‡± CL">ğŸ‡¨ğŸ‡± +56</option>
                        <option value="+51" data-country="ğŸ‡µğŸ‡ª PE">ğŸ‡µğŸ‡ª +51</option>
                        <option value="+58" data-country="ğŸ‡»ğŸ‡ª VE">ğŸ‡»ğŸ‡ª +58</option>
                        <option value="+593" data-country="ğŸ‡ªğŸ‡¨ EC">ğŸ‡ªğŸ‡¨ +593</option>
                        <option value="+55" data-country="ğŸ‡§ğŸ‡· BR">ğŸ‡§ğŸ‡· +55</option>
                      </select>
                      <input type="tel" class="form-control" id="telefono" placeholder="3001234567" pattern="[0-9]*" />
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label text-muted" style="font-size: 0.85em;">Fecha de Nacimiento (opcional)</label>
                    <input type="date" class="form-control" id="fecha_nacimiento" />
                  </div>
                  
                  <div class="captcha-container">
                    <div class="captcha-question" id="captchaQuestion">Â¿CuÃ¡nto es 5 + 3?</div>
                    <input type="number" class="form-control captcha-input" id="captchaInput" placeholder="?" required />
                    <div class="text-center">
                      <button type="button" class="captcha-refresh" id="refreshCaptcha">ğŸ”„ Nuevo captcha</button>
                    </div>
                  </div>
                  
                  <div class="mt-4 text-center">
                    <button type="submit" id="registerButton" class="btn btn-primary mx-auto shadow-2xl">Registrar</button>
                  </div>
                </form> 
                <div class="flex justify-between items-end flex-wrap mt-4">
                  <h6 class="font-medium mb-0">Â¿Ya tienes una cuenta?</h6>
                  <a href="ingresoportal.html" class="text-primary-500">Ingresar</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <script src="/assets/js/plugins/simplebar.min.js"></script>
    <script src="/assets/js/plugins/popper.min.js"></script>
    <script src="/assets/js/icon/custom-icon.js"></script>
    <script src="/assets/js/plugins/feather.min.js"></script>
    <script src="/assets/js/component.js"></script>
    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/script.js"></script>
    <div class="floting-button fixed bottom-[50px] right-[30px] z-[1030]">
    </div>

    <script> layout_change('false'); </script>
    <script> layout_theme_sidebar_change('dark'); </script>
    <script> change_box_container('false'); </script>
    <script> layout_caption_change('true'); </script>
    <script> layout_rtl_change('false'); </script>
    <script> preset_change('preset-1'); </script>
    <script> main_layout_change('vertical'); </script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const registerForm = document.getElementById('registerForm');
        const registerButton = document.getElementById('registerButton');
        const messageContainer = document.getElementById('messageContainer');
        
        // --- LÃ“GICA DEL CAPTCHA AÃ‘ADIDA ---
        let captchaAnswer = 0;
        
        function generateCaptcha() {
          const num1 = Math.floor(Math.random() * 10) + 1;
          const num2 = Math.floor(Math.random() * 10) + 1;
          const operations = ['+', '-', 'Ã—'];
          const operation = operations[Math.floor(Math.random() * operations.length)];
          
          let question = '';
          switch(operation) {
            case '+':
              captchaAnswer = num1 + num2;
              question = `Â¿CuÃ¡nto es ${num1} + ${num2}?`;
              break;
            case '-':
              // Asegurar resultado positivo para simpleza
              const n1 = Math.max(num1, num2);
              const n2 = Math.min(num1, num2);
              captchaAnswer = n1 - n2;
              question = `Â¿CuÃ¡nto es ${n1} - ${n2}?`;
              break;
            case 'Ã—':
              captchaAnswer = num1 * num2;
              question = `Â¿CuÃ¡nto es ${num1} Ã— ${num2}?`;
              break;
          }
          
          document.getElementById('captchaQuestion').textContent = question;
          document.getElementById('captchaInput').value = '';
        }
        
        generateCaptcha();
        
        document.getElementById('refreshCaptcha').addEventListener('click', function() {
          generateCaptcha();
        });
        // --- FIN LÃ“GICA CAPTCHA ---


        registerForm.addEventListener('submit', async function(event) {
          event.preventDefault();
          messageContainer.innerHTML = '';
          registerButton.disabled = true;
          registerButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Registrando...';

          // --- VALIDACIÃ“N CAPTCHA AÃ‘ADIDA ---
          const captchaInput = parseInt(document.getElementById('captchaInput').value);
          if (captchaInput !== captchaAnswer) {
            showMessage('âŒ Captcha incorrecto. Por favor intenta de nuevo.', 'danger');
            generateCaptcha(); // Generar nuevo captcha
            registerButton.disabled = false;
            registerButton.textContent = 'Registrar';
            return;
          }
          
          const nombre = document.getElementById('nombre').value.trim();
          const email = document.getElementById('email').value.trim();
          const password = document.getElementById('password').value;
          const password_confirm = document.getElementById('password_confirm').value;
          
          const country_code = document.getElementById('country_code').value;
          const telefono = document.getElementById('telefono').value.trim();
          const fecha_nacimiento = document.getElementById('fecha_nacimiento').value;
          // --- 'snapchat' ELIMINADO ---

          // --- ValidaciÃ³n del lado del cliente ---
          if (!nombre || !email || !password || !password_confirm) {
            showMessage('Todos los campos son obligatorios.', 'danger');
            registerButton.disabled = false;
            registerButton.textContent = 'Registrar';
            generateCaptcha();
            return;
          }

          if (password.length < 6) {
            // CODIFICACIÃ“N CORREGIDA
            showMessage('La contraseÃ±a debe tener al menos 6 caracteres.', 'danger');
            registerButton.disabled = false;
            registerButton.textContent = 'Registrar';
            generateCaptcha();
            return;
          }

          if (password !== password_confirm) {
            // CODIFICACIÃ“N CORREGIDA
            showMessage('Las contraseÃ±as no coinciden.', 'danger');
            registerButton.disabled = false;
            registerButton.textContent = 'Registrar';
            generateCaptcha();
            return;
          }

          // Datos a enviar (deben coincidir con el backend auth.py)
          const registerData = { 
            nombre: nombre, 
            email: email, 
            password: password, 
            password_confirm: password_confirm 
          };
          
          // Agregar campos opcionales solo si tienen valor
          if (telefono) {
            registerData.telefono = country_code + telefono;
          }
          if (fecha_nacimiento) {
            registerData.fecha_nacimiento = fecha_nacimiento;
          }
          // --- 'snapchat' ELIMINADO DE registerData ---

          try {
            console.log('ğŸ”‘ Intentando registro...');
            
            const response = await fetch('/api/register', { 
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(registerData),
            });

            console.log('ğŸ“¡ Respuesta registro:', response.status);
            const result = await response.json();
            console.log('ğŸ“¦ Resultado:', result);

            if (response.ok) { // Esperando un 201 (Created)
              // CODIFICACIÃ“N CORREGIDA
              showMessage(result.message || 'Registro exitoso. SerÃ¡s redirigido al login.', 'success');
              setTimeout(() => {
                window.location.href = 'ingresoportal.html'; 
              }, 2000);
            } else {
              // Manejar errores (ej. 409: email ya existe)
              showMessage(result.error || 'Error en el registro. IntÃ©ntalo de nuevo.', 'danger');
              registerButton.disabled = false;
              registerButton.textContent = 'Registrar';
              generateCaptcha();
            }
          } catch (error) {
            console.error('âŒ Error en registro:', error);
            // CODIFICACIÃ“N CORREGIDA
            showMessage('No se pudo conectar con el servidor. IntÃ©ntalo mÃ¡s tarde.', 'danger');
            registerButton.disabled = false;
            registerButton.textContent = 'Registrar';
            generateCaptcha();
          }
        });

        function showMessage(message, type) {
          messageContainer.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
        }
      });
    </script>
    </body>
  </html>